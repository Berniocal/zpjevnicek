<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=yes">
<title>Píseň</title>

<link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zpjěvníček" />

<script defer src="https://unpkg.com/@coderline/alphatab@latest/dist/alphaTab.min.js"></script>
<style>
  html, body { margin:0; }
  :root{
    --cpfs: calc(20px * var(--song-scale, 1));
    --chromeH:0px;
    --chordColor:#22c55e;   /* výchozí barva akordů */
    --chordScale:1.05;      /* výchozí měřítko akordů vůči textu */
    --cp-line:1.25;
    --cp-pad:1.05em;
    --cp-pad-nochords:0.2em;

    /* >>> OKRAJE TEXTU PÍSNĚ <<< */
    --song-pad-top: 15px;
    --song-pad-bottom: 24px;
    --song-pad-x: 6px;
    --song-pad-right: 6px;

    --scrollbarW: 3px;
        --col-count: 1;
    --col-gap: 14px; /* mezera mezi sloupci */
    --ink:#e6eef8; 
    --card:#0f1722;

  }

  /* ChordPro */
  .cp{ font-family:system-ui,Segoe UI,Arial,sans-serif; color:var(--ink); font-size:var(--cpfs); line-height:var(--cp-line); }
  .cp .line{ position:relative; white-space:normal; overflow:visible; word-break:keep-all; overflow-wrap:normal; }
  .cp .seg{ position:relative; display:inline-block; padding-top:var(--cp-pad) }
  .cp .ch{ position:absolute; left:0; top:0; font-weight:700; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:calc(1em * var(--chordScale)); color:var(--chordColor); }
  .cp .ly{ visibility:visible; display:inline-block; white-space:pre-wrap; }
  .cp.nochords .ch{ display:none } .cp.nochords .seg{ padding-top:var(--cp-pad-nochords) }
  /* když jsou akordy skryté, úplně smaž “prázdné držáky akordů”, aby nevznikaly mezery v textu */
.cp.nochords .ch-only{ display:none; }


  .sheet{ padding:0; background:transparent; border:none; box-shadow:none; }

  #chrome{ position:fixed; top:0; left:0; right:0; z-index:5; background:var(--card);
    padding:12px 12px 8px; border-bottom:1px solid #192544; transition: transform .2s ease, opacity .2s ease; }
  body.chrome-hidden #chrome{ transform: translateY(-110%); opacity:0; height:0; padding:0; margin:0; border:0; overflow:hidden; }

  #view .cp{
    column-count: var(--col-count);
    column-gap: var(--col-gap);
  }

  /* ať se jeden řádek neroztrhne mezi sloupce */
  #view .cp .line{
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    page-break-inside: avoid;
  }
#view{
  height:100vh; max-height:100vh; overflow:auto; background:transparent; border:0; border-radius:0; box-shadow:none;
  /*             TOP                         RIGHT (nově)                         BOTTOM                                  LEFT */
  padding: var(--song-pad-top)
           var(--song-pad-right, var(--song-pad-x))
           calc(var(--song-pad-bottom) + env(safe-area-inset-bottom, 0px) + 12px)
           var(--song-pad-x);
  scrollbar-width: thin; scrollbar-color:#2c3b60 transparent;

}

  #view::-webkit-scrollbar{ width:var(--scrollbarW); }
  #view::-webkit-scrollbar-track{ background:transparent; }
  #view::-webkit-scrollbar-thumb{ background:#2c3b60; border-radius:2px; }

  body:not(.chrome-hidden) #view{ padding-top: calc(var(--chromeH) + var(--song-pad-top)) !important; }
  body.chrome-hidden #view{ padding-top: max(env(safe-area-inset-top, 0px), var(--song-pad-top)) !important; }
  body.chrome-hidden .sheet{ margin-top:0 !important; padding-top:0 !important; }

  .chrome-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  button.ghost{ background:transparent; border:1px solid #2c3b60; border-radius:8px; padding:4px 8px; color:var(--ink); cursor:pointer; }
  button.ghost:hover{ background:#17213a; }

  .title-row{ display:flex; align-items:center; gap:8px; margin:8px 0; }
  #btnSettings{ background:transparent; border:1px solid #2c3b60; color:var(--ink); border-radius:8px; padding:4px 8px; cursor:pointer; }
  #btnSettings:hover{ background:#17213a; }

  /* „dropdown“ panel nastavení */
  #settingsPanel{
    position:absolute; right:12px; top:58px; z-index:6;
    background:var(--card); border:1px solid #223055; border-radius:10px; padding:10px 12px; box-shadow:0 10px 24px rgba(0,0,0,.35);
    display:none; min-width:300px;
  }
  #settingsPanel .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0; }
  #settingsPanel label{ color:var(--ink); font-size:14px; }
  #settingsPanel input[type="number"]{ width:100px; padding:4px 6px; border-radius:8px; border:1px solid #2c3b60; background:transparent; color:var(--ink); }
  #settingsPanel input[type="color"]{ width:40px; height:28px; padding:0; border:1px solid #2c3b60; border-radius:6px; background:transparent; }
  #settingsPanel .hint{ font-size:12px; color:#9fb0c7; margin-top:4px; }
  #settingsActions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
  #settingsSave{ border:1px solid #2c3b60; background:transparent; color:var(--ink); border-radius:8px; padding:6px 10px; cursor:pointer; }
  #settingsSave:hover{ background:#17213a; }

  .auto-scroll{
    position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px;
    background:transparent; border:2px solid #2c3b60; color:var(--ink); font-size:28px; line-height:1;
    display:flex; align-items:center; justify-content:center; z-index:10; opacity:.9; cursor:pointer;
  }
  .auto-scroll:hover{ opacity:1 } .auto-scroll:active{ transform:scale(.98) } .auto-scroll.hidden{ display:none }

  .container{ padding-right:0 !important; padding-left:0 !important; padding-top:0 !important; }

  /* Dialog sdílení */
  dialog{ border:1px solid #1f2b46; border-radius:12px; background:var(--card); color:var(--ink); }
  dialog::backdrop{ background:rgba(0,0,0,.4); }
</style>
</head>
<body>
  <script>
(function () {
  const PASSWORD = "hutisko"; // ← změň heslo
  const KEY = "zpevnik_access_granted";

  // Zabraň zobrazení obsahu, dokud se nerozhodne
  document.documentElement.style.display = "none";

  function deny() {
    document.documentElement.innerHTML = `
      <head><title>Přístup odepřen</title></head>
      <body style="font-family:sans-serif;text-align:center;padding:2rem">
        <h2>Přístup odepřen</h2>
        <p>Tento zpěvník je určen pouze pro uzavřenou skupinu.</p>
      </body>`;
    document.documentElement.style.display = "block";
    throw new Error("Access denied");
  }

  // už jednou ověřený přístup
  if (localStorage.getItem(KEY) === "yes") {
    document.documentElement.style.display = "block";
    return;
  }

  const entered = prompt("Zadej heslo pro přístup ke zpěvníčku:");

  if (entered === null || entered !== PASSWORD) {
    deny();
  }

  // správné heslo
  localStorage.setItem(KEY, "yes");
  document.documentElement.style.display = "block";
})();
</script>
  <div class="container">
    <div class="sheet">
      <div id="chrome">
<div class="chrome-row">
  <a id="backLink" href="#">← Zpět</a>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="btnShare" class="ghost" title="Sdílení ovládání (host / připojit se)">Sdílení</button>
    <button id="btnSettings" class="ghost" title="Nastavení posuvu a akordů">⚙️</button>
  </div>
</div>

<div class="title-row">
  <h2 id="title" style="margin:0">Načítám…</h2>
</div>

        <div class="badge" id="meta"></div>

        <!-- panel nastavení -->
        <div id="settingsPanel" role="dialog" aria-modal="false" aria-labelledby="settingsTitle">
          <div style="font-weight:600;margin-bottom:6px" id="settingsTitle">Nastavení</div>

          <div class="row">
            <label for="speedInput">Rychlost posuvu (px/s)</label>
            <input id="speedInput" type="number" min="5" max="300" step="1">
          </div>
          <div class="row">
            <label for="delayInput">Zpoždění startu (s)</label>
            <input id="delayInput" type="number" min="0" max="30" step="0.1">
          </div>

          <div class="row">
            <label for="chordColorInput">Barva akordů</label>
            <input id="chordColorInput" type="color">
          </div>
          <div class="row">
            <label for="chordScaleInput">Poměr velikosti akordů</label>
            <input id="chordScaleInput" type="number" min="0.5" max="2.5" step="0.05">
          </div>

          <div class="hint">Uložit uloží hodnoty do zařízení a ihned je použije.</div>
          <div id="settingsActions">
            <button id="settingsReset" type="button">Původní nastavení</button>
            <button id="settingsSave">Uložit</button>
          </div>
        </div>

        <div id="controls-score" class="player" style="display:none">
          <button id="play">Přehrát</button>
          <button id="stop">Stop</button>
          <label>Tempo <input id="tempo" type="range" min="30" max="200" value="100"></label>
        </div>

        <div id="controls-cp" class="player" style="display:none">
          <span class="kbd">Transponovat:
            <button id="down" type="button">−</button>
            <button id="up"   type="button">+</button>
          </span>
          <span class="kbd">Rolování:
            <button id="toggleAutoBtn" type="button" aria-label="Zobrazit/skrýt tlačítko autoposuvu">
              <span id="autoBtnIcon">✅</span>
            </button>
          </span>
          <span class="kbd">Velikost:
            <button id="fontDown" type="button">−</button>
            <button id="fontUp"   type="button">+</button>
          </span>
          <span class="kbd">Akordy:
            <button id="toggleChords" type="button" aria-label="Přepnout akordy">
              <span id="chordsIcon">✅</span>
            </button>
          </span>
          <span class="kbd">Sloupce:
  <button id="toggleCols" type="button" aria-label="Přepnout počet sloupců" aria-pressed="false">
    <span id="colsIcon">1</span>
  </button>
</span>

        </div>
      </div>

      <div id="view"></div>
    </div>
  </div>

  <!-- Dialog pro SDÍLENÍ (host/připojit) – stejné jako na hlavní stránce -->
  <dialog id="dlgShare">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
      <strong id="shareTitle">Sdílení</strong>
      <button id="dlgShareClose">Zavřít</button>
    </div>

    <div id="shareBody">
      <div style="display:grid;gap:10px">
        <label style="display:grid;gap:6px">Přezdívka
          <input id="shareNick" placeholder="Třeba Jenda" autocomplete="nickname" />
        </label>
        <label style="display:grid;gap:6px">Pětičíselný kód
          <input id="shareCode" inputmode="numeric" pattern="[0-9]*" placeholder="12345" maxlength="5" />
        </label>
        <button id="shareJoin" style="width:100%">Vytvořit / přihlásit</button>
        <div id="shareMsg" class="badge" style="display:none"></div>
      </div>

      <hr class="sep" />

      <div id="hostPanel" style="display:none">
        <div class="badge" style="margin-bottom:8px">Jsi <strong>hlavní</strong>. Příchozí žádosti musíš potvrdit.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
          <button id="hostStop">Zrušit sdílení (odpojit všechny)</button>
          <button id="hostRefresh">Obnovit seznam</button>
        </div>
        <div style="font-weight:600;margin:6px 0">Připojení</div>
        <ul id="hostMembers" style="list-style:none;margin:0;padding:0;max-height:50vh;overflow:auto"></ul>
      </div>

      <div id="clientPanel" style="display:none">
        <div id="clientState" class="badge" style="margin-bottom:10px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="clientPause">Pauznout</button>
          <button id="clientResume">Obnovit</button>
          <button id="clientLeave">Odpojit se</button>
        </div>
      </div>
    </div>
  </dialog>

<button id="autoScroll" class="auto-scroll" title="Auto posuv">∨</button>

<script>
const params = new URLSearchParams(location.search);
const id = params.get('id');
const plId = params.get('pl') || '';
const book = params.get('book') || '';

let song, SONGS_LIST=[], SONG_INDEX=-1;
let HIDE_CHORDS = localStorage.getItem('hideChords') === '1';
  let CP_TEXT = '';      // uložíme si původní ChordPro text pro re-render
let CP_TRANS = 0;      // aktuální transpozice pro re-render

let justSwipedTs = 0;
let CHROME_HIDDEN = localStorage.getItem('chromeHidden') === '1';
if (CHROME_HIDDEN) document.body.classList.add('chrome-hidden');

/* --- Klíče nastavení --- */
let AUTO_BTN_VISIBLE = localStorage.getItem('autoBtnVisible') !== '0';
const AUTO_SPEED_KEY='zpj_autoSpeed';
const AUTO_DELAY_KEY='zpj_autoDelay';
const CHORD_COLOR_KEY='zpj_chordColor';
const CHORD_SCALE_KEY='zpj_chordScale';
const DEF_AUTO_SPEED = 10;      // px/s
const DEF_AUTO_DELAY = 10;      // s
const DEF_CHORD_COLOR = '#22c55e';
const DEF_CHORD_SCALE = 1.05;

/* --- Defaulty (požadováno) --- */
let AUTO_SPEED = parseFloat(localStorage.getItem(AUTO_SPEED_KEY));
if (isNaN(AUTO_SPEED)) AUTO_SPEED = 10;   // px/s
let AUTO_DELAY = parseFloat(localStorage.getItem(AUTO_DELAY_KEY));
if (isNaN(AUTO_DELAY)) AUTO_DELAY = 10;   // s

let CHORD_COLOR = localStorage.getItem(CHORD_COLOR_KEY) || getComputedStyle(document.documentElement).getPropertyValue('--chordColor').trim() || '#22c55e';
let CHORD_SCALE = parseFloat(localStorage.getItem(CHORD_SCALE_KEY));
if (isNaN(CHORD_SCALE)) CHORD_SCALE = 1.05; // poměr

/* aplikuj barvu/scale hned na start */
document.documentElement.style.setProperty('--chordColor', CHORD_COLOR);
document.documentElement.style.setProperty('--chordScale', String(CHORD_SCALE));

/* --- Auto scroll --- */
let autoRunning = false;
let _autoRaf = 0, _lastTs = 0, _autoDelayTO = 0;

function getViewScrollState(){
  const view = document.getElementById('view');
  if (!view) return null;

  const max = Math.max((view.scrollHeight || 0) - (view.clientHeight || 0), 0);
  return {
    target: view,
    scrollTop: view.scrollTop || 0,
    max
  };
}

function setViewScrollTop(value){
  const view = document.getElementById('view');
  if (!view) return;
  view.scrollTop = value;
}

function updateAutoBtnVisibility(){
  const ico = document.getElementById('autoBtnIcon');
  const floater = document.getElementById('autoScroll');
  const toggle = document.getElementById('toggleAutoBtn');
  if (ico) ico.textContent = AUTO_BTN_VISIBLE ? '✅' : '❌';
 if (toggle) toggle.setAttribute('aria-pressed', AUTO_BTN_VISIBLE ? 'true' : 'false');
  if (floater){
    floater.classList.toggle('hidden', !AUTO_BTN_VISIBLE);
    floater.setAttribute('aria-hidden', AUTO_BTN_VISIBLE ? 'false' : 'true');
  }
}
async function waitForScrollableView(minMax = 20, timeoutMs = 1500){
  const t0 = performance.now();
  while (performance.now() - t0 < timeoutMs){
    // vynucení layoutu po reflow (sloupce + akordy)
    updateChromeHeight();
    relayoutChords();

    const s = getViewScrollState();
    if (s && s.max >= minMax) return s;

    // počkej 1 frame
    await new Promise(r => requestAnimationFrame(r));
  }
  return getViewScrollState(); // vrať co je, i kdyby bylo malé
}
  
function setAutoIcon(state){
  const btn = document.getElementById('autoScroll');
  if (!btn) return;
  if (state === 'running') btn.textContent = '■';
  else if (state === 'waiting') btn.textContent = '…';
  else btn.textContent = '∨';
}
function stopAutoScroll(){
  autoRunning = false;
  if(_autoRaf) cancelAnimationFrame(_autoRaf);
  _autoRaf = 0; _lastTs = 0;
  if(_autoDelayTO){ clearTimeout(_autoDelayTO); _autoDelayTO = 0; }
  setAutoIcon('idle');
}
function startAutoScroll(){
  if (autoRunning || _autoDelayTO) return;

  const begin = async () => {
    autoRunning = true;
    _lastTs = 0;
    setAutoIcon('running');
// počkej, až bude #view opravdu scrollovatelný (PC/tablet často dopočítává layout později)
await waitForScrollableView(20, 1500);

    const tick = (ts) => {
      if (!autoRunning) return;

      if (!_lastTs) _lastTs = ts;
      const dt = (ts - _lastTs) / 1000;
      _lastTs = ts;

const state = getViewScrollState();

// když ještě není dopočítaný layout (typicky PC/tablet po renderu),
// tak NEkonči, jen čekej další frame
if (!state || state.max <= 0){
  _autoRaf = requestAnimationFrame(tick);
  return;
}


 // když je max maličké (typicky ještě nedopočítaný layout), neukončuj, jen čekej
if (state.max < 20){
  _autoRaf = requestAnimationFrame(tick);
  return;
}

// konec – až když jsme opravdu na konci
if (state.scrollTop >= state.max - 2){
  stopAutoScroll();
  return;
}


const next = Math.min(state.max, state.scrollTop + AUTO_SPEED * dt);
setViewScrollTop(next);


      _autoRaf = requestAnimationFrame(tick);
    };

    _autoRaf = requestAnimationFrame(tick);
  };



if (AUTO_DELAY > 0){
  const btn = document.getElementById('autoScroll');
  let remaining = AUTO_DELAY;
  setAutoIcon('waiting');
  if (btn) btn.textContent = Math.ceil(remaining);

  const tickCountdown = () => {
    if (!_autoDelayTO) return;
    remaining -= 0.25;
    if (btn) btn.textContent = String(Math.max(0, Math.ceil(remaining)));
  };

  const iv = setInterval(tickCountdown, 250);

  _autoDelayTO = setTimeout(() => {
    clearInterval(iv);
    _autoDelayTO = 0;
    begin();
  }, AUTO_DELAY * 1000);

} else {
  begin();
}

}

function wireAutoScrollDesktopControls(){
  const view = document.getElementById('view');
  if (!view) return;

  // když uživatel scrolluje ručně (kolečko/trackpad), autoscroll zastav
  view.addEventListener('wheel', () => {
    if (autoRunning || _autoDelayTO) stopAutoScroll();
  }, { passive:true });

  // když uživatel začne tahat / scrollovat dotykem, autoscroll zastav
  view.addEventListener('touchstart', () => {
    if (autoRunning || _autoDelayTO) stopAutoScroll();
  }, { passive:true });

  // klik do textu (myš / touch) může taky autoscroll stopnout
  view.addEventListener('pointerdown', () => {
    if (autoRunning || _autoDelayTO) stopAutoScroll();
  }, { passive:true });

  // mezerník = start/stop (na PC fakt příjemné)
  window.addEventListener('keydown', (e) => {
    if (e.code !== 'Space') return;

    // když píšeš do inputu v panelu nastavení, neřeš
    const tag = (document.activeElement?.tagName || '').toLowerCase();
    if (tag === 'input' || tag === 'textarea') return;

    e.preventDefault();
    if (autoRunning || _autoDelayTO) stopAutoScroll();
    else startAutoScroll();
  });
}


/* --- CZ noty + transpozice --- */
const NOTES_CZ = ['C','C#','D','D#','E','F','F#','G','G#','A','B','H'];
const ALT = { 'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','A#':'B','Bb':'B','Hb':'B','Cb':'H','B#':'C','H#':'C','E#':'F','Fb':'E' };
function normRoot(r){ return ALT[r] || r; }
function transposeNote(n, semi){ const up=n.toUpperCase(); const norm=normRoot(up); const i=NOTES_CZ.indexOf(norm); if(i<0) return n; return NOTES_CZ[(i+semi+120)%12]; }
function transposeChord(token, semi){
  const m = token.match(/^([A-Ha-h](?:#|b)?)(.*?)(?:\/([A-Ha-h](?:#|b)?)(.*))?$/);
  if (!m) return token;
  const rootT = transposeNote(m[1], semi);
  const bassT = m[3] ? transposeNote(m[3], semi) : null;
  return rootT + (m[2]||'') + (bassT?('/'+bassT):'') + (m[4]||'');
}

/* --- Parser + render --- */
function parseChordPro(text){
  const meta = {}, raw = text.replace(/\r/g,'').split('\n');
  const body=[]; for(const line of raw){ const m=line.match(/^\{(\w+)\s*:\s*(.*?)\s*\}$/); if(m){ meta[m[1].toLowerCase()]=m[2]; continue; } body.push(line); }
  while(body.length && !body[0].trim()) body.shift();
  while(body.length && !body[body.length-1].trim()) body.pop();
  const lines=[]; let prevEmpty=false;
  for(const l of body){ const empty=!l.trim(); if(empty && prevEmpty) continue; lines.push(l); prevEmpty=empty; }
  return { meta, lines };
}
function renderChordPro(text, transposeSemi=0){
  const {lines} = parseChordPro(text);
  const cont=document.createElement('div'); cont.className='cp';
  for(const raw of lines){
    if(!raw.trim()){ cont.appendChild(document.createElement('br')); continue; }
    const line=document.createElement('div'); line.className='line';
    let i=0, pending=null;
    while(i<raw.length){
      if(raw[i]=='['){
        const close=raw.indexOf(']', i+1);
        if(close!==-1){
          const token=raw.slice(i+1, close); i=close+1;
if(i>=raw.length || raw[i]=='['){
  const seg=document.createElement('span'); 
  seg.className='seg ch-only'; // <<< důležité
  const ch=document.createElement('span'); 
  ch.className='ch'; 
  ch.textContent=transposeChord(token, transposeSemi);

  const ly=document.createElement('span'); 
  ly.className='ly'; 
  ly.textContent='\u00A0'; // šířka pro akord (NBSP), ale při nochords seg zmizí

  seg.appendChild(ch); 
  seg.appendChild(ly); 
  line.appendChild(seg); 
  pending=null; 
  continue;
}

          else{ pending=token; continue; }
        }
      }
      let j=i; while(j<raw.length && raw[j]!='[') j++;
      const lyr = raw.slice(i, j);
      // když je pending akord a mezi ním a dalším tokenem není žádný text,
// vytvoříme držák akordu, který při skrytí akordů úplně zmizí
if (pending && lyr === '') {
  const seg=document.createElement('span');
  seg.className='seg ch-only';
  const ch=document.createElement('span'); ch.className='ch'; ch.textContent=transposeChord(pending, transposeSemi);
  const ly=document.createElement('span'); ly.className='ly'; ly.textContent='\u00A0';
  seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg);
  pending=null; i=j;
  continue;
}

      const seg=document.createElement('span'); seg.className='seg';
      const ch=document.createElement('span'); ch.className='ch'; ch.textContent=pending?transposeChord(pending, transposeSemi):'';
      const ly=document.createElement('span'); ly.className='ly'; ly.textContent=lyr;
      seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg); pending=null; i=j;
    }
if(pending){
  const seg=document.createElement('span'); 
  seg.className='seg ch-only';
  const ch=document.createElement('span'); 
  ch.className='ch'; 
  ch.textContent=transposeChord(pending, transposeSemi);

  const ly=document.createElement('span'); 
  ly.className='ly'; 
  ly.textContent='\u00A0';

  seg.appendChild(ch); 
  seg.appendChild(ly); 
  line.appendChild(seg);
}

    
    cont.appendChild(line);
  }
  return cont;
}
function renderChordProPlain(text){
  const { lines } = parseChordPro(text);
  const cont = document.createElement('div');
  cont.className = 'cp nochords'; // nochords kvůli CSS (padding apod.)

  for (const raw of lines){
    if(!raw.trim()){
      cont.appendChild(document.createElement('br'));
      continue;
    }

    // Odstraň akordy [C], [Am7/G] apod. a nech jen text
    const plain = raw.replace(/\[[^\]]*\]/g, '');

    const line = document.createElement('div');
    line.className = 'line';

    // Tady už je to jeden textový uzel => slova se nikdy nerozseknou “zatáčk y”
    line.textContent = plain;

    cont.appendChild(line);
  }
  return cont;
}

  
const MIN_CHORD_GAP=4;
function fixChordOverlaps(root){
  const lines=root.querySelectorAll('.line');
  lines.forEach(line=>{
    line.querySelectorAll('.seg').forEach(seg=>{ seg.style.marginLeft=''; });
    let prevRight=-Infinity, lastTop=null;
    const chords=Array.from(line.querySelectorAll('.ch'));
    chords.forEach(ch=>{
      const seg=ch.parentElement, r=ch.getBoundingClientRect();
      if(lastTop!==null && (r.top-lastTop)>0.5){ prevRight=-Infinity; }
      lastTop=r.top;
      const needLeft=prevRight+MIN_CHORD_GAP, need=needLeft-r.left;
      if(need>0){ const cur=parseFloat(seg.style.marginLeft||'0'); seg.style.marginLeft=(cur+need)+'px'; const nr=ch.getBoundingClientRect(); prevRight=nr.right; }
      else { prevRight=r.right; }
    });
    const segs=Array.from(line.querySelectorAll('.seg'));
    if(segs.length){
      const rects=segs.map(s=>s.getBoundingClientRect());
      const firstLeft=Math.min(...rects.map(r=>r.left));
      const firstTop=Math.min(...rects.map(r=>r.top));
      const LEFT_TOL=16, TOP_TOL=0.5;
      segs.forEach((seg,i)=>{ const r=rects[i]; const startsNew=(r.top-firstTop)>TOP_TOL && (r.left-firstLeft)<LEFT_TOL; if(startsNew) seg.style.marginLeft='0px'; });
    }
  });
}

/* --- Layout helpers --- */
function relayoutChords(){ const cp=document.querySelector('#view .cp'); if(!cp) return; requestAnimationFrame(()=>fixChordOverlaps(cp)); }
function updateChromeHeight(){ const ch=document.getElementById('chrome'); const h=ch?ch.getBoundingClientRect().height:0; document.documentElement.style.setProperty('--chromeH',(h||0)+'px'); }
function setChromeHidden(h){ CHROME_HIDDEN=!!h; document.body.classList.toggle('chrome-hidden', CHROME_HIDDEN); localStorage.setItem('chromeHidden', CHROME_HIDDEN?'1':'0'); updateChromeHeight(); }

/* --- ovládání lišty + swipe --- */
function wireDoubleToggle(){
  const view=document.getElementById('view'); if(!view) return;
  let lastTapTime=0,lastX=0,lastY=0,recentToggleTs=0;
  view.addEventListener('dblclick', ()=>{ if(Date.now()-recentToggleTs<400) return; if(Date.now()-justSwipedTs<350) return; setChromeHidden(!document.body.classList.contains('chrome-hidden')); });
  view.addEventListener('touchend', (e)=>{
    if(e.touches&&e.touches.length) return;
    if(Date.now()-justSwipedTs<350) return;
    const t=Date.now(), touch=e.changedTouches[0], x=touch.clientX, y=touch.clientY;
    const withinTime = (t-lastTapTime)<300;
    const withinDist = Math.hypot(x-lastX,y-lastY)<30;
    if(withinTime && withinDist){ e.preventDefault(); setChromeHidden(!document.body.classList.contains('chrome-hidden')); recentToggleTs=t; lastTapTime=0; }
    else { lastTapTime=t; lastX=x; lastY=y; }
  }, {passive:false});
}
function wireSwipeNavigation(){
  const view = document.getElementById('view');
  if (!view) return;

  let sx = 0;
  let sy = 0;
  let t0 = 0;

  view.addEventListener('touchstart', (e)=>{
    if (e.touches.length !== 1) return;
    const t = e.touches[0];
    sx = t.clientX;
    sy = t.clientY;
    t0 = Date.now();
  }, { passive:true });

  view.addEventListener('touchend', (e)=>{
    const t = e.changedTouches[0];
    if (!t) return;

    const dx = t.clientX - sx;
    const dy = t.clientY - sy;
    const dt = Date.now() - t0;

    // jasné, krátké, horizontální gesto
    if (
      Math.abs(dx) > 80 &&
      Math.abs(dy) < 60 &&
      dt < 600
    ){
      if (dx < 0) goNextSong();
      else goPrevSong();
    }
  }, { passive:true });
}


function goNextSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const next=(SONG_INDEX+1)%SONGS_LIST.length;
  const nxtId = SONGS_LIST[next];
 const extra = (plId ? `&pl=${encodeURIComponent(plId)}` : '') +
              (book ? `&book=${encodeURIComponent(book)}` : '');
  location.replace(`song.html?id=${encodeURIComponent(nxtId)}${extra}`);
}
function goPrevSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const prev=(SONG_INDEX-1+SONGS_LIST.length)%SONGS_LIST.length;
  const prvId = SONGS_LIST[prev];
 const extra = (plId ? `&pl=${encodeURIComponent(plId)}` : '') +
              (book ? `&book=${encodeURIComponent(book)}` : '');

  location.replace(`song.html?id=${encodeURIComponent(prvId)}${extra}`);
}

/* --- velikost textu napříč PWA --- */
const ZPJ_FONT_KEY = 'zpj-fontScale';

  function getScale(){
  const s = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--song-scale')) || 1;
  return s > 0 ? s : 1;
}
function setScale(s){
  const c = Math.min(3, Math.max(0.5, s));
  document.documentElement.style.setProperty('--song-scale', String(c));
  localStorage.setItem(ZPJ_FONT_KEY, String(c));
  relayoutChords();
}
/* --- sloupce (bez přepočtu velikosti) --- */
const ZPJ_COLS_KEY = 'zpj-cols'; // "1" nebo "2"
let COLS = parseInt(localStorage.getItem(ZPJ_COLS_KEY) || '1', 10);
if (![1,2].includes(COLS)) COLS = 1;

function updateColsIcon(){
  const ico = document.getElementById('colsIcon');
  const btn = document.getElementById('toggleCols');
  if (ico) ico.textContent = String(COLS);
  if (btn) btn.setAttribute('aria-pressed', COLS === 2 ? 'true' : 'false');
}

function applyColumns(){
  document.documentElement.style.setProperty('--col-count', String(COLS));
  updateColsIcon();
  relayoutChords();
}

async function load(){
  // 1) Načti seznam písní
  const data = await fetch('/zpjevnicek/data/songs.json', { cache:'no-store' })
                      .then(r=>r.json()).catch(()=>[]);

  // 2) Sestav pořadí pro swipe:
  //    - když je plId => pořadí z playlistu
  //    - jinak když je book => jen písně ze zvoleného zpěvníku, seřazené podle čísla ve zpěvníku
  //    - jinak všechny písně v pořadí z JSONu
  if (plId){
    const pls = JSON.parse(localStorage.getItem('zpj_playlists')||'[]');
    const pl = pls.find(p=>p.id===plId);
    SONGS_LIST = (pl && Array.isArray(pl.items) && pl.items.length)
      ? pl.items.slice()
      : data.map(s=>s.id);
  } else if (book){
    const filtered = data
      .filter(s => s.books && Object.prototype.hasOwnProperty.call(s.books, book))
      .sort((a,b) => (a.books?.[book] ?? 1e9) - (b.books?.[book] ?? 1e9));
    SONGS_LIST = filtered.map(s=>s.id);
    // pro návrat na index nech vybraný zpěvník i tam
    localStorage.setItem('zpj_book', book);
  } else {
    SONGS_LIST = data.map(s=>s.id);
  }
  SONG_INDEX = SONGS_LIST.indexOf(id);

  // 3) Najdi právě otevřenou píseň
  song = data.find(s=>s.id===id);
  if(!song){
    document.getElementById('title').textContent='Píseň nenalezena';
    return;
  }
  document.getElementById('title').textContent = `${song.number ?? '–'} · ${song.title}`;
  document.getElementById('meta').textContent = song.author || '';

  // 4) Zpět odkaz (playlist / zpěvník / hlavní seznam)
  const backLink = document.getElementById('backLink');
  if (plId){
    backLink.textContent = '← Zpět na playlist';
    backLink.onclick = (e)=>{ e.preventDefault(); location.href = '/zpjevnicek/index.html#pl:' + encodeURIComponent(plId); };
  } else if (book){
    backLink.textContent = '← Zpět na zpěvník';
    backLink.onclick = (e)=>{ e.preventDefault(); location.href = '/zpjevnicek/'; };
  } else {
    backLink.textContent = '← Zpět na seznam';
    backLink.onclick = (e)=>{ e.preventDefault(); if (document.referrer.includes('/zpjevnicek/')) history.back(); else location.href='/zpjevnicek/'; };
  }

  // 5) Render: ChordPro vs. AlphaTab
  if (song.type === 'chordpro' || /\.pro$|\.cho$/i.test(song.file)) {
    document.getElementById('controls-cp').style.display='flex';
    const text = await fetch(song.file).then(r=>r.text());
CP_TEXT = text;
let trans = 0;
CP_TRANS = 0;

const render = ()=>{
  CP_TRANS = trans; // uložit pro případné re-render při vypnutí akordů
  const view = document.getElementById('view');

  // Když jsou akordy skryté: renderuj čistý text bez segmentů => žádné “zatáčk y”
  if (HIDE_CHORDS){
    const el = renderChordProPlain(text);
    view.innerHTML = '';
    view.appendChild(el);
    applyChordVisibility();
    updateChromeHeight();
    requestAnimationFrame(()=>{ /* jen aby se layout dosadil */ });
    return;
  }

  // Akordy zapnuté: klasický render se segmenty + vyrovnání
  const el = renderChordPro(text, trans);
  view.innerHTML='';
  view.appendChild(el);
  requestAnimationFrame(()=>fixChordOverlaps(el));
  applyChordVisibility();
  updateChromeHeight();
};

render();

document.getElementById('up').onclick   = ()=>{ trans += 1; render(); };
document.getElementById('down').onclick = ()=>{ trans -= 1; render(); };


    let scale = getScale();
    document.getElementById('fontUp').onclick   = ()=>{ scale = Math.min(3,   +(scale + 0.1).toFixed(2)); setScale(scale); };
    document.getElementById('fontDown').onclick = ()=>{ scale = Math.max(0.5, +(scale - 0.1).toFixed(2)); setScale(scale); };

document.getElementById('toggleChords').onclick = ()=>{
  HIDE_CHORDS = !HIDE_CHORDS;
  localStorage.setItem('hideChords', HIDE_CHORDS ? '1' : '0');

  // re-render podle stavu (plain vs segmenty)
  const view = document.getElementById('view');
  if (HIDE_CHORDS){
    view.innerHTML = '';
    view.appendChild(renderChordProPlain(CP_TEXT));
    applyChordVisibility();
    updateChromeHeight();
  } else {
    view.innerHTML = '';
    const el = renderChordPro(CP_TEXT, CP_TRANS);
    view.appendChild(el);
    requestAnimationFrame(()=>fixChordOverlaps(el));
    applyChordVisibility();
    updateChromeHeight();
  }
};

  } else {
    document.getElementById('controls-score').style.display='flex';
    const el=document.getElementById('view');
    const at=new alphaTab.AlphaTabApi(el, { file:song.file, player:{ enablePlayer:true }});
    document.getElementById('play').onclick = ()=> at.playPause();
    document.getElementById('stop').onclick = ()=> at.stop();
    document.getElementById('tempo').oninput = e=> at.playbackSpeed = e.target.value/100;
    at.renderFinished.on(()=> updateChromeHeight());
  }

  // 6) Auto-scroll: tlačítko + ikony
  const tgl = document.getElementById('toggleAutoBtn');
  if (tgl) tgl.onclick = ()=>{
    AUTO_BTN_VISIBLE = !AUTO_BTN_VISIBLE;
    localStorage.setItem('autoBtnVisible', AUTO_BTN_VISIBLE ? '1' : '0');
    if (!AUTO_BTN_VISIBLE && (autoRunning || _autoDelayTO)) stopAutoScroll();
    updateAutoBtnVisibility();
  };
  const autoBtn=document.getElementById('autoScroll');
  if (autoBtn) autoBtn.onclick=()=>{ if (autoRunning || _autoDelayTO) stopAutoScroll(); else startAutoScroll(); };
  updateAutoBtnVisibility();
  setAutoIcon('idle');

  
  // 6.5) Sloupce 1/2
  const colsBtn = document.getElementById('toggleCols');
  if (colsBtn) colsBtn.onclick = ()=>{
    COLS = (COLS === 1) ? 2 : 1;
    localStorage.setItem(ZPJ_COLS_KEY, String(COLS));
    applyColumns();
  };
  applyColumns();


  // 7) Panel nastavení – předvyplň + ulož/reset
  const btnSettings = document.getElementById('btnSettings');
  const panel = document.getElementById('settingsPanel');
  const speedInput = document.getElementById('speedInput');
  const delayInput = document.getElementById('delayInput');
  const chordColorInput = document.getElementById('chordColorInput');
  const chordScaleInput = document.getElementById('chordScaleInput');
  if (speedInput) speedInput.value = String(AUTO_SPEED);
  if (delayInput) delayInput.value = String(AUTO_DELAY);
  if (chordColorInput) chordColorInput.value = CHORD_COLOR;
  if (chordScaleInput) chordScaleInput.value = String(CHORD_SCALE);

  if (btnSettings && panel){
    btnSettings.addEventListener('click', ()=>{
      panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    });
    document.addEventListener('click', (e)=>{
      if (!panel.contains(e.target) && e.target !== btnSettings){
        panel.style.display = 'none';
      }
    });
  }

  document.getElementById('settingsSave')?.addEventListener('click', ()=>{
    const sp = Math.max(5, Math.min(300, Number(speedInput.value)||10));
    AUTO_SPEED = sp; localStorage.setItem(AUTO_SPEED_KEY, String(sp));

    const dl = Math.max(0, Math.min(30, Number(delayInput.value)||10));
    AUTO_DELAY = dl; localStorage.setItem(AUTO_DELAY_KEY, String(dl));

    const col = chordColorInput.value || '#22c55e';
    CHORD_COLOR = col;
    document.documentElement.style.setProperty('--chordColor', col);
    localStorage.setItem(CHORD_COLOR_KEY, col);

    let scl = parseFloat(chordScaleInput.value);
    if (isNaN(scl)) scl = 1.05;
    scl = Math.max(0.5, Math.min(2.5, scl));
    CHORD_SCALE = scl;
    document.documentElement.style.setProperty('--chordScale', String(scl));
    localStorage.setItem(CHORD_SCALE_KEY, String(scl));

    relayoutChords();
    panel.style.display = 'none';
  });

  document.getElementById('settingsReset')?.addEventListener('click', () => {
    if (speedInput)       speedInput.value       = String(DEF_AUTO_SPEED);
    if (delayInput)       delayInput.value       = String(DEF_AUTO_DELAY);
    if (chordColorInput)  chordColorInput.value  = DEF_CHORD_COLOR;
    if (chordScaleInput)  chordScaleInput.value  = String(DEF_CHORD_SCALE);

    AUTO_SPEED = DEF_AUTO_SPEED;
    localStorage.setItem(AUTO_SPEED_KEY, String(DEF_AUTO_SPEED));

    AUTO_DELAY = DEF_AUTO_DELAY;
    localStorage.setItem(AUTO_DELAY_KEY, String(DEF_AUTO_DELAY));

    CHORD_COLOR = DEF_CHORD_COLOR;
    document.documentElement.style.setProperty('--chordColor', DEF_CHORD_COLOR);
    localStorage.setItem(CHORD_COLOR_KEY, DEF_CHORD_COLOR);

    CHORD_SCALE = DEF_CHORD_SCALE;
    document.documentElement.style.setProperty('--chordScale', String(DEF_CHORD_SCALE));
    localStorage.setItem(CHORD_SCALE_KEY, String(DEF_CHORD_SCALE));

    relayoutChords();
    panel.style.display = 'none';
  });

  // 8) Ostatní drátování
try { wireDoubleToggle(); } catch(e){ console.warn('wireDoubleToggle failed', e); }
try { wireSwipeNavigation(); } catch(e){ console.warn('wireSwipeNavigation failed', e); }
wireAutoScrollDesktopControls();
updateChromeHeight();

}


function applyChordVisibility(){
  const cp=document.querySelector('#view .cp'); if(!cp) return;
  if (HIDE_CHORDS) cp.classList.add('nochords'); else cp.classList.remove('nochords');
  const ico=document.getElementById('chordsIcon'); if(ico) ico.textContent = HIDE_CHORDS ? '❌' : '✅';
}

/* --- resize/orientation --- */
let _resizeTO;
function onResizeReflow(){
  updateChromeHeight();
  relayoutChords();
}

window.addEventListener('resize', ()=>{ clearTimeout(_resizeTO); _resizeTO=setTimeout(onResizeReflow,120); });
window.addEventListener('orientationchange', ()=>{ setTimeout(onResizeReflow,150); });

/* --- SW --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' })
      .then(r => console.log('Zpjěvníček SW scope:', r.scope))
      .catch(console.error);
  });
}

/* --- globální scale --- */
(function applyGlobalSongScale(){
  const val = parseFloat(localStorage.getItem('zpj-fontScale'));
  if (!isNaN(val) && val > 0) document.documentElement.style.setProperty('--song-scale', String(val));
})();

/* --- HW tlačítko zpět --- */
window.addEventListener('popstate', (e) => {
  e.preventDefault();
  const backLink = document.getElementById('backLink');
  if (backLink) backLink.click();
  else location.href = plId ? '/zpjevnicek/index.html#pl:' + encodeURIComponent(plId) : '/zpjevnicek/';
});

load();
</script>

<!-- ======================== SDÍLENÍ OVÁDÁNÍ (Firebase) ========================
  Stejná logika jako v index.html. Doplň FIREBASE_CONFIG buď globálně do window.FIREBASE_CONFIG,
  nebo přímo v tomto souboru (viz níže).
============================================================================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
    collection, query, orderBy, serverTimestamp, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
  apiKey: "AIzaSyCwukp1IylOurKvEsKc7uCnyUJLoCtWI2o",
  authDomain: "zpjevnicek.firebaseapp.com",
  projectId: "zpjevnicek",
  storageBucket: "zpjevnicek.firebasestorage.app",
  messagingSenderId: "842022440214",
  appId: "1:842022440214:web:0dbddb0a435c3cd9705437",
  measurementId: "G-HJ5NNLMJKR"
};

  const HAS_CONFIG = !!(FIREBASE_CONFIG && FIREBASE_CONFIG.projectId);

  const btnShare = document.getElementById('btnShare');
  const dlgShare = document.getElementById('dlgShare');
  const dlgShareClose = document.getElementById('dlgShareClose');
  const shareJoin = document.getElementById('shareJoin');
  const shareNick = document.getElementById('shareNick');
  const shareCode = document.getElementById('shareCode');
  const shareMsg  = document.getElementById('shareMsg');
  const hostPanel = document.getElementById('hostPanel');
  const hostMembers = document.getElementById('hostMembers');
  const hostStop = document.getElementById('hostStop');
  const hostRefresh = document.getElementById('hostRefresh');
  const clientPanel = document.getElementById('clientPanel');
  const clientState = document.getElementById('clientState');
  const clientPause = document.getElementById('clientPause');
  const clientResume = document.getElementById('clientResume');
  const clientLeave = document.getElementById('clientLeave');

  const UID_KEY = 'zpj_share_uid';
  const SESSION_KEY = 'zpj_share_session';
  const uid = (localStorage.getItem(UID_KEY) || (()=>{
    const v = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(UID_KEY, v); return v;
  })());

  function normCode(x){
    const s = String(x||'').replace(/\D/g,'').slice(0,5);
    return s.length === 5 ? s : '';
  }
  function setMsg(text, kind='info'){
    if (!text){ shareMsg.style.display='none'; shareMsg.textContent=''; return; }
    shareMsg.style.display='inline-flex';
    shareMsg.textContent = text;
    shareMsg.style.borderColor = (kind==='err') ? '#7f1d1d' : '#273142';
    shareMsg.style.background  = (kind==='err') ? '#2b1b1b' : 'transparent';
  }

  function paintShare(state){
    btnShare.style.background = 'transparent';
    btnShare.style.borderColor = '#2c3b60';
    btnShare.style.color = 'var(--ink)';
    if (state === 'host') {
      btnShare.style.background = '#123b1f';
      btnShare.style.borderColor = '#22c55e';
    } else if (state === 'client') {
      btnShare.style.background = '#2a1a3d';
      btnShare.style.borderColor = '#a855f7';
    } else if (state === 'paused') {
      btnShare.style.background = '#3a2a12';
      btnShare.style.borderColor = '#f59e0b';
    }
  }

  let app, db;
  if (HAS_CONFIG){ app = initializeApp(FIREBASE_CONFIG); db = getFirestore(app); }

let unsubSession=null, unsubMembers=null, unsubMe=null, unsubNav=null, heartbeatTimer=null;
function cleanupSubs(){
  if (unsubSession) try{unsubSession();}catch(_){ }
  if (unsubMembers) try{unsubMembers();}catch(_){ }
  if (unsubMe) try{unsubMe();}catch(_){ }
  if (unsubNav) try{unsubNav();}catch(_){ }
  unsubSession = unsubMembers = unsubMe = unsubNav = null;
  if (heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer=null; }
}

  }
  function getLocalSession(){ try{ return JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); }catch(_){ return null; } }
function applySessionUI(){
  const local = getLocalSession();

  // default barva
  paintShare('');

  // nic v localStorage -> nech přihlášení viditelné
  if (!local?.code) return;

  // zabarvi tlačítko podle role (host/client)
  paintShare(local.role === 'host' ? 'host' : 'client');

  // v dialogu schovej join a zamkni inputy, protože už jsi připojený
  if (shareCode) { shareCode.value = local.code; shareCode.disabled = true; }
  if (shareNick) { shareNick.disabled = true; }
  if (shareJoin) { shareJoin.style.display = 'none'; }
}

  function setLocalSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
  function clearLocalSession(){ localStorage.removeItem(SESSION_KEY); }
  function sessionDoc(code){ return doc(db, 'zpevnikShare', code); }
  function memberDoc(code, memberUid){ return doc(db, 'zpevnikShare', code, 'members', memberUid); }

  async function touch(code, gen, role){
    const exp = new Date(Date.now() + 60*60*1000);
    try{ await updateDoc(sessionDoc(code), { lastActive: serverTimestamp(), expiresAt: exp, generation: gen }); }catch(_){ }
    try{ await updateDoc(memberDoc(code, uid), { lastSeen: serverTimestamp(), generation: gen, role }); }catch(_){ }
  }
  function startHeartbeat(code, gen, role){
    if (heartbeatTimer) clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(()=>touch(code, gen, role), 25*1000);
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }
  function isInternalZpjevnicekLink(href){
  if (!href) return false;
  if (href.startsWith('#')) return false;
  if (href.startsWith('mailto:') || href.startsWith('tel:')) return false;
  if (href.includes('://') && !href.startsWith(location.origin)) return false;
  return href.includes('/zpjevnicek/');
}

function canonicalPath(href){
  try{
    const u = new URL(href, location.origin);
    return u.pathname + u.search + u.hash;
  }catch(_){
    return href || '';
  }
}
function herePath(){
  return location.pathname + location.search + location.hash;
}


  function renderHostMembers(code, gen){
    hostMembers.innerHTML = '<li class="badge" style="opacity:.8">Načítám…</li>';
    const qMembers = query(collection(db, 'zpevnikShare', code, 'members'), orderBy('joinedAt','asc'));
    if (unsubMembers) try{unsubMembers();}catch(_){ }
    unsubMembers = onSnapshot(qMembers, (snap)=>{
      const items=[];
      snap.forEach(d=>{ const m=d.data()||{}; if (m.generation!==gen) return; items.push({id:d.id,...m}); });
      hostMembers.innerHTML = items.map(m=>{
        const nick=(m.nick||m.id); const st=(m.status||'').toUpperCase();
        const isMe=(m.id===uid); const isHost=(m.role==='host');
        const badge=isHost?'HOST':st;
        const canAccept=(!isHost && m.status==='pending');
        const canKick=(!isHost && m.status!=='pending');
        return `
          <li style="display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid #1f2b46">
            <div style="flex:1;min-width:0">
              <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(nick)}${isMe?' <span class=\"badge\" style=\"margin-left:6px\">TY</span>':''}</div>
              <small class="badge" style="opacity:.85">${escapeHtml(badge)}</small>
            </div>
            ${canAccept ? `
              <button data-acc="${m.id}">Přijmout</button>
              <button data-den="${m.id}">Odmítnout</button>
            ` : ''}
            ${canKick ? `<button data-kick="${m.id}" title="Odpojit">⛔</button>` : ''}
          </li>
        `;
      }).join('') || '<li class="badge" style="opacity:.8">Nikdo připojený.</li>';

      hostMembers.querySelectorAll('[data-acc]').forEach(btn=>btn.onclick=()=>updateDoc(memberDoc(code, btn.dataset.acc), { status:'active', acceptedAt: serverTimestamp(), generation: gen }));
      hostMembers.querySelectorAll('[data-den]').forEach(btn=>btn.onclick=()=>updateDoc(memberDoc(code, btn.dataset.den), { status:'denied', deniedAt: serverTimestamp(), generation: gen }));
      hostMembers.querySelectorAll('[data-kick]').forEach(btn=>btn.onclick=()=>{
        if (!confirm('Odpojit tohoto uživatele?')) return;
        updateDoc(memberDoc(code, btn.dataset.kick), { status:'kicked', kickedAt: serverTimestamp(), generation: gen });
      });
    });
  }

  async function becomeHost(code, nick){
    const gen = 'g_' + Math.random().toString(36).slice(2,10);
    const exp = new Date(Date.now() + 60*60*1000);
    await setDoc(sessionDoc(code), {
      hostUid: uid, hostNick: nick, createdAt: serverTimestamp(), lastActive: serverTimestamp(), expiresAt: exp,
      generation: gen, current: null,
    }, { merge:true });
    await setDoc(memberDoc(code, uid), { uid, nick, role:'host', status:'active', joinedAt: serverTimestamp(), lastSeen: serverTimestamp(), generation: gen }, { merge:true });
    setLocalSession({ code, role:'host', generation: gen });
    attach(code);
  }

  async function joinAsClient(code, nick){
    const sref = sessionDoc(code);
    const snap = await getDoc(sref);
    if (!snap.exists()) { await becomeHost(code, nick); return; }
    const data = snap.data() || {};
    const exp = data.expiresAt?.toDate ? data.expiresAt.toDate() : null;
    const isExpired = exp ? (exp.getTime() < Date.now()) : false;
    if (isExpired) {
      await runTransaction(db, async (tx)=>{
        const s2 = await tx.get(sref);
        const d2 = s2.data() || {};
        const exp2 = d2.expiresAt?.toDate ? d2.expiresAt.toDate() : null;
        if (exp2 && exp2.getTime() >= Date.now()) return;
        const gen = 'g_' + Math.random().toString(36).slice(2,10);
        const expNew = new Date(Date.now() + 60*60*1000);
        tx.set(sref, { hostUid: uid, hostNick: nick, createdAt: serverTimestamp(), lastActive: serverTimestamp(), expiresAt: expNew, generation: gen, current: null }, { merge:true });
        tx.set(memberDoc(code, uid), { uid, nick, role:'host', status:'active', joinedAt: serverTimestamp(), lastSeen: serverTimestamp(), generation: gen }, { merge:true });
        setLocalSession({ code, role:'host', generation: gen });
      });
      attach(code);
      return;
    }
    const gen = data.generation || ('g_' + Math.random().toString(36).slice(2,10));
    await setDoc(memberDoc(code, uid), { uid, nick, role:'client', status:'pending', joinedAt: serverTimestamp(), lastSeen: serverTimestamp(), generation: gen }, { merge:true });
    setLocalSession({ code, role:'client', generation: gen });
    attach(code);
  }

  async function hostStopSharing(code){
    if (!confirm('Opravdu zrušit sdílení? Tím odpojíš všechny připojené.')) return;
    const newGen = 'g_' + Math.random().toString(36).slice(2,10);
    const exp = new Date(Date.now() + 60*60*1000);
    await updateDoc(sessionDoc(code), { generation: newGen, current: null, lastActive: serverTimestamp(), expiresAt: exp, closedAt: serverTimestamp() });
    cleanupSubs();
    clearLocalSession();
    paintShare('');
    hostPanel.style.display='none'; clientPanel.style.display='none';
    setMsg('Sdílení zrušeno. Kód je volný.', 'info');
  }
function interceptNavigationForHost(){
  document.addEventListener('click', async (e)=>{
    const a = e.target?.closest?.('a');
    if (!a) return;

    const hrefRaw = a.getAttribute('href') || '';
    if (!isInternalZpjevnicekLink(hrefRaw)) return;

    const local = getLocalSession();
    if (!HAS_CONFIG || !local?.code || local.role !== 'host') return;

    if (a.target === '_blank' || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

    const target = canonicalPath(hrefRaw);

    e.preventDefault();
    e.stopPropagation();

    try{
      await updateDoc(sessionDoc(local.code), {
        current: { path: target, at: serverTimestamp() },
        lastActive: serverTimestamp(),
        expiresAt: new Date(Date.now() + 60*60*1000),
        generation: local.generation,
      });
    }catch(_){}

    location.href = target;
  }, true);
}
function attachNavigationSync(){
  const local = getLocalSession();
  if (!HAS_CONFIG || !local?.code || local.role !== 'client') return;

  if (unsubNav) try{unsubNav();}catch(_){}
  unsubNav = onSnapshot(sessionDoc(local.code), async (snap)=>{
    if (!snap.exists()) return;
    const s = snap.data() || {};
    if (s.generation !== local.generation) return;

    const cur = s.current;
    if (!cur?.path) return;

    // jen když je client active
    try{
      const meSnap = await getDoc(memberDoc(local.code, uid));
      const me = meSnap.data() || {};
      if (me.generation !== local.generation) return;
      if (me.status !== 'active') return;
    }catch(_){ return; }

    const target = canonicalPath(cur.path);
    const here = herePath();
    if (here !== target) location.href = target;
  });
}

  function attach(code){
    if (!HAS_CONFIG) return;
    cleanupSubs();
    const local = getLocalSession();
    if (!local || local.code !== code) return;
    const genLocal = local.generation;
    const roleLocal = local.role;

    unsubSession = onSnapshot(sessionDoc(code), async (snap)=>{
      if (!snap.exists()){
        cleanupSubs(); clearLocalSession(); paintShare('');
        setMsg('Sdílení skončilo (kód už neexistuje).', 'err');
        hostPanel.style.display='none'; clientPanel.style.display='none';
        return;
      }
      const s = snap.data() || {};
      if (s.generation && genLocal && s.generation !== genLocal){
        cleanupSubs(); clearLocalSession(); paintShare('');
        setMsg('Sdílení bylo ukončeno hlavním telefonem.', 'info');
        hostPanel.style.display='none'; clientPanel.style.display='none';
        return;
      }

      if (roleLocal === 'host'){
        paintShare('host');
        hostPanel.style.display='block'; clientPanel.style.display='none';
        renderHostMembers(code, genLocal);
        startHeartbeat(code, genLocal, 'host');

        // host drží aktuální stránku jako „current“
        try{
          await updateDoc(sessionDoc(code), {
            current: { path: (location.pathname + location.search), at: serverTimestamp() },
            lastActive: serverTimestamp(),
            expiresAt: new Date(Date.now() + 60*60*1000),
            generation: genLocal,
          });
        }catch(_){ }
      } else {
        hostPanel.style.display='none'; clientPanel.style.display='block';
        startHeartbeat(code, genLocal, 'client');

        // client: pokud je active a není paused, skákej podle current
        const cur = s.current;
        if (cur && cur.path){
          try{
            const meSnap = await getDoc(memberDoc(code, uid));
            const me = meSnap.data() || {};
            if (me.generation !== genLocal) return;
            if (me.status !== 'active') return;
            const here = location.pathname + location.search;
            if (here !== cur.path) location.href = cur.path;
          }catch(_){ }
        }
      }
    });

    unsubMe = onSnapshot(memberDoc(code, uid), (snap)=>{
      if (!snap.exists()) return;
      const me = snap.data() || {};
      if (me.generation !== genLocal) return;
      if (roleLocal === 'client'){
        const st = me.status;
        if (st === 'pending'){
          paintShare(''); clientState.textContent='Čekáš na přijetí hlavním telefonem…';
        } else if (st === 'active'){
          paintShare('client'); clientState.textContent='Připojeno (ovládá tě hlavní telefon).';
        } else if (st === 'paused'){
          paintShare('paused'); clientState.textContent='Pauza – hlavní telefon tě teď neovládá.';
        } else if (st === 'denied' || st === 'kicked'){
          paintShare(''); clientState.textContent = (st==='denied') ? 'Byl(a) jsi odmítnut(a).' : 'Byl(a) jsi odpojen(a) hlavním telefonem.';
          clearLocalSession();
        }
      }
    });
  }

  dlgShareClose.onclick = ()=> dlgShare.close();

  btnShare.onclick = ()=>{
    dlgShare.showModal();
    setMsg('');
    const local = getLocalSession();
    if (!HAS_CONFIG){
      setMsg('Firebase není nastavený. Doplň FIREBASE_CONFIG.', 'err');
      hostPanel.style.display='none'; clientPanel.style.display='none';
      return;
    }
    if (local?.code){
      shareCode.value = local.code;
      shareCode.disabled = true;
      shareNick.disabled = true;
      shareJoin.style.display='none';
      if (local.role === 'host'){ hostPanel.style.display='block'; clientPanel.style.display='none'; }
      else { hostPanel.style.display='none'; clientPanel.style.display='block'; }
      attach(local.code);
      return;
    }
    shareCode.disabled = false;
    shareNick.disabled = false;
    shareJoin.style.display='';
    hostPanel.style.display='none'; clientPanel.style.display='none';
    shareNick.value = (localStorage.getItem('zpj_share_nick') || '');
    shareCode.value = '';
    shareNick.focus();
  };

  shareCode.addEventListener('input', ()=>{ shareCode.value = shareCode.value.replace(/\D/g,'').slice(0,5); });

  shareJoin.onclick = async ()=>{
    setMsg('');
    const nick = (shareNick.value||'').trim().slice(0,24);
    const code = normCode(shareCode.value);
    if (!nick){ setMsg('Zadej přezdívku.', 'err'); return; }
    if (!code){ setMsg('Kód musí mít 5 číslic.', 'err'); return; }
    localStorage.setItem('zpj_share_nick', nick);
    try{
      const sref = sessionDoc(code);
      const snap = await getDoc(sref);
      if (!snap.exists()) await becomeHost(code, nick);
      else {
        const data = snap.data() || {};
        if (data.hostUid === uid){ setLocalSession({ code, role:'host', generation: data.generation }); attach(code); }
        else await joinAsClient(code, nick);
      }
      shareCode.disabled=true; shareNick.disabled=true; shareJoin.style.display='none';
      const local = getLocalSession();
      if (local?.role === 'host'){ hostPanel.style.display='block'; clientPanel.style.display='none'; }
      else { hostPanel.style.display='none'; clientPanel.style.display='block'; }
      setMsg('Hotovo.', 'info');
    }catch(e){ console.error(e); setMsg('Nepodařilo se připojit. Zkontroluj Firebase rules a config.', 'err'); }
  };

  hostStop.onclick = async ()=>{ const local=getLocalSession(); if (!local?.code) return; await hostStopSharing(local.code); };
  hostRefresh.onclick = ()=>{ const local=getLocalSession(); if (!local?.code) return; attach(local.code); };
  clientPause.onclick = async ()=>{ const local=getLocalSession(); if (!local?.code) return; await updateDoc(memberDoc(local.code, uid), { status:'paused', pausedAt: serverTimestamp(), generation: local.generation }); };
  clientResume.onclick = async ()=>{ const local=getLocalSession(); if (!local?.code) return; await updateDoc(memberDoc(local.code, uid), { status:'active', resumedAt: serverTimestamp(), generation: local.generation }); };
  clientLeave.onclick = async ()=>{
    const local=getLocalSession();
    if (!local?.code) return;
    if (!confirm('Odpojit se od hlavního telefonu?')) return;
    try{ await updateDoc(memberDoc(local.code, uid), { status:'left', leftAt: serverTimestamp(), generation: local.generation }); }catch(_){ }
    cleanupSubs(); clearLocalSession(); paintShare('');
    hostPanel.style.display='none'; clientPanel.style.display='none';
    shareCode.disabled=false; shareNick.disabled=false; shareJoin.style.display='';
    setMsg('Odpojeno.', 'info');
  };

  // boot
(function boot(){
  const local=getLocalSession();
  if (!HAS_CONFIG){ paintShare(''); return; }
  if (local?.code){
    paintShare(local.role === 'host' ? 'host' : 'client');
    attach(local.code);
    attachNavigationSync();       // klient poslouchá current
    interceptNavigationForHost(); // host zapisuje current
  }
})();


</script>

<dialog id="dlgShare">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
    <strong id="shareTitle">Sdílení</strong>
    <button id="dlgShareClose">Zavřít</button>
  </div>

  <div id="shareBody">
    <div style="display:grid;gap:10px">
      <label style="display:grid;gap:6px">Přezdívka
        <input id="shareNick" placeholder="Třeba Jenda" autocomplete="nickname" />
      </label>
      <label style="display:grid;gap:6px">Pětičíselný kód
        <input id="shareCode" inputmode="numeric" pattern="[0-9]*" placeholder="12345" maxlength="5" />
      </label>
      <button id="shareJoin" style="width:100%">Vytvořit / přihlásit</button>
      <div id="shareMsg" class="badge" style="display:none"></div>
    </div>

    <hr class="sep" />

    <div id="hostPanel" style="display:none">
      <div class="badge" style="margin-bottom:8px">Jsi <strong>hlavní</strong>. Příchozí žádosti musíš potvrdit.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button id="hostStop">Zrušit sdílení (odpojit všechny)</button>
        <button id="hostRefresh">Obnovit seznam</button>
      </div>
      <div style="font-weight:600;margin:6px 0">Připojení</div>
      <ul id="hostMembers" style="list-style:none;margin:0;padding:0;max-height:50vh;overflow:auto"></ul>
    </div>

    <div id="clientPanel" style="display:none">
      <div id="clientState" class="badge" style="margin-bottom:10px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="clientPause">Pauznout</button>
        <button id="clientResume">Obnovit</button>
        <button id="clientLeave">Odpojit se</button>
      </div>
    </div>
  </div>
</dialog>
  
</body>
</html>
