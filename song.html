<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=yes">
<title>Píseň</title>

<link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zpjěvníček" />

<script defer src="https://unpkg.com/@coderline/alphatab@latest/dist/alphaTab.min.js"></script>
<style>
  html, body { margin:0; }
  :root{
    --cpfs: calc(20px * var(--song-scale, 1));
    --chromeH:0px;
    --chordColor:#22c55e;
    --chordScale:1.05;
    --cp-line:1.25;
    --cp-pad:1.05em;
    --cp-pad-nochords:0.20em;
    --song-pad-top: 2px;
    --song-pad-bottom: 24px;
    --song-pad-x: 2px;
    --scrollbarW: 3px;
  }

  /* ChordPro */
  .cp{ font-family:system-ui,Segoe UI,Arial,sans-serif; color:var(--ink); font-size:var(--cpfs); line-height:var(--cp-line); }
  .cp .line{ position:relative; white-space:normal; overflow:visible; word-break:keep-all; overflow-wrap:normal; }
  .cp .seg{ position:relative; display:inline-block; padding-top:var(--cp-pad) }
  .cp .ch{ position:absolute; left:0; top:0; font-weight:700; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:calc(1em * var(--chordScale)); color:var(--chordColor); }
  .cp .ly{ visibility:visible; display:inline-block; white-space:pre-wrap; }
  .cp.nochords .ch{ display:none } .cp.nochords .seg{ padding-top:var(--cp-pad-nochords) }

  .sheet{ padding:0; background:transparent; border:none; box-shadow:none; }

  #chrome{ position:fixed; top:0; left:0; right:0; z-index:5; background:var(--card);
    padding:12px 12px 8px; border-bottom:1px solid #192544; transition: transform .2s ease, opacity .2s ease; }
  body.chrome-hidden #chrome{ transform: translateY(-110%); opacity:0; height:0; padding:0; margin:0; border:0; overflow:hidden; }

  #view{
    height:100vh; max-height:100vh; overflow:auto; background:transparent; border:0; border-radius:0; box-shadow:none;
    padding: var(--song-pad-top) 0 var(--song-pad-bottom) var(--song-pad-x);
    scrollbar-width: thin; scrollbar-color:#2c3b60 transparent;
  }
  #view::-webkit-scrollbar{ width:var(--scrollbarW); }
  #view::-webkit-scrollbar-track{ background:transparent; }
  #view::-webkit-scrollbar-thumb{ background:#2c3b60; border-radius:2px; }

  body:not(.chrome-hidden) #view{ padding-top: var(--chromeH); }
  body.chrome-hidden #view{ padding-top: env(safe-area-inset-top, 0px); }
  body.chrome-hidden .sheet{ margin-top:0 !important; padding-top:0 !important; }

  .chrome-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  button.ghost{ background:transparent; border:1px solid #2c3b60; border-radius:8px; padding:4px 8px; color:var(--ink); cursor:pointer; }
  button.ghost:hover{ background:#17213a; }

  .auto-scroll{
    position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px;
    background:transparent; border:2px solid #2c3b60; color:var(--ink); font-size:28px; line-height:1;
    display:flex; align-items:center; justify-content:center; z-index:10; opacity:.9; cursor:pointer;
  }
  .auto-scroll:hover{ opacity:1 } .auto-scroll:active{ transform:scale(.98) } .auto-scroll.hidden{ display:none }
  .container{ padding-right:0 !important; }
</style>
</head>
<body>
  <div class="container">
    <div class="sheet">
      <div id="chrome">
        <div class="chrome-row">
          <a id="backLink" href="#">← Zpět</a>
          <button id="toggleChrome" class="ghost" title="Skrýt / zobrazit lištu">▾</button>
        </div>
        <h2 id="title" style="margin:8px 0">Načítám…</h2>
        <div class="badge" id="meta"></div>

        <div id="controls-score" class="player" style="display:none">
          <button id="play">Přehrát</button>
          <button id="stop">Stop</button>
          <label>Tempo <input id="tempo" type="range" min="30" max="200" value="100"></label>
        </div>

        <div id="controls-cp" class="player" style="display:none">
          <span class="kbd">Transponovat:
            <button id="down" type="button">−</button>
            <button id="up"   type="button">+</button>
          </span>
          <span class="kbd">Rolování:
            <button id="toggleAutoBtn" type="button" aria-label="Zobrazit/skrýt tlačítko autoposuvu">
              <span id="autoBtnIcon">✅</span>
            </button>
          </span>
          <span class="kbd">Velikost:
            <button id="fontDown" type="button">−</button>
            <button id="fontUp"   type="button">+</button>
          </span>
          <span class="kbd">Akordy:
            <button id="toggleChords" type="button" aria-label="Přepnout akordy">
              <span id="chordsIcon">✅</span>
            </button>
          </span>
        </div>
      </div>

      <div id="view"></div>
    </div>
  </div>

<button id="autoScroll" class="auto-scroll" title="Auto posuv">∨</button>

<script>
const params = new URLSearchParams(location.search);
const id = params.get('id');
const plId = params.get('pl') || ''; // pokud přišel z playlistu

let song, SONGS_LIST=[], SONG_INDEX=-1;
let HIDE_CHORDS = localStorage.getItem('hideChords') === '1';
let justSwipedTs = 0;
let CHROME_HIDDEN = localStorage.getItem('chromeHidden') === '1';
if (CHROME_HIDDEN) document.body.classList.add('chrome-hidden');

/* --- Auto scroll --- */
let AUTO_BTN_VISIBLE = localStorage.getItem('autoBtnVisible') !== '0';
let autoMode = 0, _autoRaf=0, _lastTs=0;

function updateAutoBtnVisibility(){
  const ico = document.getElementById('autoBtnIcon');
  const floater = document.getElementById('autoScroll');
  if (ico) ico.textContent = AUTO_BTN_VISIBLE ? '✅' : '❌';
  if (floater) floater.classList.toggle('hidden', !AUTO_BTN_VISIBLE);
}
function stopAutoScroll(){ autoMode=0; if(_autoRaf) cancelAnimationFrame(_autoRaf); _autoRaf=0; _lastTs=0; }
function runAutoScroll(){
  if (_autoRaf) cancelAnimationFrame(_autoRaf);
  _lastTs = 0; const view=document.getElementById('view'); const speeds={1:20,2:45};
  function tick(ts){
    if (autoMode===0) return;
    if (!_lastTs) _lastTs=ts; const dt=(ts-_lastTs)/1000; _lastTs=ts;
    const spd = speeds[autoMode]||0; if(spd>0){
      const max=view.scrollHeight-view.clientHeight;
      if(view.scrollTop>=max-1){ stopAutoScroll(); } else { view.scrollTop=Math.min(max, view.scrollTop+spd*dt); }
    }
    if (autoMode!==0) _autoRaf=requestAnimationFrame(tick);
  }
  _autoRaf=requestAnimationFrame(tick);
}

/* --- CZ noty + transpozice --- */
const NOTES_CZ = ['C','C#','D','D#','E','F','F#','G','G#','A','B','H'];
const ALT = { 'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','A#':'B','Bb':'B','Hb':'B','Cb':'H','B#':'C','H#':'C','E#':'F','Fb':'E' };
function normRoot(r){ return ALT[r] || r; }
function transposeNote(n, semi){ const up=n.toUpperCase(); const norm=normRoot(up); const i=NOTES_CZ.indexOf(norm); if(i<0) return n; return NOTES_CZ[(i+semi+120)%12]; }
function transposeChord(token, semi){
  const m = token.match(/^([A-Ha-h](?:#|b)?)(.*?)(?:\/([A-Ha-h](?:#|b)?)(.*))?$/);
  if (!m) return token;
  const rootT = transposeNote(m[1], semi);
  const bassT = m[3] ? transposeNote(m[3], semi) : null;
  return rootT + (m[2]||'') + (bassT?('/'+bassT):'') + (m[4]||'');
}

/* --- Parser + render --- */
function parseChordPro(text){
  const meta = {}, raw = text.replace(/\r/g,'').split('\n');
  const body=[]; for(const line of raw){ const m=line.match(/^\{(\w+)\s*:\s*(.*?)\s*\}$/); if(m){ meta[m[1].toLowerCase()]=m[2]; continue; } body.push(line); }
  while(body.length && !body[0].trim()) body.shift();
  while(body.length && !body[body.length-1].trim()) body.pop();
  const lines=[]; let prevEmpty=false;
  for(const l of body){ const empty=!l.trim(); if(empty && prevEmpty) continue; lines.push(l); prevEmpty=empty; }
  return { meta, lines };
}
function renderChordPro(text, transposeSemi=0){
  const {lines} = parseChordPro(text);
  const cont=document.createElement('div'); cont.className='cp';
  for(const raw of lines){
    if(!raw.trim()){ cont.appendChild(document.createElement('br')); continue; }
    const line=document.createElement('div'); line.className='line';
    let i=0, pending=null;
    while(i<raw.length){
      if(raw[i]=='['){
        const close=raw.indexOf(']', i+1);
        if(close!==-1){
          const token=raw.slice(i+1, close); i=close+1;
          if(i>=raw.length || raw[i]=='['){
            const seg=document.createElement('span'); seg.className='seg';
            const ch=document.createElement('span'); ch.className='ch'; ch.textContent=transposeChord(token, transposeSemi);
            const ly=document.createElement('span'); ly.className='ly'; ly.textContent=' ';
            seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg); pending=null; continue;
          }else{ pending=token; continue; }
        }
      }
      let j=i; while(j<raw.length && raw[j]!='[') j++;
      const lyr=raw.slice(i,j)||' ';
      const seg=document.createElement('span'); seg.className='seg';
      const ch=document.createElement('span'); ch.className='ch'; ch.textContent=pending?transposeChord(pending, transposeSemi):'';
      const ly=document.createElement('span'); ly.className='ly'; ly.textContent=lyr;
      seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg); pending=null; i=j;
    }
    if(pending){
      const seg=document.createElement('span'); seg.className='seg';
      const ch=document.createElement('span'); ch.className='ch'; ch.textContent=transposeChord(pending, transposeSemi);
      const ly=document.createElement('span'); ly.className='ly'; ly.textContent=' ';
      seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg);
    }
    cont.appendChild(line);
  }
  return cont;
}
const MIN_CHORD_GAP=4;
function fixChordOverlaps(root){
  const lines=root.querySelectorAll('.line');
  lines.forEach(line=>{
    line.querySelectorAll('.seg').forEach(seg=>{ seg.style.marginLeft=''; });
    let prevRight=-Infinity, lastTop=null;
    const chords=Array.from(line.querySelectorAll('.ch'));
    chords.forEach(ch=>{
      const seg=ch.parentElement, r=ch.getBoundingClientRect();
      if(lastTop!==null && (r.top-lastTop)>0.5){ prevRight=-Infinity; }
      lastTop=r.top;
      const needLeft=prevRight+MIN_CHORD_GAP, need=needLeft-r.left;
      if(need>0){ const cur=parseFloat(seg.style.marginLeft||'0'); seg.style.marginLeft=(cur+need)+'px'; const nr=ch.getBoundingClientRect(); prevRight=nr.right; }
      else { prevRight=r.right; }
    });
    const segs=Array.from(line.querySelectorAll('.seg'));
    if(segs.length){
      const rects=segs.map(s=>s.getBoundingClientRect());
      const firstLeft=Math.min(...rects.map(r=>r.left));
      const firstTop=Math.min(...rects.map(r=>r.top));
      const LEFT_TOL=16, TOP_TOL=0.5;
      segs.forEach((seg,i)=>{ const r=rects[i]; const startsNew=(r.top-firstTop)>TOP_TOL && (r.left-firstLeft)<LEFT_TOL; if(startsNew) seg.style.marginLeft='0px'; });
    }
  });
}

/* --- Layout helpers --- */
function relayoutChords(){ const cp=document.querySelector('#view .cp'); if(!cp) return; requestAnimationFrame(()=>fixChordOverlaps(cp)); }
function updateChromeHeight(){ const ch=document.getElementById('chrome'); const h=ch?ch.getBoundingClientRect().height:0; document.documentElement.style.setProperty('--chromeH',(h||0)+'px'); }
function setChromeHidden(h){ CHROME_HIDDEN=!!h; document.body.classList.toggle('chrome-hidden', CHROME_HIDDEN); localStorage.setItem('chromeHidden', CHROME_HIDDEN?'1':'0'); updateChromeHeight(); }

/* --- ovládání lišty + swipe --- */
function wireDoubleToggle(){
  const view=document.getElementById('view'); if(!view) return;
  let lastTapTime=0,lastX=0,lastY=0,recentToggleTs=0;
  view.addEventListener('dblclick', ()=>{ if(Date.now()-recentToggleTs<400) return; if(Date.now()-justSwipedTs<350) return; setChromeHidden(!document.body.classList.contains('chrome-hidden')); });
  view.addEventListener('touchend', (e)=>{
    if(e.touches&&e.touches.length) return;
    if(Date.now()-justSwipedTs<350) return;
    const t=Date.now(), touch=e.changedTouches[0], x=touch.clientX, y=touch.clientY;
    const withinTime = (t-lastTapTime)<300;
    const withinDist = Math.hypot(x-lastX,y-lastY)<30;
    if(withinTime && withinDist){ e.preventDefault(); setChromeHidden(!document.body.classList.contains('chrome-hidden')); recentToggleTs=t; lastTapTime=0; }
    else { lastTapTime=t; lastX=x; lastY=y; }
  }, {passive:false});
}
function wireSwipeNavigation(){
  const view=document.getElementById('view'); if(!view) return;
  let sx=0, sy=0, startTime=0;
  view.addEventListener('touchstart', (e)=>{ if(e.touches.length!==1) return; const t=e.touches[0]; sx=t.clientX; sy=t.clientY; startTime=Date.now(); }, {passive:true});
  view.addEventListener('touchend', (e)=>{
    if(!startTime) return;
    const t=e.changedTouches[0]; const dx=t.clientX-sx; const dy=t.clientY-sy; const dt=Date.now()-startTime;
    const ABSX=Math.abs(dx), ABSY=Math.abs(dy); const isSwipe=ABSX>70 && ABSY<60 && dt<600;
    if(isSwipe){ e.preventDefault(); justSwipedTs=Date.now(); if(dx<0) goNextSong(); else goPrevSong(); }
    startTime=0;
  }, {passive:false});
}
function goNextSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const next=(SONG_INDEX+1)%SONGS_LIST.length;
  const nxtId = SONGS_LIST[next];
  const extra = plId ? `&pl=${encodeURIComponent(plId)}` : '';
  location.href = `song.html?id=${encodeURIComponent(nxtId)}${extra}`;
}
function goPrevSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const prev=(SONG_INDEX-1+SONGS_LIST.length)%SONGS_LIST.length;
  const prvId = SONGS_LIST[prev];
  const extra = plId ? `&pl=${encodeURIComponent(plId)}` : '';
  location.href = `song.html?id=${encodeURIComponent(prvId)}${extra}`;
}

/* --- velikost textu napříč PWA --- */
const ZPJ_FONT_KEY='zpj-fontScale';
function getScale(){ const s=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--song-scale'))||1; return s>0?s:1; }
function setScale(s){ const c=Math.min(3,Math.max(0.5,s)); document.documentElement.style.setProperty('--song-scale', String(c)); localStorage.setItem(ZPJ_FONT_KEY, String(c)); relayoutChords(); }

/* --- načtení + render --- */
async function load(){
  const data = await fetch('data/songs.json', {cache:'no-store'}).then(r=>r.json()).catch(()=>[]);
  // zdroj seznamu pro swipe: playlist vs hlavní list
  if (plId){
    const pls = JSON.parse(localStorage.getItem('zpj_playlists')||'[]');
    const pl = pls.find(p=>p.id===plId);
    SONGS_LIST = (pl && Array.isArray(pl.items) && pl.items.length)? pl.items.slice() : data.map(s=>s.id);
  } else {
    SONGS_LIST = data.map(s=>s.id);
  }
  SONG_INDEX = SONGS_LIST.indexOf(id);

  song = data.find(s=>s.id===id);
  if(!song){ document.getElementById('title').textContent='Píseň nenalezena'; return; }
  document.getElementById('title').textContent = `${song.number ?? '–'} · ${song.title}`;
  document.getElementById('meta').textContent = song.author || '';

  // back link podle kontextu
  const backLink = document.getElementById('backLink');
  if (plId){
    backLink.textContent = '← Zpět na playlist';
    backLink.onclick = (e)=>{ e.preventDefault(); location.href = '/zpjevnicek/index.html#pl:' + encodeURIComponent(plId); };
  }else{
    backLink.textContent = '← Zpět na seznam';
    backLink.onclick = (e)=>{ e.preventDefault(); if (document.referrer.includes('/zpjevnicek/')) history.back(); else location.href='/zpjevnicek/'; };
  }

  if (song.type === 'chordpro' || /\.pro$|\.cho$/i.test(song.file)) {
    document.getElementById('controls-cp').style.display='flex';
    const text = await fetch(song.file).then(r=>r.text());
    let trans=0;
    const render = ()=>{
      const view=document.getElementById('view');
      const el=renderChordPro(text, trans);
      view.innerHTML=''; view.appendChild(el);
      requestAnimationFrame(()=>fixChordOverlaps(el));
      applyChordVisibility(); updateChromeHeight();
    };
    render();
    document.getElementById('up').onclick   = ()=>{ trans+=1; render(); };
    document.getElementById('down').onclick = ()=>{ trans-=1; render(); };

    let scale = getScale();
    document.getElementById('fontUp').onclick   = ()=>{ scale = Math.min(3,   +(scale + 0.1).toFixed(2)); setScale(scale); };
    document.getElementById('fontDown').onclick = ()=>{ scale = Math.max(0.5, +(scale - 0.1).toFixed(2)); setScale(scale); };

    document.getElementById('toggleChords').onclick = ()=>{
      HIDE_CHORDS = !HIDE_CHORDS;
      localStorage.setItem('hideChords', HIDE_CHORDS ? '1' : '0');
      applyChordVisibility(); relayoutChords();
    };
  } else {
    document.getElementById('controls-score').style.display='flex';
    const el=document.getElementById('view');
    const at=new alphaTab.AlphaTabApi(el, { file:song.file, player:{ enablePlayer:true }});
    document.getElementById('play').onclick = ()=> at.playPause();
    document.getElementById('stop').onclick = ()=> at.stop();
    document.getElementById('tempo').oninput = e=> at.playbackSpeed = e.target.value/100;
    at.renderFinished.on(()=> updateChromeHeight());
  }

  // plovoucí tlačítko autoposuvu
  const tgl = document.getElementById('toggleAutoBtn');
  if (tgl) tgl.onclick = ()=>{ AUTO_BTN_VISIBLE = !AUTO_BTN_VISIBLE; localStorage.setItem('autoBtnVisible', AUTO_BTN_VISIBLE ? '1' : '0'); updateAutoBtnVisibility(); };
  const autoBtn=document.getElementById('autoScroll');
  if (autoBtn) autoBtn.onclick=()=>{ autoMode=(autoMode+1)%3; if(autoMode===0) stopAutoScroll(); else runAutoScroll(); };
  updateAutoBtnVisibility();

  wireDoubleToggle();
  wireSwipeNavigation();
  updateChromeHeight();

  const toggleBtn=document.getElementById('toggleChrome');
  if (toggleBtn) toggleBtn.onclick = ()=> setChromeHidden(!document.body.classList.contains('chrome-hidden'));
}
function applyChordVisibility(){
  const cp=document.querySelector('#view .cp'); if(!cp) return;
  if (HIDE_CHORDS) cp.classList.add('nochords'); else cp.classList.remove('nochords');
  const ico=document.getElementById('chordsIcon'); if(ico) ico.textContent = HIDE_CHORDS ? '❌' : '✅';
}

/* --- resize/orientation --- */
let _resizeTO;
function onResizeReflow(){ updateChromeHeight(); relayoutChords(); }
window.addEventListener('resize', ()=>{ clearTimeout(_resizeTO); _resizeTO=setTimeout(onResizeReflow,120); });
window.addEventListener('orientationchange', ()=>{ setTimeout(onResizeReflow,150); });

/* --- SW --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' })
      .then(r => console.log('Zpjěvníček SW scope:', r.scope))
      .catch(console.error);
  });
}

/* --- globální scale --- */
(function applyGlobalSongScale(){
  const val = parseFloat(localStorage.getItem('zpj-fontScale'));
  if (!isNaN(val) && val > 0) document.documentElement.style.setProperty('--song-scale', String(val));
})();

load();
</script>
</body>
</html>
