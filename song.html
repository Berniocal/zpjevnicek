<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P√≠se≈à</title>
  <link rel="stylesheet" href="assets/style.css" />
  <script defer src="https://unpkg.com/@coderline/alphatab@latest/dist/alphaTab.min.js"></script>
  <style>
    .cp { font-family: system-ui, Segoe UI, Arial; line-height: 1.9 }
    .cp .line { position: relative; white-space: pre-wrap }
    .cp .seg { position: inline-block; display: inline-block; padding-top: 1.1em }
    .cp .ch { position: absolute; left: 0; top: 0; font-weight:700; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9em }
    .cp .ly { visibility: visible }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#17213a; border:1px solid #2c3b60; border-radius:8px; padding:.15em .4em }
  </style>
  <style>
/* Fullscreen overlay pro ƒçten√≠ p√≠snƒõ */
.overlay{position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,.85); display:none}
.overlay.open{display:block}
.stage{position:absolute; inset:0; display:flex; flex-direction:column}
.toolbar{display:flex; justify-content:space-between; align-items:center; gap:8px;
  padding:10px 14px; background:#0f1729; border-bottom:1px solid #24324a; color:#eaf1ff}
.viewer{flex:1; overflow:auto; padding:18px}

/* ChordPro render ve fullscreen overlayi */
.overlay .cp{ font-size: var(--fs, 24px); line-height:1.9; color:#eaf1ff }
.overlay .cp .line{ position:relative; white-space:pre-wrap }
.overlay .cp .seg{ position:relative; display:inline-block; padding-top:1.1em }
.overlay .cp .ch{ position:absolute; left:0; top:0; font-weight:700;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9em }
.overlay .cp .ly{ visibility:visible }
.kbd{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#17213a; border:1px solid #2c3b60; border-radius:8px; padding:.15em .4em}
</style>
</head>
<body>
  <div class="container">
    <a href="index.html">‚Üê Zpƒõt na seznam</a>
    <div class="card" style="margin-top:12px">
      <h2 id="title" style="margin-top:0">Naƒç√≠t√°m‚Ä¶</h2>
      <div class="badge" id="meta"></div>

      <div id="controls-score" class="player" style="display:none">
        <button id="play">P≈ôehr√°t</button>
        <button id="stop">Stop</button>
        <label>Tempo <input id="tempo" type="range" min="30" max="200" value="100"></label>
      </div>

<div id="controls-cp" class="player" style="display:none">
  <span class="kbd">ChordPro</span>
  <button id="down">Transpose ‚àí</button>
  <button id="up">Transpose +</button>
  <label>Capo <input id="capo" type="number" min="0" max="11" value="0" style="width:4.5em"></label>
  <button id="previewBtn">üëÅ N√°hled / Cel√° obrazovka</button>
  <span class="kbd">Zoom: <button id="fsDown" type="button">‚àí</button>
    <span id="fsVal" style="display:inline-block; min-width:3ch; text-align:center">24</span>
    <button id="fsUp" type="button">+</button>
  </span>
</div>


      <div id="view" class="card" style="overflow:auto; max-height:70vh"></div>
    </div>
  </div>

<script>
const params = new URLSearchParams(location.search);
const id = params.get('id');
let song;

const NOTES_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const ALT = {'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
function normRoot(r){ return ALT[r] || r; }
function splitChord(ch){ const m = ch.match(/^([A-G](?:#|b)?)(.*)$/); return m ? {root: normRoot(m[1]), rest:m[2]} : {root:ch, rest:''}; }
function transposeChord(ch, semi){
  const s = splitChord(ch); const i = NOTES_SHARP.indexOf(s.root); if(i===-1) return ch;
  const j = (i + semi + 120) % 12; return NOTES_SHARP[j] + s.rest;
}
function parseChordPro(text){
  const meta = {}; const lines = text.replace(/\r/g,'').split('\n'); const blocks = [];
  for (const line of lines){
    const m = line.match(/^\{(\w+)\s*:\s*(.*?)\s*\}$/);
    if (m) { meta[m[1].toLowerCase()] = m[2]; continue; }
    blocks.push(line);
  }
  return { meta, lines: blocks };
}
function renderChordPro(text, transposeSemi=0, capo=0){
  const { meta, lines } = parseChordPro(text);
  const rootTrans = transposeSemi - (capo|0);
  const cont = document.createElement('div'); cont.className = 'cp';
  for (const raw of lines){
    if (!raw.trim()) { cont.appendChild(document.createElement('br')); continue; }
    const line = document.createElement('div'); line.className = 'line';
    let i = 0, curChord = '';
    while (i < raw.length){
      if (raw[i] === '['){
        const j = raw.indexOf(']', i+1);
        if (j !== -1){ curChord = raw.slice(i+1, j); i = j+1; continue; }
      }
      let j = i; while (j < raw.length && raw[j] !== '[') j++;
      const lyr = raw.slice(i, j) || ' ';
      const seg = document.createElement('span'); seg.className='seg';
      const ch = document.createElement('span'); ch.className='ch';
      ch.textContent = curChord ? transposeChord(curChord, rootTrans) : '';
      const ly = document.createElement('span'); ly.className='ly'; ly.textContent = lyr;
      seg.appendChild(ch); seg.appendChild(ly);
      line.appendChild(seg); i = j;
    }
    cont.appendChild(line);
  }
  return { meta, element: cont };
}

async function load(){
  const data = await fetch('data/songs.json', {cache:'no-store'}).then(r=>r.json());
  song = data.find(s => s.id === id);
  if(!song){ document.getElementById('title').textContent = 'P√≠se≈à nenalezena'; return; }
  document.getElementById('title').textContent = `${song.number ?? '‚Äì'} ¬∑ ${song.title}`;
  document.getElementById('meta').textContent = song.author || '';

  if (song.type === 'chordpro' || /\.pro$|\.cho$/i.test(song.file)) {
    document.getElementById('controls-cp').style.display = 'flex';
    const text = await fetch(song.file).then(r=>r.text());
    let trans = 0, capo = 0;
    const render = ()=> {
      const v = renderChordPro(text, trans, capo);
      const view = document.getElementById('view'); view.innerHTML = ''; view.appendChild(v.element);
    };
    render();
    document.getElementById('up').onclick = ()=>{ trans+=1; render(); };
    document.getElementById('down').onclick = ()=>{ trans-=1; render(); };
    document.getElementById('capo').oninput = (e)=>{ capo = parseInt(e.target.value||0,10); render(); };
  } else {
    document.getElementById('controls-score').style.display = 'flex';
    const el = document.getElementById('view');
    const at = new alphaTab.AlphaTabApi(el, { file: song.file, player: { enablePlayer: true } });
    document.getElementById('play').onclick = ()=> at.playPause();
    document.getElementById('stop').onclick = ()=> at.stop();
    document.getElementById('tempo').oninput = (e)=> at.playbackSpeed = e.target.value/100;
  }
}
load();
  // ---- Fullscreen/zoom pro ChordPro ----
const overlay = document.getElementById('overlay');
const overlayView = document.getElementById('overlayView');
const fsVal = document.getElementById('fsVal');
let fontSize = Number(localStorage.getItem('cp_fs') || 24);

function applyFontSize(){
  overlay.style.setProperty('--fs', fontSize + 'px');
  if(fsVal) fsVal.textContent = fontSize;
  localStorage.setItem('cp_fs', String(fontSize));
}

// Zapoj√≠ se jen v ChordPro vƒõtvi uvnit≈ô load()
async function enableChordProOverlay(text){
  // tlaƒç√≠tko v li≈°tƒõ pod n√°zvem
  document.getElementById('previewBtn').onclick = ()=>{
    overlayView.innerHTML = '';
    overlayView.appendChild(renderChordPro(text, trans, capo).element);
    overlay.classList.add('open');
    applyFontSize();
  };
  document.getElementById('closeOverlay').onclick = ()=>{
    overlay.classList.remove('open');
    if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
  };
  document.getElementById('fsToggle').onclick = async ()=>{
    if (!document.fullscreenElement) { try { await overlay.requestFullscreen(); } catch(e){} }
    else { try { await document.exitFullscreen(); } catch(e){} }
  };
  document.getElementById('fsUp').onclick = ()=>{ fontSize = Math.min(80, fontSize+2); applyFontSize(); };
  document.getElementById('fsDown').onclick = ()=>{ fontSize = Math.max(12, fontSize-2); applyFontSize(); };
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.classList.contains('open')) document.getElementById('closeOverlay').click(); });
}

</script>
  <!-- Fullscreen overlay -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="stage">
    <div class="toolbar">
      <strong>N√°hled p√≠snƒõ</strong>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <button id="fsToggle" type="button">Na celou obrazovku</button>
        <button id="closeOverlay" type="button">Zav≈ô√≠t ‚úï</button>
      </div>
    </div>
    <div id="overlayView" class="viewer"></div>
  </div>
</div>

</body>
</html>
