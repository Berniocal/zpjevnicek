<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=yes">
<title>Píseň</title>

<link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zpjěvníček" />

<script defer src="https://unpkg.com/@coderline/alphatab@latest/dist/alphaTab.min.js"></script>
<style>
  html, body { margin:0; }
  :root{
    --cpfs: calc(20px * var(--song-scale, 1));
    --chromeH:0px;
    --chordColor:#22c55e;   /* výchozí barva akordů */
    --chordScale:1.05;      /* výchozí měřítko akordů vůči textu */
    --cp-line:1.25;
    --cp-pad:1.05em;
    --cp-pad-nochords:0em;

    /* >>> OKRAJE TEXTU PÍSNĚ <<< */
    --song-pad-top: 15px;
    --song-pad-bottom: 24px;
    --song-pad-x: 6px;
    --song-pad-right: 6px;

    --scrollbarW: 3px;
        --col-count: 1;
    --col-gap: 14px; /* mezera mezi sloupci */

  }

  /* ChordPro */
  .cp{ font-family:system-ui,Segoe UI,Arial,sans-serif; color:var(--ink); font-size:var(--cpfs); line-height:var(--cp-line); }
  .cp .line{ position:relative; white-space:normal; overflow:visible; word-break:keep-all; overflow-wrap:normal; }
  .cp .seg{ position:relative; display:inline-block; padding-top:var(--cp-pad) }
  .cp .ch{ position:absolute; left:0; top:0; font-weight:700; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:calc(1em * var(--chordScale)); color:var(--chordColor); }
  .cp .ly{ visibility:visible; display:inline-block; white-space:pre-wrap; }
  .cp.nochords .ch{ display:none } .cp.nochords .seg{ padding-top:var(--cp-pad-nochords) }

  .sheet{ padding:0; background:transparent; border:none; box-shadow:none; }

  #chrome{ position:fixed; top:0; left:0; right:0; z-index:5; background:var(--card);
    padding:12px 12px 8px; border-bottom:1px solid #192544; transition: transform .2s ease, opacity .2s ease; }
  body.chrome-hidden #chrome{ transform: translateY(-110%); opacity:0; height:0; padding:0; margin:0; border:0; overflow:hidden; }

  #view .cp{
    column-count: var(--col-count);
    column-gap: var(--col-gap);
  }

  /* ať se jeden řádek neroztrhne mezi sloupce */
  #view .cp .line{
    break-inside: avoid;
    -webkit-column-break-inside: avoid;
    page-break-inside: avoid;
  }
#view{
  height:100vh; max-height:100vh; overflow:auto; background:transparent; border:0; border-radius:0; box-shadow:none;
  /*             TOP                         RIGHT (nově)                         BOTTOM                                  LEFT */
  padding: var(--song-pad-top)
           var(--song-pad-right, var(--song-pad-x))
           calc(var(--song-pad-bottom) + env(safe-area-inset-bottom, 0px) + 12px)
           var(--song-pad-x);
  scrollbar-width: thin; scrollbar-color:#2c3b60 transparent;
}

  #view::-webkit-scrollbar{ width:var(--scrollbarW); }
  #view::-webkit-scrollbar-track{ background:transparent; }
  #view::-webkit-scrollbar-thumb{ background:#2c3b60; border-radius:2px; }

  body:not(.chrome-hidden) #view{ padding-top: calc(var(--chromeH) + var(--song-pad-top)) !important; }
  body.chrome-hidden #view{ padding-top: max(env(safe-area-inset-top, 0px), var(--song-pad-top)) !important; }
  body.chrome-hidden .sheet{ margin-top:0 !important; padding-top:0 !important; }

  .chrome-row{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  button.ghost{ background:transparent; border:1px solid #2c3b60; border-radius:8px; padding:4px 8px; color:var(--ink); cursor:pointer; }
  button.ghost:hover{ background:#17213a; }

  .title-row{ display:flex; align-items:center; gap:8px; margin:8px 0; }
  #btnSettings{ background:transparent; border:1px solid #2c3b60; color:var(--ink); border-radius:8px; padding:4px 8px; cursor:pointer; }
  #btnSettings:hover{ background:#17213a; }

  /* „dropdown“ panel nastavení */
  #settingsPanel{
    position:absolute; right:12px; top:58px; z-index:6;
    background:var(--card); border:1px solid #223055; border-radius:10px; padding:10px 12px; box-shadow:0 10px 24px rgba(0,0,0,.35);
    display:none; min-width:300px;
  }
  #settingsPanel .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0; }
  #settingsPanel label{ color:var(--ink); font-size:14px; }
  #settingsPanel input[type="number"]{ width:100px; padding:4px 6px; border-radius:8px; border:1px solid #2c3b60; background:transparent; color:var(--ink); }
  #settingsPanel input[type="color"]{ width:40px; height:28px; padding:0; border:1px solid #2c3b60; border-radius:6px; background:transparent; }
  #settingsPanel .hint{ font-size:12px; color:#9fb0c7; margin-top:4px; }
  #settingsActions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
  #settingsSave{ border:1px solid #2c3b60; background:transparent; color:var(--ink); border-radius:8px; padding:6px 10px; cursor:pointer; }
  #settingsSave:hover{ background:#17213a; }

  .auto-scroll{
    position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px;
    background:transparent; border:2px solid #2c3b60; color:var(--ink); font-size:28px; line-height:1;
    display:flex; align-items:center; justify-content:center; z-index:10; opacity:.9; cursor:pointer;
  }
  .auto-scroll:hover{ opacity:1 } .auto-scroll:active{ transform:scale(.98) } .auto-scroll.hidden{ display:none }

  .container{ padding-right:0 !important; padding-left:0 !important; padding-top:0 !important; }
</style>
</head>
<body>
  <div class="container">
    <div class="sheet">
      <div id="chrome">
<div class="chrome-row">
  <a id="backLink" href="#">← Zpět</a>
  <button id="btnSettings" class="ghost" title="Nastavení posuvu a akordů">⚙️</button>
</div>

<div class="title-row">
  <h2 id="title" style="margin:0">Načítám…</h2>
</div>

        <div class="badge" id="meta"></div>

        <!-- panel nastavení -->
        <div id="settingsPanel" role="dialog" aria-modal="false" aria-labelledby="settingsTitle">
          <div style="font-weight:600;margin-bottom:6px" id="settingsTitle">Nastavení</div>

          <div class="row">
            <label for="speedInput">Rychlost posuvu (px/s)</label>
            <input id="speedInput" type="number" min="5" max="300" step="1">
          </div>
          <div class="row">
            <label for="delayInput">Zpoždění startu (s)</label>
            <input id="delayInput" type="number" min="0" max="30" step="0.1">
          </div>

          <div class="row">
            <label for="chordColorInput">Barva akordů</label>
            <input id="chordColorInput" type="color">
          </div>
          <div class="row">
            <label for="chordScaleInput">Poměr velikosti akordů</label>
            <input id="chordScaleInput" type="number" min="0.5" max="2.5" step="0.05">
          </div>

          <div class="hint">Uložit uloží hodnoty do zařízení a ihned je použije.</div>
          <div id="settingsActions">
            <button id="settingsReset" type="button">Původní nastavení</button>
            <button id="settingsSave">Uložit</button>
          </div>
        </div>

        <div id="controls-score" class="player" style="display:none">
          <button id="play">Přehrát</button>
          <button id="stop">Stop</button>
          <label>Tempo <input id="tempo" type="range" min="30" max="200" value="100"></label>
        </div>

        <div id="controls-cp" class="player" style="display:none">
          <span class="kbd">Transponovat:
            <button id="down" type="button">−</button>
            <button id="up"   type="button">+</button>
          </span>
          <span class="kbd">Rolování:
            <button id="toggleAutoBtn" type="button" aria-label="Zobrazit/skrýt tlačítko autoposuvu">
              <span id="autoBtnIcon">✅</span>
            </button>
          </span>
          <span class="kbd">Velikost:
            <button id="fontDown" type="button">−</button>
            <button id="fontUp"   type="button">+</button>
          </span>
          <span class="kbd">Akordy:
            <button id="toggleChords" type="button" aria-label="Přepnout akordy">
              <span id="chordsIcon">✅</span>
            </button>
          </span>
          <span class="kbd">Sloupce:
  <button id="toggleCols" type="button" aria-label="Přepnout počet sloupců" aria-pressed="false">
    <span id="colsIcon">1</span>
  </button>
</span>

        </div>
      </div>

      <div id="view"></div>
    </div>
  </div>

<button id="autoScroll" class="auto-scroll" title="Auto posuv">∨</button>

<script>
const params = new URLSearchParams(location.search);
const id = params.get('id');
const plId = params.get('pl') || '';
const book = params.get('book') || '';

let song, SONGS_LIST=[], SONG_INDEX=-1;
let HIDE_CHORDS = localStorage.getItem('hideChords') === '1';
let justSwipedTs = 0;
let CHROME_HIDDEN = localStorage.getItem('chromeHidden') === '1';
if (CHROME_HIDDEN) document.body.classList.add('chrome-hidden');

/* --- Klíče nastavení --- */
let AUTO_BTN_VISIBLE = localStorage.getItem('autoBtnVisible') !== '0';
const AUTO_SPEED_KEY='zpj_autoSpeed';
const AUTO_DELAY_KEY='zpj_autoDelay';
const CHORD_COLOR_KEY='zpj_chordColor';
const CHORD_SCALE_KEY='zpj_chordScale';
const DEF_AUTO_SPEED = 10;      // px/s
const DEF_AUTO_DELAY = 10;      // s
const DEF_CHORD_COLOR = '#22c55e';
const DEF_CHORD_SCALE = 1.05;

/* --- Defaulty (požadováno) --- */
let AUTO_SPEED = parseFloat(localStorage.getItem(AUTO_SPEED_KEY));
if (isNaN(AUTO_SPEED)) AUTO_SPEED = 10;   // px/s
let AUTO_DELAY = parseFloat(localStorage.getItem(AUTO_DELAY_KEY));
if (isNaN(AUTO_DELAY)) AUTO_DELAY = 10;   // s

let CHORD_COLOR = localStorage.getItem(CHORD_COLOR_KEY) || getComputedStyle(document.documentElement).getPropertyValue('--chordColor').trim() || '#22c55e';
let CHORD_SCALE = parseFloat(localStorage.getItem(CHORD_SCALE_KEY));
if (isNaN(CHORD_SCALE)) CHORD_SCALE = 1.05; // poměr

/* aplikuj barvu/scale hned na start */
document.documentElement.style.setProperty('--chordColor', CHORD_COLOR);
document.documentElement.style.setProperty('--chordScale', String(CHORD_SCALE));

/* --- Auto scroll --- */
let autoRunning = false;
let _autoRaf = 0, _lastTs = 0, _autoDelayTO = 0;
function resolveScrollState(){
  const view = document.getElementById('view');
  const doc = document.scrollingElement || document.documentElement || document.body;

  const candidates = [];
  if (view){
    candidates.push({
      target: view,
      scrollTop: view.scrollTop || 0,
      max: Math.max((view.scrollHeight || 0) - (view.clientHeight || 0), 0),
      isDoc: false,
    });
  }
  if (doc){
    const docScrollTop = doc?.scrollTop ?? window.pageYOffset ?? document.body.scrollTop ?? 0;
    candidates.push({
      target: doc,
      scrollTop: docScrollTop,
      max: Math.max((doc?.scrollHeight || 0) - (doc?.clientHeight || window.innerHeight || 0), 0),
      isDoc: true,
    });
  }

  let best = null;
  for (const c of candidates){
    if (!best) { best = c; continue; }
    const diff = c.max - best.max;
    if (diff > 0.5 || (Math.abs(diff) <= 0.5 && c.scrollTop > best.scrollTop)){
      best = c;
    }
  }
  return best;
}
function setScrollTop(state, value){
  if (!state || !state.target) return;
  if (state.isDoc) {
    window.scrollTo({ top: value, behavior: 'auto' });
  } else {
    state.target.scrollTop = value;
  }
}

function updateAutoBtnVisibility(){
  const ico = document.getElementById('autoBtnIcon');
  const floater = document.getElementById('autoScroll');
  const toggle = document.getElementById('toggleAutoBtn');
  if (ico) ico.textContent = AUTO_BTN_VISIBLE ? '✅' : '❌';
 if (toggle) toggle.setAttribute('aria-pressed', AUTO_BTN_VISIBLE ? 'true' : 'false');
  if (floater){
    floater.classList.toggle('hidden', !AUTO_BTN_VISIBLE);
    floater.setAttribute('aria-hidden', AUTO_BTN_VISIBLE ? 'false' : 'true');
  }
}
function setAutoIcon(state){
  const btn = document.getElementById('autoScroll');
  if (!btn) return;
  if (state === 'running') btn.textContent = '■';
  else if (state === 'waiting') btn.textContent = '…';
  else btn.textContent = '∨';
}
function stopAutoScroll(){
  autoRunning = false;
  if(_autoRaf) cancelAnimationFrame(_autoRaf);
  _autoRaf = 0; _lastTs = 0;
  if(_autoDelayTO){ clearTimeout(_autoDelayTO); _autoDelayTO = 0; }
  setAutoIcon('idle');
}
function startAutoScroll(){
  if (autoRunning || _autoDelayTO) return;

  const begin = () => {
    autoRunning = true;
    _lastTs = 0;
    setAutoIcon('running');

    const tick = (ts) => {
      if (!autoRunning) return;

      if (!_lastTs) _lastTs = ts;
      const dt = (ts - _lastTs) / 1000;
      _lastTs = ts;

      const state = resolveScrollState();
      if (!state || state.max <= 0){
        stopAutoScroll();
        return;
      }

      if (state.scrollTop >= state.max - 1){
        stopAutoScroll();
        return;
      }

      const next = Math.min(state.max, state.scrollTop + AUTO_SPEED * dt);
      setScrollTop(state, next);

      _autoRaf = requestAnimationFrame(tick);
    };

    _autoRaf = requestAnimationFrame(tick);
  };

  const initial = resolveScrollState();
  if (!initial || initial.max <= 0) return;

  if (AUTO_DELAY > 0){
    setAutoIcon('waiting');
    _autoDelayTO = setTimeout(() => {
      _autoDelayTO = 0;
      begin();
    }, AUTO_DELAY * 1000);
  } else {
    begin();
  }
}



/* --- CZ noty + transpozice --- */
const NOTES_CZ = ['C','C#','D','D#','E','F','F#','G','G#','A','B','H'];
const ALT = { 'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','A#':'B','Bb':'B','Hb':'B','Cb':'H','B#':'C','H#':'C','E#':'F','Fb':'E' };
function normRoot(r){ return ALT[r] || r; }
function transposeNote(n, semi){ const up=n.toUpperCase(); const norm=normRoot(up); const i=NOTES_CZ.indexOf(norm); if(i<0) return n; return NOTES_CZ[(i+semi+120)%12]; }
function transposeChord(token, semi){
  const m = token.match(/^([A-Ha-h](?:#|b)?)(.*?)(?:\/([A-Ha-h](?:#|b)?)(.*))?$/);
  if (!m) return token;
  const rootT = transposeNote(m[1], semi);
  const bassT = m[3] ? transposeNote(m[3], semi) : null;
  return rootT + (m[2]||'') + (bassT?('/'+bassT):'') + (m[4]||'');
}

/* --- Parser + render --- */
function parseChordPro(text){
  const meta = {}, raw = text.replace(/\r/g,'').split('\n');
  const body=[]; for(const line of raw){ const m=line.match(/^\{(\w+)\s*:\s*(.*?)\s*\}$/); if(m){ meta[m[1].toLowerCase()]=m[2]; continue; } body.push(line); }
  while(body.length && !body[0].trim()) body.shift();
  while(body.length && !body[body.length-1].trim()) body.pop();
  const lines=[]; let prevEmpty=false;
  for(const l of body){ const empty=!l.trim(); if(empty && prevEmpty) continue; lines.push(l); prevEmpty=empty; }
  return { meta, lines };
}
function renderChordPro(text, transposeSemi=0){
  const {lines} = parseChordPro(text);
  const cont=document.createElement('div'); cont.className='cp';
  for(const raw of lines){
    if(!raw.trim()){ cont.appendChild(document.createElement('br')); continue; }
    const line=document.createElement('div'); line.className='line';
    let i=0, pending=null;
    while(i<raw.length){
      if(raw[i]=='['){
        const close=raw.indexOf(']', i+1);
        if(close!==-1){
          const token=raw.slice(i+1, close); i=close+1;
          if(i>=raw.length || raw[i]=='['){
            const seg=document.createElement('span'); seg.className='seg';
            const ch=document.createElement('span'); ch.className='ch'; ch.textContent=transposeChord(token, transposeSemi);
            const ly=document.createElement('span'); ly.className='ly'; ly.textContent=' ';
            seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg); pending=null; continue;
          }else{ pending=token; continue; }
        }
      }
      let j=i; while(j<raw.length && raw[j]!='[') j++;
      const lyr=raw.slice(i,j)||' ';
      const seg=document.createElement('span'); seg.className='seg';
      const ch=document.createElement('span'); ch.className='ch'; ch.textContent=pending?transposeChord(pending, transposeSemi):'';
      const ly=document.createElement('span'); ly.className='ly'; ly.textContent=lyr;
      seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg); pending=null; i=j;
    }
    if(pending){
      const seg=document.createElement('span'); seg.className='seg';
      const ch=document.createElement('span'); ch.className='ch'; ch.textContent=transposeChord(pending, transposeSemi);
      const ly=document.createElement('span'); ly.className='ly'; ly.textContent=' ';
      seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg);
    }
    cont.appendChild(line);
  }
  return cont;
}
const MIN_CHORD_GAP=4;
function fixChordOverlaps(root){
  const lines=root.querySelectorAll('.line');
  lines.forEach(line=>{
    line.querySelectorAll('.seg').forEach(seg=>{ seg.style.marginLeft=''; });
    let prevRight=-Infinity, lastTop=null;
    const chords=Array.from(line.querySelectorAll('.ch'));
    chords.forEach(ch=>{
      const seg=ch.parentElement, r=ch.getBoundingClientRect();
      if(lastTop!==null && (r.top-lastTop)>0.5){ prevRight=-Infinity; }
      lastTop=r.top;
      const needLeft=prevRight+MIN_CHORD_GAP, need=needLeft-r.left;
      if(need>0){ const cur=parseFloat(seg.style.marginLeft||'0'); seg.style.marginLeft=(cur+need)+'px'; const nr=ch.getBoundingClientRect(); prevRight=nr.right; }
      else { prevRight=r.right; }
    });
    const segs=Array.from(line.querySelectorAll('.seg'));
    if(segs.length){
      const rects=segs.map(s=>s.getBoundingClientRect());
      const firstLeft=Math.min(...rects.map(r=>r.left));
      const firstTop=Math.min(...rects.map(r=>r.top));
      const LEFT_TOL=16, TOP_TOL=0.5;
      segs.forEach((seg,i)=>{ const r=rects[i]; const startsNew=(r.top-firstTop)>TOP_TOL && (r.left-firstLeft)<LEFT_TOL; if(startsNew) seg.style.marginLeft='0px'; });
    }
  });
}

/* --- Layout helpers --- */
function relayoutChords(){ const cp=document.querySelector('#view .cp'); if(!cp) return; requestAnimationFrame(()=>fixChordOverlaps(cp)); }
function updateChromeHeight(){ const ch=document.getElementById('chrome'); const h=ch?ch.getBoundingClientRect().height:0; document.documentElement.style.setProperty('--chromeH',(h||0)+'px'); }
function setChromeHidden(h){ CHROME_HIDDEN=!!h; document.body.classList.toggle('chrome-hidden', CHROME_HIDDEN); localStorage.setItem('chromeHidden', CHROME_HIDDEN?'1':'0'); updateChromeHeight(); }

/* --- ovládání lišty + swipe --- */
function wireDoubleToggle(){
  const view=document.getElementById('view'); if(!view) return;
  let lastTapTime=0,lastX=0,lastY=0,recentToggleTs=0;
  view.addEventListener('dblclick', ()=>{ if(Date.now()-recentToggleTs<400) return; if(Date.now()-justSwipedTs<350) return; setChromeHidden(!document.body.classList.contains('chrome-hidden')); });
  view.addEventListener('touchend', (e)=>{
    if(e.touches&&e.touches.length) return;
    if(Date.now()-justSwipedTs<350) return;
    const t=Date.now(), touch=e.changedTouches[0], x=touch.clientX, y=touch.clientY;
    const withinTime = (t-lastTapTime)<300;
    const withinDist = Math.hypot(x-lastX,y-lastY)<30;
    if(withinTime && withinDist){ e.preventDefault(); setChromeHidden(!document.body.classList.contains('chrome-hidden')); recentToggleTs=t; lastTapTime=0; }
    else { lastTapTime=t; lastX=x; lastY=y; }
  }, {passive:false});
}
function wireSwipeNavigation(){
  const view=document.getElementById('view'); if(!view) return;
  let sx=0, sy=0, startTime=0;
  view.addEventListener('touchstart', (e)=>{ if(e.touches.length!==1) return; const t=e.touches[0]; sx=t.clientX; sy=t.clientY; startTime=Date.now(); }, {passive:true});
  view.addEventListener('touchend', (e)=>{
    if(!startTime) return;
    const t=e.changedTouches[0]; const dx=t.clientX-sx; const dy=t.clientY-sy; const dt=Date.now()-startTime;
    const ABSX=Math.abs(dx), ABSY=Math.abs(dy); const isSwipe=ABSX>70 && ABSY<60 && dt<600;
    if(isSwipe){ e.preventDefault(); justSwipedTs=Date.now(); if(dx<0) goNextSong(); else goPrevSong(); }
    startTime=0;
  }, {passive:false});
}
function goNextSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const next=(SONG_INDEX+1)%SONGS_LIST.length;
  const nxtId = SONGS_LIST[next];
 const extra = (plId ? `&pl=${encodeURIComponent(plId)}` : '') +
              (book ? `&book=${encodeURIComponent(book)}` : '');
  location.replace(`song.html?id=${encodeURIComponent(nxtId)}${extra}`);
}
function goPrevSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const prev=(SONG_INDEX-1+SONGS_LIST.length)%SONGS_LIST.length;
  const prvId = SONGS_LIST[prev];
 const extra = (plId ? `&pl=${encodeURIComponent(plId)}` : '') +
              (book ? `&book=${encodeURIComponent(book)}` : '');

  location.replace(`song.html?id=${encodeURIComponent(prvId)}${extra}`);
}

/* --- velikost textu napříč PWA --- */
const ZPJ_FONT_KEY = 'zpj-fontScale';

  function getScale(){
  const s = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--song-scale')) || 1;
  return s > 0 ? s : 1;
}
function setScale(s){
  const c = Math.min(3, Math.max(0.5, s));
  document.documentElement.style.setProperty('--song-scale', String(c));
  localStorage.setItem(ZPJ_FONT_KEY, String(c));
  relayoutChords();
}
/* --- sloupce (bez přepočtu velikosti) --- */
const ZPJ_COLS_KEY = 'zpj-cols'; // "1" nebo "2"
let COLS = parseInt(localStorage.getItem(ZPJ_COLS_KEY) || '1', 10);
if (![1,2].includes(COLS)) COLS = 1;

function updateColsIcon(){
  const ico = document.getElementById('colsIcon');
  const btn = document.getElementById('toggleCols');
  if (ico) ico.textContent = String(COLS);
  if (btn) btn.setAttribute('aria-pressed', COLS === 2 ? 'true' : 'false');
}

function applyColumns(){
  document.documentElement.style.setProperty('--col-count', String(COLS));
  updateColsIcon();
  relayoutChords();
}

 function getScale(){ const s=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--song-scale'))||1; return s>0?s:1; }
function setScale(s){
  const c = Math.min(3, Math.max(0.5, s));
  BASE_SCALE = c;
  AUTO_SCALE_ACTIVE = false;
  document.documentElement.style.setProperty('--song-scale', String(c));
  localStorage.setItem(ZPJ_FONT_KEY, String(c));
  relayoutChords();
}

function updateColsIcon(){
  const ico = document.getElementById('colsIcon');
  const btn = document.getElementById('toggleCols');
  if (ico) ico.textContent = String(COLS);
  if (btn) btn.setAttribute('aria-pressed', COLS === 2 ? 'true' : 'false');
}

function applyColumns(){
  document.documentElement.style.setProperty('--col-count', String(COLS));
  updateColsIcon();

  // když 1 sloupec, vrať base velikost (uživatelskou)
  if (COLS === 1){
    document.documentElement.style.setProperty('--song-scale', String(BASE_SCALE));
    AUTO_SCALE_ACTIVE = false;
    relayoutChords();
    return;
  }

}




async function load(){
  // 1) Načti seznam písní
  const data = await fetch('/zpjevnicek/data/songs.json', { cache:'no-store' })
                      .then(r=>r.json()).catch(()=>[]);

  // 2) Sestav pořadí pro swipe:
  //    - když je plId => pořadí z playlistu
  //    - jinak když je book => jen písně ze zvoleného zpěvníku, seřazené podle čísla ve zpěvníku
  //    - jinak všechny písně v pořadí z JSONu
  if (plId){
    const pls = JSON.parse(localStorage.getItem('zpj_playlists')||'[]');
    const pl = pls.find(p=>p.id===plId);
    SONGS_LIST = (pl && Array.isArray(pl.items) && pl.items.length)
      ? pl.items.slice()
      : data.map(s=>s.id);
  } else if (book){
    const filtered = data
      .filter(s => s.books && Object.prototype.hasOwnProperty.call(s.books, book))
      .sort((a,b) => (a.books?.[book] ?? 1e9) - (b.books?.[book] ?? 1e9));
    SONGS_LIST = filtered.map(s=>s.id);
    // pro návrat na index nech vybraný zpěvník i tam
    localStorage.setItem('zpj_book', book);
  } else {
    SONGS_LIST = data.map(s=>s.id);
  }
  SONG_INDEX = SONGS_LIST.indexOf(id);

  // 3) Najdi právě otevřenou píseň
  song = data.find(s=>s.id===id);
  if(!song){
    document.getElementById('title').textContent='Píseň nenalezena';
    return;
  }
  document.getElementById('title').textContent = `${song.number ?? '–'} · ${song.title}`;
  document.getElementById('meta').textContent = song.author || '';

  // 4) Zpět odkaz (playlist / zpěvník / hlavní seznam)
  const backLink = document.getElementById('backLink');
  if (plId){
    backLink.textContent = '← Zpět na playlist';
    backLink.onclick = (e)=>{ e.preventDefault(); location.href = '/zpjevnicek/index.html#pl:' + encodeURIComponent(plId); };
  } else if (book){
    backLink.textContent = '← Zpět na zpěvník';
    backLink.onclick = (e)=>{ e.preventDefault(); location.href = '/zpjevnicek/'; };
  } else {
    backLink.textContent = '← Zpět na seznam';
    backLink.onclick = (e)=>{ e.preventDefault(); if (document.referrer.includes('/zpjevnicek/')) history.back(); else location.href='/zpjevnicek/'; };
  }

  // 5) Render: ChordPro vs. AlphaTab
  if (song.type === 'chordpro' || /\.pro$|\.cho$/i.test(song.file)) {
    document.getElementById('controls-cp').style.display='flex';
    const text = await fetch(song.file).then(r=>r.text());
    let trans=0;
    const render = ()=>{
      const view=document.getElementById('view');
      const el=renderChordPro(text, trans);
      view.innerHTML=''; view.appendChild(el);
      requestAnimationFrame(()=>fixChordOverlaps(el));
      applyChordVisibility(); updateChromeHeight();
    };
    render();
    document.getElementById('up').onclick   = ()=>{ trans+=1; render(); };
    document.getElementById('down').onclick = ()=>{ trans-=1; render(); };

    let scale = getScale();
    document.getElementById('fontUp').onclick   = ()=>{ scale = Math.min(3,   +(scale + 0.1).toFixed(2)); setScale(scale); };
    document.getElementById('fontDown').onclick = ()=>{ scale = Math.max(0.5, +(scale - 0.1).toFixed(2)); setScale(scale); };

    document.getElementById('toggleChords').onclick = ()=>{
      HIDE_CHORDS = !HIDE_CHORDS;
      localStorage.setItem('hideChords', HIDE_CHORDS ? '1' : '0');
      applyChordVisibility(); relayoutChords();
    };
  } else {
    document.getElementById('controls-score').style.display='flex';
    const el=document.getElementById('view');
    const at=new alphaTab.AlphaTabApi(el, { file:song.file, player:{ enablePlayer:true }});
    document.getElementById('play').onclick = ()=> at.playPause();
    document.getElementById('stop').onclick = ()=> at.stop();
    document.getElementById('tempo').oninput = e=> at.playbackSpeed = e.target.value/100;
    at.renderFinished.on(()=> updateChromeHeight());
  }

  // 6) Auto-scroll: tlačítko + ikony
  const tgl = document.getElementById('toggleAutoBtn');
  if (tgl) tgl.onclick = ()=>{
    AUTO_BTN_VISIBLE = !AUTO_BTN_VISIBLE;
    localStorage.setItem('autoBtnVisible', AUTO_BTN_VISIBLE ? '1' : '0');
    if (!AUTO_BTN_VISIBLE && (autoRunning || _autoDelayTO)) stopAutoScroll();
    updateAutoBtnVisibility();
  };
  const autoBtn=document.getElementById('autoScroll');
  if (autoBtn) autoBtn.onclick=()=>{ if (autoRunning || _autoDelayTO) stopAutoScroll(); else startAutoScroll(); };
  updateAutoBtnVisibility();
  setAutoIcon('idle');

  
  // 6.5) Sloupce 1/2
  const colsBtn = document.getElementById('toggleCols');
  if (colsBtn) colsBtn.onclick = ()=>{
    COLS = (COLS === 1) ? 2 : 1;
    localStorage.setItem(ZPJ_COLS_KEY, String(COLS));
    applyColumns();
  };
  applyColumns();


  // 7) Panel nastavení – předvyplň + ulož/reset
  const btnSettings = document.getElementById('btnSettings');
  const panel = document.getElementById('settingsPanel');
  const speedInput = document.getElementById('speedInput');
  const delayInput = document.getElementById('delayInput');
  const chordColorInput = document.getElementById('chordColorInput');
  const chordScaleInput = document.getElementById('chordScaleInput');
  if (speedInput) speedInput.value = String(AUTO_SPEED);
  if (delayInput) delayInput.value = String(AUTO_DELAY);
  if (chordColorInput) chordColorInput.value = CHORD_COLOR;
  if (chordScaleInput) chordScaleInput.value = String(CHORD_SCALE);

  if (btnSettings && panel){
    btnSettings.addEventListener('click', ()=>{
      panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    });
    document.addEventListener('click', (e)=>{
      if (!panel.contains(e.target) && e.target !== btnSettings){
        panel.style.display = 'none';
      }
    });
  }

  document.getElementById('settingsSave')?.addEventListener('click', ()=>{
    const sp = Math.max(5, Math.min(300, Number(speedInput.value)||10));
    AUTO_SPEED = sp; localStorage.setItem(AUTO_SPEED_KEY, String(sp));

    const dl = Math.max(0, Math.min(30, Number(delayInput.value)||10));
    AUTO_DELAY = dl; localStorage.setItem(AUTO_DELAY_KEY, String(dl));

    const col = chordColorInput.value || '#22c55e';
    CHORD_COLOR = col;
    document.documentElement.style.setProperty('--chordColor', col);
    localStorage.setItem(CHORD_COLOR_KEY, col);

    let scl = parseFloat(chordScaleInput.value);
    if (isNaN(scl)) scl = 1.05;
    scl = Math.max(0.5, Math.min(2.5, scl));
    CHORD_SCALE = scl;
    document.documentElement.style.setProperty('--chordScale', String(scl));
    localStorage.setItem(CHORD_SCALE_KEY, String(scl));

    relayoutChords();
    panel.style.display = 'none';
  });

  document.getElementById('settingsReset')?.addEventListener('click', () => {
    if (speedInput)       speedInput.value       = String(DEF_AUTO_SPEED);
    if (delayInput)       delayInput.value       = String(DEF_AUTO_DELAY);
    if (chordColorInput)  chordColorInput.value  = DEF_CHORD_COLOR;
    if (chordScaleInput)  chordScaleInput.value  = String(DEF_CHORD_SCALE);

    AUTO_SPEED = DEF_AUTO_SPEED;
    localStorage.setItem(AUTO_SPEED_KEY, String(DEF_AUTO_SPEED));

    AUTO_DELAY = DEF_AUTO_DELAY;
    localStorage.setItem(AUTO_DELAY_KEY, String(DEF_AUTO_DELAY));

    CHORD_COLOR = DEF_CHORD_COLOR;
    document.documentElement.style.setProperty('--chordColor', DEF_CHORD_COLOR);
    localStorage.setItem(CHORD_COLOR_KEY, DEF_CHORD_COLOR);

    CHORD_SCALE = DEF_CHORD_SCALE;
    document.documentElement.style.setProperty('--chordScale', String(DEF_CHORD_SCALE));
    localStorage.setItem(CHORD_SCALE_KEY, String(DEF_CHORD_SCALE));

    relayoutChords();
    panel.style.display = 'none';
  });

  // 8) Ostatní drátování
  wireDoubleToggle();
  wireSwipeNavigation();
  updateChromeHeight();
}


function applyChordVisibility(){
  const cp=document.querySelector('#view .cp'); if(!cp) return;
  if (HIDE_CHORDS) cp.classList.add('nochords'); else cp.classList.remove('nochords');
  const ico=document.getElementById('chordsIcon'); if(ico) ico.textContent = HIDE_CHORDS ? '❌' : '✅';
}

/* --- resize/orientation --- */
let _resizeTO;
function onResizeReflow(){
  updateChromeHeight();
  relayoutChords();
}

window.addEventListener('resize', ()=>{ clearTimeout(_resizeTO); _resizeTO=setTimeout(onResizeReflow,120); });
window.addEventListener('orientationchange', ()=>{ setTimeout(onResizeReflow,150); });

/* --- SW --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' })
      .then(r => console.log('Zpjěvníček SW scope:', r.scope))
      .catch(console.error);
  });
}

/* --- globální scale --- */
(function applyGlobalSongScale(){
  const val = parseFloat(localStorage.getItem('zpj-fontScale'));
  if (!isNaN(val) && val > 0) document.documentElement.style.setProperty('--song-scale', String(val));
})();

/* --- HW tlačítko zpět --- */
window.addEventListener('popstate', (e) => {
  e.preventDefault();
  const backLink = document.getElementById('backLink');
  if (backLink) backLink.click();
  else location.href = plId ? '/zpjevnicek/index.html#pl:' + encodeURIComponent(plId) : '/zpjevnicek/';
});

load();
</script>
</body>
</html>
