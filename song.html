<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
  <title>Píseň</title>
  <link rel="stylesheet" href="assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zpjěvníček" />


  <script defer src="https://unpkg.com/@coderline/alphatab@latest/dist/alphaTab.min.js"></script>
  <style>
:root{
  --cpfs:20px;
  --chromeH:0px;
  --chordColor:#22c55e;
  --chordScale:1.05;

  /* ↓↓↓ nové „knoflíky“ pro svislé mezery */
  --cp-line:1.05;        /* bylo 1.9 – celkové řádkování textu */
  --cp-pad:0.85em;       /* bylo 1.15em – výška pro akord nad textem */
  --cp-pad-nochords:0.20em;
}

/* ChordPro render */
.cp{
  font-family:system-ui,Segoe UI,Arial,sans-serif;
  color:var(--ink);
  font-size:var(--cpfs);
  line-height:var(--cp-line);  /* ← používáme proměnnou */
}
.cp .line{ position:relative; white-space:pre-wrap }
.cp .seg{ position:relative; display:inline-block; padding-top:var(--cp-pad) } /* ← menší rezerva */
.cp .ch{
  position:absolute; left:0; top:0;
  font-weight:700;
  font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
  font-size:calc(1em * var(--chordScale));
  color:var(--chordColor);
}
.cp .ly{ visibility:visible }

/* režim bez akordů – ještě těsnější */
.cp.nochords .ch{ display:none }
.cp.nochords .seg{ padding-top:var(--cp-pad-nochords) }


    /* „plátno“ -> bez rámečku/pozadí (žádná bublina) */
    .sheet{ padding:0; background:transparent; border:none; box-shadow:none; }

 /* horní lišta – fixní, aby neměnila výšku stránky */
#chrome{
  position:fixed;           /* ⬅ bylo sticky */
  top:0; left:0; right:0;   /* přes celou šířku */
  z-index:5;
  background:var(--card);
  padding:12px 12px 8px;
  border-bottom:1px solid #192544;
  transition: transform .2s ease, opacity .2s ease;
}

/* když je lišta skrytá, jen ji odsuneme, ale layout se nemění */
body.chrome-hidden #chrome{
  transform: translateY(-110%);
  opacity: 0;
}

/* obsah stránky dostane horní padding = výška lišty (jen když je viditelná) */
body:not(.chrome-hidden) #view{
  padding-top: var(--chromeH);   /* výšku doplní JS */
}


    /* řádek s odkazem a tlačítkem v liště */
    .chrome-row{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
    }
    button.ghost{
      background:transparent; border:1px solid #2c3b60; border-radius:8px;
      padding:4px 8px; color:var(--ink); cursor:pointer;
    }
    button.ghost:hover{ background:#17213a; }

    /* skrytá lišta: nesmí zabírat místo */
    body.chrome-hidden #chrome{
      transform: translateY(-110%);
      opacity: 0;
      height: 0;
      padding: 0;
      margin: 0;
      border: 0;
      overflow: hidden;
    }

    /* kontejner s písní – výška = viewport - výška lišty */
    #view{
      height: calc(100vh - var(--chromeH));
      max-height: calc(100vh - var(--chromeH));
      overflow:auto;
      background:transparent;
      border:0; border-radius:0; box-shadow:none;
      padding:12px 4px 24px;
    }
    @media (max-width:640px){ #view{ padding-left:2px; padding-right:2px } }
  </style>
</head>
<body>
  <div class="container">
    <div class="sheet" style="margin-top:12px">
      <div id="chrome">
        <div class="chrome-row">
          <a id="backLink" href="index.html">← Zpět na seznam</a>
          <button id="toggleChrome" class="ghost" title="Skrýt / zobrazit lištu">▾</button>
        </div>

        <h2 id="title" style="margin:8px 0">Načítám…</h2>
        <div class="badge" id="meta"></div>

        <!-- Ovládání pro noty (alphaTab) -->
        <div id="controls-score" class="player" style="display:none">
          <button id="play">Přehrát</button>
          <button id="stop">Stop</button>
          <label>Tempo <input id="tempo" type="range" min="30" max="200" value="100"></label>
        </div>

        <!-- Ovládání pro ChordPro -->
        <div id="controls-cp" class="player" style="display:none">
          <span class="kbd">ChordPro</span>
          <button id="down">Transpose −</button>
          <button id="up">Transpose +</button>
          <label>Capo <input id="capo" type="number" min="0" max="11" value="0" style="width:4.5em"></label>
          <span class="kbd">Velikost:
            <button id="fontDown" type="button">−</button>
            <button id="fontUp"   type="button">+</button>
          </span>
          <button id="toggleChords" type="button">Skrýt akordy</button>
        </div>
      </div>

      <!-- TEXT PÍSNĚ – plná šířka -->
      <div id="view"></div>
    </div>
  </div>

<script>
const params = new URLSearchParams(location.search);
const id = params.get('id');
let song;

// uživatelský stav
let HIDE_CHORDS = localStorage.getItem('hideChords') === '1';
let SONGS_LIST = [];
let SONG_INDEX = -1;
let justSwipedTs = 0;

// akordové helpery
const NOTES_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const ALT = {'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
function normRoot(r){ return ALT[r] || r; }
function splitChord(ch){ const m = ch.match(/^([A-G](?:#|b)?)(.*)$/); return m ? {root:normRoot(m[1]), rest:m[2]} : {root:ch, rest:''}; }
function transposeChord(ch, s){ const sp=splitChord(ch), i=NOTES_SHARP.indexOf(sp.root); if(i<0) return ch; return NOTES_SHARP[(i+s+120)%12]+sp.rest; }

// parser ChordPro s odstraněním prázdných řádků kolem a sloučením vícenásobných mezer
function parseChordPro(text){
  const meta = {};
  const raw = text.replace(/\r/g, '').split('\n');
  const body = [];
  for (const line of raw) {
    const m = line.match(/^\{(\w+)\s*:\s*(.*?)\s*\}$/);
    if (m) { meta[m[1].toLowerCase()] = m[2]; continue; }
    body.push(line);
  }
  while (body.length && !body[0].trim()) body.shift();
  while (body.length && !body[body.length - 1].trim()) body.pop();
  const lines = [];
  let prevEmpty = false;
  for (const l of body) {
    const empty = !l.trim();
    if (empty && prevEmpty) continue;
    lines.push(l);
    prevEmpty = empty;
  }
  return { meta, lines };
}

function renderChordPro(text, transposeSemi=0, capo=0){
  const {lines} = parseChordPro(text); const rootTrans = transposeSemi - (capo|0);
  const cont=document.createElement('div'); cont.className='cp';
  for(const raw of lines){
    if(!raw.trim()){ cont.appendChild(document.createElement('br')); continue; }
    const line=document.createElement('div'); line.className='line';
    let i=0, cur=''; while(i<raw.length){
      if(raw[i]==='['){ const j=raw.indexOf(']', i+1); if(j!==-1){ cur=raw.slice(i+1,j); i=j+1; continue; } }
      let j=i; while(j<raw.length && raw[j]!=='[') j++;
      const lyr=raw.slice(i,j)||' ';
      const seg=document.createElement('span'); seg.className='seg';
      const ch=document.createElement('span'); ch.className='ch'; ch.textContent = cur ? transposeChord(cur, rootTrans) : '';
      const ly=document.createElement('span'); ly.className='ly'; ly.textContent = lyr;
      seg.appendChild(ch); seg.appendChild(ly); line.appendChild(seg); i=j;
    }
    cont.appendChild(line);
  }
  return cont;
}

function updateChromeHeight(){
  const ch = document.getElementById('chrome');
  const h = ch ? ch.getBoundingClientRect().height : 0;
  document.documentElement.style.setProperty('--chromeH', (h||0) + 'px');
}

function setChromeHidden(hidden){
  document.body.classList.toggle('chrome-hidden', hidden);
  // už nic neupravujeme – obsah má padding-top přes CSS, takže scroll zůstane
  updateChromeHeight(); // pro jistotu, kdyby se lišta výškou změnila (wrap řádků apod.)
}


/* ---- Dvoj-klik / dvoj-tap bez blikání ---- */
function wireDoubleToggle(){
  const view = document.getElementById('view');
  if (!view) return;

  let lastTapTime = 0, lastX = 0, lastY = 0;
  let recentToggleTs = 0;

  // PC: dblclick
  view.addEventListener('dblclick', ()=>{
    if (Date.now() - recentToggleTs < 400) return;
    if (Date.now() - justSwipedTs < 350) return;
    setChromeHidden(!document.body.classList.contains('chrome-hidden'));
  });

  // Mobil: double-tap na touchend
  view.addEventListener('touchend', (e)=>{
    if (e.touches && e.touches.length) return;
    if (Date.now() - justSwipedTs < 350) return;
    const t = Date.now();
    const touch = e.changedTouches[0];
    const x = touch.clientX, y = touch.clientY;
    const withinTime = (t - lastTapTime) < 300;
    const withinDist = Math.hypot(x - lastX, y - lastY) < 30;

    if (withinTime && withinDist) {
      e.preventDefault();
      setChromeHidden(!document.body.classList.contains('chrome-hidden'));
      recentToggleTs = t;
      lastTapTime = 0;
    } else {
      lastTapTime = t; lastX = x; lastY = y;
    }
  }, {passive:false});
}

/* ---- Skrývání akordů (persist v localStorage) ---- */
function applyChordVisibility() {
  const view = document.getElementById('view');
  const cp = view?.querySelector('.cp');
  if (!cp) return;
  if (HIDE_CHORDS) cp.classList.add('nochords');
  else cp.classList.remove('nochords');

  const btn = document.getElementById('toggleChords');
  if (btn) btn.textContent = HIDE_CHORDS ? 'Zobrazit akordy' : 'Skrýt akordy';
}

/* ---- Swipe navigace ---- */
function wireSwipeNavigation(){
  const view = document.getElementById('view');
  if (!view) return;

  let sx=0, sy=0, startTime=0;
  view.addEventListener('touchstart', (e)=>{
    if (e.touches.length !== 1) return; // ignoruj pinch
    const t = e.touches[0];
    sx = t.clientX; sy = t.clientY; startTime = Date.now();
  }, {passive:true});

  view.addEventListener('touchend', (e)=>{
    if (!startTime) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - sx;
    const dy = t.clientY - sy;
    const dt = Date.now() - startTime;

    const ABSX = Math.abs(dx), ABSY = Math.abs(dy);
    const isSwipe = ABSX > 70 && ABSY < 60 && dt < 600;
    if (isSwipe) {
      e.preventDefault();
      justSwipedTs = Date.now();
      if (dx < 0) goNextSong(); else goPrevSong();
    }
    startTime = 0;
  }, {passive:false});
}

function goNextSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const next = (SONG_INDEX + 1) % SONGS_LIST.length;
  location.href = `song.html?id=${encodeURIComponent(SONGS_LIST[next].id)}`;
}
function goPrevSong(){
  if (SONGS_LIST.length < 2 || SONG_INDEX < 0) return;
  const prev = (SONG_INDEX - 1 + SONGS_LIST.length) % SONGS_LIST.length;
  location.href = `song.html?id=${encodeURIComponent(SONGS_LIST[prev].id)}`;
}

async function load(){
  const data = await fetch('data/songs.json', {cache:'no-store'}).then(r=>r.json());
  SONGS_LIST = data;
  song = data.find(s => s.id === id);
  SONG_INDEX = data.findIndex(s => s.id === id);

  if(!song){ document.getElementById('title').textContent='Píseň nenalezena'; return; }
  document.getElementById('title').textContent = `${song.number ?? '–'} · ${song.title}`;
  document.getElementById('meta').textContent = song.author || '';

  if (song.type === 'chordpro' || /\.pro$|\.cho$/i.test(song.file)) {
    document.getElementById('controls-cp').style.display='flex';
    const text = await fetch(song.file).then(r=>r.text());
    let trans=0, capo=0;
    const render=()=>{
      const view=document.getElementById('view'); view.innerHTML=''; view.appendChild(renderChordPro(text,trans,capo));
      applyChordVisibility();
      updateChromeHeight();
    };
    render();

    document.getElementById('up').onclick   = ()=>{ trans+=1; render(); };
    document.getElementById('down').onclick = ()=>{ trans-=1; render(); };
    document.getElementById('capo').oninput = e=>{ capo=parseInt(e.target.value||0,10); render(); };

    // velikost textu
    const setFs=px=> document.documentElement.style.setProperty('--cpfs', px+'px');
    let fs=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cpfs'))||20;
    document.getElementById('fontUp').onclick   = ()=>{ fs=Math.min(72,fs+2); setFs(fs); };
    document.getElementById('fontDown').onclick = ()=>{ fs=Math.max(12,fs-2); setFs(fs); };

    // skrýt/zobrazit akordy (persist)
    document.getElementById('toggleChords').onclick = ()=>{
      HIDE_CHORDS = !HIDE_CHORDS;
      localStorage.setItem('hideChords', HIDE_CHORDS ? '1' : '0');
      applyChordVisibility();
    };

  } else {
    document.getElementById('controls-score').style.display='flex';
    const el=document.getElementById('view');
    const at=new alphaTab.AlphaTabApi(el, { file:song.file, player:{ enablePlayer:true }});
    document.getElementById('play').onclick = ()=> at.playPause();
    document.getElementById('stop').onclick = ()=> at.stop();
    document.getElementById('tempo').oninput = e=> at.playbackSpeed = e.target.value/100;
    at.renderFinished.on(()=> updateChromeHeight());
  }

  wireDoubleToggle();
  wireSwipeNavigation();
  updateChromeHeight();

  // PC tlačítko pro přepínání lišty
  const toggleBtn = document.getElementById('toggleChrome');
  if (toggleBtn) toggleBtn.onclick = ()=> setChromeHidden(!document.body.classList.contains('chrome-hidden'));
}
load();

window.addEventListener('resize', updateChromeHeight);
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' })
        .then(r => console.log('Zpjěvníček SW scope:', r.scope))
        .catch(console.error);
    });
  }
</script>


</body>
</html>
