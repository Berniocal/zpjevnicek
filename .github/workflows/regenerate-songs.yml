name: Regenerate songs.json

on:
  workflow_dispatch: {}          # ruční spuštění z GitHubu
  push:
    paths:                       # automaticky při změně písní/indexeru
      - 'songs/**/*.pro'
      - 'songs/*.pro'
      - 'scripts/indexer.js'
      - 'zpjevnicek/admin.html'
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: write                # dovolí workflow zapisovat do repa

concurrency:
  group: songs-index             # brání kolizím více běhů zároveň
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0         # potřebujeme historii kvůli rebase

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (if needed)
        run: |
          if [ -f package-lock.json ]; then
            npm ci --no-audit --fund=false
          elif [ -f package.json ]; then
            npm i --no-audit --fund=false
          else
            echo "No package.json found; skipping install."
          fi

      - name: Run indexer (generate data/songs.json)
        run: |
          if [ -f scripts/indexer.js ]; then
            node scripts/indexer.js
          else
            echo "ERROR: scripts/indexer.js not found. Add your indexer or adjust this step."
            exit 1
          fi

      - name: Commit & push (rebase + retry)
        run: |
          set -e

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Nic se nezměnilo? Klidně skonči.
          if git diff --quiet; then
            echo "No changes in working tree."
            exit 0
          fi

          git add -A
          git commit -m "chore: rebuild songs index"

          # Až 3 pokusy: stáhni vzdálený main, rebase a pushni s ochranou
          n=0
          until [ $n -ge 3 ]
          do
            git fetch origin main
            # Pull s rebase, aby se předešlo non-fast-forward
            git pull --rebase origin main || true
            if git push --force-with-lease origin HEAD:main; then
              echo "Pushed successfully."
              exit 0
            fi
            n=$((n+1))
            echo "Push failed, retry $n/3 in 2s…"
            sleep 2
          done

          echo "Failed to push after retries."
          exit 1
