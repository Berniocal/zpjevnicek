<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zpjƒõvn√≠ƒçek</title>

<link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zpjƒõvn√≠ƒçek" />

<style>
  /* Odsazen√≠ + ≈°√≠≈ôka */
  .container{ max-width:min(1200px,96vw); padding-left:2px; padding-right:2px; margin:0 auto; }

  /* --- Vyrovnan√© mezery mezi p√≠smeny v logu --- */
  .logo{ display:flex; align-items:baseline; gap:0.03em; flex-wrap:nowrap; }
  .logo span{ display:inline-block; letter-spacing:0; margin:0; padding:0; }
  .h√°ƒçek{ display:inline-block; transform:translateY(0.5em); font-weight:1000; font-size:4em; }

  /* Bez ‚Äûbubliny‚Äú kolem seznamu */
  .card{ background:transparent!important; border:0!important; box-shadow:none!important; padding:0!important; margin:0!important; }
  .card .sep{ display:none!important; }

  /* Layout polo≈æek seznamu + ellipsy */
  #list{ margin:0; padding:0; list-style:none; }
  .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid #1f2b46; }
  .item .meta{ display:flex; align-items:center; gap:10px; min-width:0; flex:1; }
  .item .meta .badge:first-child{
    width:38px; min-width:38px; height:38px; border-radius:999px;
    display:inline-flex; align-items:center; justify-content:center; padding:0;
    font-variant-numeric: tabular-nums;
  }
  .item .meta .title{ display:block; flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .item > .badge{ max-width:40%; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .controls{ margin:8px 0 10px; display:flex; gap:10px; flex-wrap:wrap; }
  .controls input{ flex:1; min-width:220px; }

  /* Views */
  .view{ display:none; }
  .view.active{ display:block; }

  /* Playlist list */
  #plList{ list-style:none; margin:0; padding:0; }
  .pl-item{ display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #1f2b46; gap:8px; }
  .pl-item .name{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* Playlist detail */
  #plDetailList{ list-style:none; margin:0; padding:0; }
  .pl-song{ display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid #1f2b46; }
  .pl-song .grip{ cursor:grab; user-select:none; }
  .pl-song .title{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  .fab{
    position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px;
    display:flex; align-items:center; justify-content:center; border:2px solid #2c3b60; background:transparent; color:var(--ink); z-index:5;
  }
  dialog{ border:1px solid #1f2b46; border-radius:12px; background:var(--card); color:var(--ink); }
  dialog::backdrop{ background:rgba(0,0,0,.4); }
</style>
</head>
<body>
  <script>
(function () {
  const PASSWORD = "hutisko"; // ‚Üê zmƒõ≈à heslo
  const KEY = "zpevnik_access_granted";

  // Zabra≈à zobrazen√≠ obsahu, dokud se nerozhodne
  document.documentElement.style.display = "none";

  function deny() {
    document.documentElement.innerHTML = `
      <head><title>P≈ô√≠stup odep≈ôen</title></head>
      <body style="font-family:sans-serif;text-align:center;padding:2rem">
        <h2>P≈ô√≠stup odep≈ôen</h2>
        <p>Tento zpƒõvn√≠k je urƒçen pouze pro uzav≈ôenou skupinu.</p>
      </body>`;
    document.documentElement.style.display = "block";
    throw new Error("Access denied");
  }

  // u≈æ jednou ovƒõ≈ôen√Ω p≈ô√≠stup
  if (localStorage.getItem(KEY) === "yes") {
    document.documentElement.style.display = "block";
    return;
  }

  const entered = prompt("Zadej heslo pro p≈ô√≠stup ke zpƒõvn√≠ƒçku:");

  if (entered === null || entered !== PASSWORD) {
    deny();
  }

  // spr√°vn√© heslo
  localStorage.setItem(KEY, "yes");
  document.documentElement.style.display = "block";
})();
</script>

<div class="container">
  <div class="header">
    <div class="brand">
      <h1 class="logo">
        <span class="w">Z</span><span class="w">p</span><span class="gray">j</span>
        <span class="e"><span class="gray">e</span><span class="w h√°ƒçek">Àá</span></span>
        <span class="w">v</span><span class="gray">n√≠ƒçek</span>
      </h1>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <input id="q" placeholder="Hledat n√°zev / autor / ƒç√≠slo‚Ä¶" />
      <select id="sort">
        <option value="number">≈òadit podle ƒç√≠sla</option>
        <option value="title">≈òadit podle abecedy</option>
        <option value="author">≈òadit podle autora</option>
      </select>

      <!-- NOV√â: v√Ωbƒõr zpƒõvn√≠ku (nativn√≠ select) -->
      <select id="book">
        <option value="">V≈°echno</option>
      </select>

      <button id="btnPlaylists">Playlisty</button>
      <button id="btnShare" title="Sd√≠len√≠ ovl√°d√°n√≠ (host / p≈ôipojit se)">Sd√≠len√≠</button>
    </div>

    <!-- view: hlavn√≠ seznam -->
    <div id="vMain" class="view active">
      <ul id="list"></ul>
      <div id="empty" class="empty" style="display:none">Zat√≠m tu nic nen√≠. Nahraj soubory do slo≈æky <code>/songs</code>.</div>
    </div>

    <!-- view: seznam playlist≈Ø -->
    <div id="vPl" class="view">
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0 10px">
        <button id="backToMain">‚Üê Zpƒõt na seznam</button>
        <button id="btnImportPl">Importovat playlist (odkaz/JSON)</button>
        <span style="flex:1"></span>
        <button id="btnNewPl">+ Nov√Ω playlist</button>
      </div>
      <ul id="plList"></ul>
    </div>

    <!-- view: detail playlistu -->
    <div id="vPlDetail" class="view">
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0 10px">
        <button id="backToPlaylists">‚Üê Zpƒõt na playlisty</button>
        <strong id="plTitle" style="flex:1">Playlist</strong>
        <button id="plShare">Sd√≠let playlist</button>
      </div>
      <ul id="plDetailList"></ul>
      <button id="addToPl" class="fab" title="P≈ôidat p√≠se≈à">+</button>
    </div>
  </div>

  <div class="footer">üé∏ GitHub Pages ¬∑ alphaTab</div>
</div>

<!-- Dialog p≈ôid√°n√≠ p√≠snƒõ do playlistu -->
<dialog id="dlgAdd">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px">
    <strong>P≈ôidat p√≠se≈à</strong>
    <button id="dlgAddClose">Zav≈ô√≠t</button>
  </div>
  <input id="addQuery" placeholder="N√°zev / autor / ƒç√≠slo‚Ä¶" style="width:100%;margin-bottom:8px" />
  <ul id="addResults" style="list-style:none;margin:0;padding:0;max-height:50vh;overflow:auto"></ul>
</dialog>

<!-- Dialog pro SD√çLEN√ç (host/p≈ôipojit) -->
<dialog id="dlgShare">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
    <strong id="shareTitle">Sd√≠len√≠</strong>
    <button id="dlgShareClose">Zav≈ô√≠t</button>
  </div>

  <div id="shareBody">
    <div style="display:grid;gap:10px">
      <label style="display:grid;gap:6px">P≈ôezd√≠vka
        <input id="shareNick" placeholder="T≈ôeba Jenda" autocomplete="nickname" />
      </label>
      <label style="display:grid;gap:6px">Pƒõtiƒç√≠seln√Ω k√≥d
        <input id="shareCode" inputmode="numeric" pattern="[0-9]*" placeholder="12345" maxlength="5" />
      </label>
      <button id="shareJoin" style="width:100%">Vytvo≈ôit / p≈ôihl√°sit</button>
      <div id="shareMsg" class="badge" style="display:none"></div>
    </div>

    <hr class="sep" />

    <div id="hostPanel" style="display:none">
      <div class="badge" style="margin-bottom:8px">Jsi <strong>hlavn√≠</strong>. P≈ô√≠choz√≠ ≈æ√°dosti mus√≠≈° potvrdit.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button id="hostStop">Zru≈°it sd√≠len√≠ (odpojit v≈°echny)</button>
        <button id="hostRefresh">Obnovit seznam</button>
      </div>
      <div style="font-weight:600;margin:6px 0">P≈ôipojen√≠</div>
      <ul id="hostMembers" style="list-style:none;margin:0;padding:0;max-height:50vh;overflow:auto"></ul>
    </div>

    <div id="clientPanel" style="display:none">
      <div id="clientState" class="badge" style="margin-bottom:10px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="clientPause">Pauznout</button>
        <button id="clientResume">Obnovit</button>
        <button id="clientLeave">Odpojit se</button>
      </div>
    </div>
  </div>
</dialog>

<script>
/* ------- data + stav ------- */
const list = document.getElementById('list');
const q = document.getElementById('q');
const sort = document.getElementById('sort');
const bookSel = document.getElementById('book');
const empty = document.getElementById('empty');
const V_MAIN = document.getElementById('vMain');
const V_PL = document.getElementById('vPl');
const V_DETAIL = document.getElementById('vPlDetail');
const HEADER = document.querySelector('.header');
const CTRLS  = document.querySelector('.controls');


let songs = [];
let playlists = [];   // [{id, name, items:[songId,...]}]
let CUR_PL = null;

/* ------- utils ------- */
function show(v){
  for (const el of [V_MAIN, V_PL, V_DETAIL]) el.classList.remove('active');
  v.classList.add('active');
  // hlaviƒçka + ovladaƒçe jen na hlavn√≠ str√°nce
  const onMain = (v === V_MAIN);
  if (HEADER) HEADER.style.display = onMain ? '' : 'none';
  if (CTRLS)  CTRLS.style.display  = onMain ? '' : 'none';
}
function savePlaylists(){ localStorage.setItem('zpj_playlists', JSON.stringify(playlists)); }
function loadPlaylists(){ playlists = JSON.parse(localStorage.getItem('zpj_playlists')||'[]'); }
function byId(id){ return songs.find(s=>s.id===id); }
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ------- smƒõrov√°n√≠ podle hash ------- */
function openPlaylistById(id){
  CUR_PL = playlists.find(p=>p.id===id);
  if(!CUR_PL){ location.hash = 'playlists'; return; }
  renderPlaylistDetail();
  show(V_DETAIL);
}
function handleHash(){
  const h = (location.hash || '').slice(1);
  if (h.startsWith('pl:')) { openPlaylistById(decodeURIComponent(h.slice(3))); return; }
  if (h === 'playlists')   { show(V_PL); return; }
  show(V_MAIN);
}
window.addEventListener('hashchange', handleHash);

/* --- Import z hash #import=... --- */
function b64encodeUtf8(str){ return btoa(unescape(encodeURIComponent(str))); }
function b64decodeUtf8(b64){ return decodeURIComponent(escape(atob(b64))); }
function tryImportFromHash(){
  const h = (location.hash || '');
  if (!h.startsWith('#import=')) return false;
  const payload = h.slice(8);
  try{
    const json = b64decodeUtf8(decodeURIComponent(payload));
    const data = JSON.parse(json);
    if (!data || !data.id || !data.name || !Array.isArray(data.items)) throw 0;

    if (confirm(`Importovat playlist ‚Äû${data.name}‚Äú?`)) {
      playlists = playlists.filter(p=>p.id!==data.id).concat([data]);
      savePlaylists(); renderPlaylistList();
      location.hash = 'pl:'+encodeURIComponent(data.id);
      // hash s importem vyƒçisti (a≈• se neopakuje)
      history.replaceState(null, '', location.pathname + location.search + location.hash);
    }
    return true;
  }catch(e){
    alert('Nelze naƒç√≠st odkaz s playlistem.');
    return false;
  }
}

/* ------- naƒçten√≠ p√≠sn√≠ ------- */
async function load(){
  try{
    const res = await fetch('/zpjevnicek/data/songs.json', { cache: 'no-store' });
    songs = await res.json();


  }catch(e){ songs = []; }
  renderMain();
  loadPlaylists();
  renderPlaylistList();
  buildBookSelect();          // napl≈à select se zpƒõvn√≠ky
  // v≈ædy po naƒçten√≠ nastav ‚ÄûV≈°echny‚Äú
  if (bookSel) {
    bookSel.value = '';
    bookSel.addEventListener('change', renderMain);
  }



  // 1) import p≈ôes odkaz
  if (tryImportFromHash()) return;

  // 2) vyhodno≈• hash (hlavn√≠ / playlists / pl:<id>)
  handleHash();
}

/* ------- naplnƒõn√≠ selectu ‚ÄûZpƒõvn√≠ky‚Äú ------- */
function buildBookSelect(){
  if (!bookSel) return;
  const set = new Set();
  songs.forEach(s => {
    if (s && s.books && typeof s.books === 'object'){
      Object.keys(s.books).forEach(name => set.add(name));
    }
  });
  const options = [
    `<option value="">V≈°echny</option>`,
    ...Array.from(set).sort((a,b)=>a.localeCompare(b, 'cs')).map(name =>
      `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`
    )
  ];
  bookSel.innerHTML = options.join('');
}


/* ------- hlavn√≠ seznam ------- */
function renderMain(){
  const term = q.value.trim().toLowerCase();
  const srt  = sort.value;
  const selectedBook = bookSel ? bookSel.value : '';

  let data = songs.filter(s =>
    s.title.toLowerCase().includes(term) ||
    (s.author||'').toLowerCase().includes(term) ||
    String(s.number||'').includes(term) ||
    (selectedBook && s.books && String(s.books[selectedBook]||'').includes(term))
  );

  if (selectedBook){
    data = data.filter(s => s.books && Object.prototype.hasOwnProperty.call(s.books, selectedBook));
    data.sort((a,b)=>{
      const an = a.books?.[selectedBook] ?? 1e9;
      const bn = b.books?.[selectedBook] ?? 1e9;
      if (an !== bn) return an - bn;
      return (a.title).localeCompare(b.title);
    });
  } else {
    data.sort((a,b)=>{
      if(srt==='number') return (a.number??99999)-(b.number??99999) || a.title.localeCompare(b.title);
      if(srt==='author') return (a.author||'').localeCompare(b.author||'') || a.title.localeCompare(b.title);
      return a.title.localeCompare(b.title);
    });
  }

  list.innerHTML = data.map(s => {
      const badgeNum = selectedBook
    ? (s.books?.[selectedBook] ?? '‚Äì')
    : (s.number ?? '‚Äì');
const href = selectedBook
  ? `/zpjevnicek/song.html?id=${encodeURIComponent(s.id)}&book=${encodeURIComponent(selectedBook)}`
  : `/zpjevnicek/song.html?id=${encodeURIComponent(s.id)}`;

return `
  <li class="item">
    <div class="meta">
      <span class="badge">${badgeNum}</span>
      <a class="title" href="${href}">${s.title}</a>
    </div>
    <div class="badge">${s.author || ''}</div>
  </li>`;

  }).join('');



  empty.style.display = data.length ? 'none' : 'block';
}

/* ------- playlisty ‚Äì seznam ------- */
function renderPlaylistList(){
  const ul = document.getElementById('plList');
  ul.innerHTML = playlists.map(p => `
    <li class="pl-item">
      <a class="name" data-open="${p.id}" href="#">${p.name}</a>
      <button data-del="${p.id}" title="Smazat">üóë</button>
    </li>
  `).join('');

  ul.querySelectorAll('[data-open]').forEach(a=>{
    a.addEventListener('click', (e)=>{ e.preventDefault(); location.hash = 'pl:'+encodeURIComponent(a.dataset.open); });
  });
  ul.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=btn.dataset.del;
      if(!confirm('Smazat playlist?')) return;
      playlists = playlists.filter(p=>p.id!==id);
      savePlaylists(); renderPlaylistList();
    });
  });
}

/* ------- playlist ‚Äì detail ------- */
function renderPlaylistDetail(){
  document.getElementById('plTitle').textContent = CUR_PL?.name || 'Playlist';
  const ul = document.getElementById('plDetailList');

  ul.innerHTML = (CUR_PL?.items || []).map((sid, idx) => {
    const s = byId(sid) || { title: '(chyb√≠)', author: '', number: '‚Äì' };
    return `<li class="pl-song" draggable="true" data-idx="${idx}">
      <span class="grip">‚â°</span>
      <a class="title" href="/zpjevnicek/song.html?id=${encodeURIComponent(sid)}&pl=${encodeURIComponent(CUR_PL.id)}">${s.number ?? '‚Äì'} ¬∑ ${s.title}</a>
      <small>${s.author || ''}</small>
      <button data-rm="${idx}" title="Odebrat">‚úñ</button>
    </li>`;
  }).join('');

  // drag & drop po≈ôad√≠
  let dragIdx = -1;
  ul.querySelectorAll('.pl-song').forEach(li => {
    li.addEventListener('dragstart', () => { dragIdx = +li.dataset.idx; li.classList.add('drag'); });
    li.addEventListener('dragend',   () => { li.classList.remove('drag'); });
    li.addEventListener('dragover',  (e) => e.preventDefault());
    li.addEventListener('drop', (e) => {
      e.preventDefault();
      const to = +li.dataset.idx;
      if (dragIdx === to) return;
      const x = CUR_PL.items.splice(dragIdx, 1)[0];
      CUR_PL.items.splice(to, 0, x);
      savePlaylists(); renderPlaylistDetail();
    });
  });

  // odebrat p√≠se≈à z playlistu
  ul.querySelectorAll('[data-rm]').forEach(btn => {
    btn.onclick = () => {
      const i = +btn.dataset.rm;
      CUR_PL.items.splice(i, 1);
      savePlaylists(); renderPlaylistDetail();
    };
  });

  // share button handler
  document.getElementById('plShare').onclick = ()=> sharePlaylistLink(CUR_PL.id);
}

/* ------- nov√Ω playlist ------- */
document.getElementById('btnNewPl').onclick = ()=>{
  const name = prompt('N√°zev playlistu:');
  if(!name) return;
  const id = 'pl_' + Math.random().toString(36).slice(2,9);
  playlists.push({ id, name, items: [] });
  savePlaylists(); renderPlaylistList();
  location.hash = 'pl:'+encodeURIComponent(id);
};

/* ------- P≈ôidat p√≠se≈à do playlistu ------- */
const dlgAdd = document.getElementById('dlgAdd');
document.getElementById('addToPl').onclick = ()=>{ if(!CUR_PL) return; dlgAdd.showModal(); renderAddResults(''); document.getElementById('addQuery').value=''; document.getElementById('addQuery').focus(); };
document.getElementById('dlgAddClose').onclick = ()=> dlgAdd.close();
document.getElementById('addQuery').addEventListener('input', e=> renderAddResults(e.target.value));

function renderAddResults(term){
  term = (term || '').toLowerCase();
  const ul = document.getElementById('addResults');
  const data = songs.filter(s =>
    s.title.toLowerCase().includes(term) ||
    (s.author || '').toLowerCase().includes(term) ||
    String(s.number || '').includes(term)
  ).slice(0, 50);

  ul.innerHTML = data.map(s => {
    const already = (CUR_PL?.items || []).includes(s.id);
    return `<li style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #1f2b46">
      <span class="badge" style="width:38px;height:38px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center">${s.number ?? '‚Äì'}</span>
      <div style="flex:1;min-width:0">
        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.title}</div>
        <small>${s.author || ''}</small>
      </div>
      <button data-add="${s.id}" ${already ? 'disabled' : ''}>${already ? 'P≈ôid√°no' : 'P≈ôidat'}</button>
    </li>`;
  }).join('');

  ul.querySelectorAll('[data-add]').forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.add;
      if (!CUR_PL) return;
      if (!CUR_PL.items.includes(id)) {
        CUR_PL.items.push(id);
        savePlaylists();
        renderPlaylistDetail();
      }
      btn.textContent = 'P≈ôid√°no';
      btn.disabled = true;
      document.getElementById('addQuery')?.focus();
    };
  });
}

/* ------- Sd√≠len√≠ playlistu p≈ôes ODKAZ ------- */
async function sharePlaylistLink(id){
  const pl = playlists.find(p=>p.id===id); if(!pl) return;
  const payload = b64encodeUtf8(JSON.stringify(pl));
  const url = `${location.origin}/zpjevnicek/#import=${encodeURIComponent(payload)}`;

  try{
    if (navigator.share && /https?:/.test(location.protocol)) {
      await navigator.share({ title: `Playlist: ${pl.name}`, text: `Otev≈ôi ve Zpjƒõvn√≠ƒçku:`, url });
      return;
    }
  }catch(_){}

  try{
    await navigator.clipboard.writeText(url);
    alert('Odkaz na playlist byl zkop√≠rov√°n do schr√°nky.');
  }catch(e){
    prompt('Zkop√≠ruj odkaz na playlist:', url);
  }
}

/* ------- Import playlistu (odkaz/JSON) ------- */
document.getElementById('btnImportPl').onclick = async ()=>{
  if (tryImportFromHash()) return;
  const raw = prompt('Vlo≈æ odkaz (#import=...) nebo JSON playlistu:');
  if(!raw) return;

  if (raw.includes('#import=')) { location.href = raw; return; }

  try{
    const data = JSON.parse(raw);
    if (!data || !data.id) throw 0;
    playlists = playlists.filter(p=>p.id!==data.id).concat([data]);
    savePlaylists(); renderPlaylistList();
    location.hash = 'pl:'+encodeURIComponent(data.id);
  }catch(_){
    alert('Neplatn√Ω obsah. Vlo≈æ funkƒçn√≠ odkaz nebo JSON playlistu.');
  }
};

/* ------- navigace mezi views ------- */
document.getElementById('btnPlaylists').onclick = ()=>{ location.hash='playlists'; };
document.getElementById('backToMain').onclick = ()=> history.back();        // seznam playlist≈Ø -> hlavn√≠
document.getElementById('backToPlaylists').onclick = ()=> history.back();   // detail -> seznam playlist≈Ø

/* ------- filtry ------- */
q.addEventListener('input', renderMain);
sort.addEventListener('change', renderMain);

/* ------- SW + auto-update ------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' });
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        if (!sw) return;
        sw.addEventListener('statechange', () => {
          if (sw.state === 'installed' && navigator.serviceWorker.controller) {
            sw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return; refreshing = true; window.location.reload();
      });
      setInterval(() => reg.update().catch(()=>{}), 60*60*1000);
    } catch (e) { console.error(e); }
  });
}

/* ------- Prefetch p√≠sn√≠ p≈ôi dobr√©m p≈ôipojen√≠ ------- */
function goodConnection(){
  const c = navigator.connection || navigator.webkitConnection || navigator.mozConnection;
  if (!c) return true;
  if (c.saveData) return false;
  const ok = ['wifi','ethernet','unknown'];
  return ok.includes(c.type) || (c.effectiveType||'').includes('4g');
}
async function prefetchAllSongs(){
  if (!navigator.onLine) return;
  if (!goodConnection()) return;
  try{
    const reg = await navigator.serviceWorker.getRegistration('/zpjevnicek/');
    if (reg && reg.active) reg.active.postMessage({ type: 'CACHE_ALL_SONGS', chunkSize: 6, reportProgress: false });
  }catch(e){}
}
window.addEventListener('load', prefetchAllSongs);
setInterval(prefetchAllSongs, 30*60*1000);

/* ------- glob√°ln√≠ scale pro song.html ------- */
const ZPJ_FONT_KEY = 'zpj-fontScale';
(function applyGlobalSongScale(){
  const val = parseFloat(localStorage.getItem(ZPJ_FONT_KEY));
  if (!isNaN(val) && val > 0) {
    document.documentElement.style.setProperty('--song-scale', String(val));
  }
})();
load();
</script>

<!-- ======================== SD√çLEN√ç OV√ÅD√ÅN√ç (Firebase) ========================
  Pozn.: Dopl≈à si FIREBASE_CONFIG n√≠≈æe (z Firebase Console ‚Üí Project settings ‚Üí Web app).
  Bez toho bude tlaƒç√≠tko ‚ÄûSd√≠len√≠‚Äú fungovat jen jako UI (a zobraz√≠ chybu).
============================================================================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import {
  getDatabase, ref, set, update, onValue, onDisconnect, off
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";



  // 1) VLO≈Ω SV≈ÆJ KONFIG (Firebase Console ‚Üí Project settings ‚Üí Your apps ‚Üí Config)
  //    Tip: nech to v JS jako objekt, nic neobaluj uvozovkami nav√≠c.
  const FIREBASE_CONFIG = window.FIREBASE_CONFIG || {
   apiKey: "AIzaSyCwukp1IylOurKvEsKc7uCnyUJLoCtWI2o",
    authDomain: "zpjevnicek.firebaseapp.com",
    projectId: "zpjevnicek",
    storageBucket: "zpjevnicek.firebasestorage.app",
    messagingSenderId: "842022440214",
    appId: "1:842022440214:web:0dbddb0a435c3cd9705437",
    measurementId: "G-HJ5NNLMJKR"
  };

  const HAS_CONFIG = !!(FIREBASE_CONFIG && FIREBASE_CONFIG.projectId);

  const app = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db = getDatabase(app);

let uid = null;

async function ensureAuth(){
  // p≈ôihl√°s√≠ anonymnƒõ, pokud je≈°tƒõ nejsi
  if (!auth.currentUser){
    await signInAnonymously(auth);
  }
  uid = auth.currentUser.uid;
  return uid;
}
async function joinSession(code, name = "") {
  await ensureAuth();

  const meRef = ref(db, `zpevnikShare/${code}/members/${uid}`);

  // Oznaƒç jako online
  await set(meRef, {
    name,
    online: true,
    lastSeen: Date.now()
  });

  // P≈ôi odpojen√≠ automaticky nastav offline
  await onDisconnect(meRef).update({
    online: false,
    lastSeen: Date.now()
  });
}

let stopCurrent = null;

async function listenCurrent(code) {
  await ensureAuth();

  const curRef = ref(db, `zpevnikShare/${code}/current`);

  // Ulo≈æ√≠me si callback, abychom ho mohli odpojit
  const cb = (snap) => {
    const cur = snap.val();
    if (!cur || !cur.path) return;

    const here = location.pathname + location.search;

    // cur.path ukl√°dej jako stejn√© "pathname+search"
    // Nap≈ô. "/zpjevnicek/song.html?id=123"
    if (here !== cur.path) {
      location.href = cur.path;
    }
  };

onValue(curRef, cb);
stopCurrent = () => off(curRef, "value", cb);
 // <- tohle funguje jen v compat API; proto n√≠≈æe d√°v√°m spr√°vnou v10 variantu
  };
}


  // --- UI prvky ---
  const btnShare = document.getElementById('btnShare');
  const dlgShare = document.getElementById('dlgShare');
  const dlgShareClose = document.getElementById('dlgShareClose');
  const shareJoin = document.getElementById('shareJoin');
  const shareNick = document.getElementById('shareNick');
  const shareCode = document.getElementById('shareCode');
  const shareMsg  = document.getElementById('shareMsg');
  const hostPanel = document.getElementById('hostPanel');
  const hostMembers = document.getElementById('hostMembers');
  const hostStop = document.getElementById('hostStop');
  const hostRefresh = document.getElementById('hostRefresh');
  const clientPanel = document.getElementById('clientPanel');
  const clientState = document.getElementById('clientState');
  const clientPause = document.getElementById('clientPause');
  const clientResume = document.getElementById('clientResume');
  const clientLeave = document.getElementById('clientLeave');

  // --- lok√°ln√≠ identita za≈ô√≠zen√≠ ---
  const UID_KEY = 'zpj_share_uid';
  const SESSION_KEY = 'zpj_share_session';
  const uid = (localStorage.getItem(UID_KEY) || (()=>{
    const v = 'u_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(UID_KEY, v); return v;
  })());

  function normCode(x){
    const s = String(x||'').replace(/\D/g,'').slice(0,5);
    return s.length === 5 ? s : '';
  }
  function setMsg(text, kind='info'){
    if (!text){ shareMsg.style.display='none'; shareMsg.textContent=''; return; }
    shareMsg.style.display='inline-flex';
    shareMsg.textContent = text;
    // jen jemn√© odli≈°en√≠
    shareMsg.style.borderColor = (kind==='err') ? '#7f1d1d' : '#273142';
    shareMsg.style.background  = (kind==='err') ? '#2b1b1b' : 'transparent';
  }

  // barvy tlaƒç√≠tka sd√≠len√≠
  function paintShare(state){
    // default
    btnShare.style.background = 'transparent';
    btnShare.style.borderColor = '#2c3b60';
    btnShare.style.color = 'var(--ink)';
    btnShare.dataset.shareState = state || '';
    if (state === 'host') {
      btnShare.style.background = '#123b1f';
      btnShare.style.borderColor = '#22c55e';
    } else if (state === 'client') {
      btnShare.style.background = '#2a1a3d';
      btnShare.style.borderColor = '#a855f7';
    } else if (state === 'paused') {
      btnShare.style.background = '#3a2a12';
      btnShare.style.borderColor = '#f59e0b';
    }
  }

  // Firebase init (pokud je config)
  let app, db;
  if (HAS_CONFIG){
    app = initializeApp(FIREBASE_CONFIG);
    db = getFirestore(app);
  }

  // Session stav
  let unsubSession = null;
  let unsubMembers = null;
  let unsubMe = null;
  let unsubNav = null;
  let heartbeatTimer = null;

  function getLocalSession(){
    try{ return JSON.parse(localStorage.getItem(SESSION_KEY) || 'null'); }catch(_){ return null; }
  }
  function setLocalSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
  function clearLocalSession(){ localStorage.removeItem(SESSION_KEY); }

function cleanupSubs(){
  if (unsubSession) try{unsubSession();}catch(_){}
  if (unsubMembers) try{unsubMembers();}catch(_){}
  if (unsubMe) try{unsubMe();}catch(_){}
  if (unsubNav) try{unsubNav();}catch(_){}

  unsubSession = unsubMembers = unsubMe = unsubNav = null;

  if (heartbeatTimer) { clearInterval(heartbeatTimer); heartbeatTimer = null; }
}

  function sessionDoc(code){ return doc(db, 'zpevnikShare', code); }
  function memberDoc(code, memberUid){ return doc(db, 'zpevnikShare', code, 'members', memberUid); }

  async function touch(code, gen, role){
    // lastActive dr≈æ√≠ session ≈æivou (60 min)
    const now = Date.now();
    const exp = new Date(now + 60*60*1000);
    const sref = sessionDoc(code);
    const mref = memberDoc(code, uid);
    try{
      await updateDoc(sref, { lastActive: serverTimestamp(), expiresAt: exp, generation: gen });
    }catch(_){ /* ignore */ }
    try{
      await updateDoc(mref, { lastSeen: serverTimestamp(), generation: gen, role });
    }catch(_){ /* ignore */ }
  }

  function startHeartbeat(code, gen, role){
    if (heartbeatTimer) clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(()=> touch(code, gen, role), 25*1000);
  }

  // Host: render members + accept/deny + disconnect
  function renderHostMembers(code, gen, hostUid){
    hostMembers.innerHTML = '<li class="badge" style="opacity:.8">Naƒç√≠t√°m‚Ä¶</li>';
    const qMembers = query(collection(db, 'zpevnikShare', code, 'members'), orderBy('joinedAt','asc'));
    if (unsubMembers) try{unsubMembers();}catch(_){}
    unsubMembers = onSnapshot(qMembers, (snap)=>{
      const items = [];
      snap.forEach(d=>{
        const m = d.data() || {};
        if (m.generation !== gen) return;
        items.push({ id: d.id, ...m });
      });
      hostMembers.innerHTML = items.map(m=>{
        const nick = (m.nick||m.id);
        const st = (m.status||'').toUpperCase();
        const isMe = (m.id === uid);
        const isHost = (m.role === 'host');
        const badge = isHost ? 'HOST' : st;
        const canAccept = (!isHost && m.status === 'pending');
        const canKick = (!isHost && m.status !== 'pending');
        return `
          <li style="display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid #1f2b46">
            <div style="flex:1;min-width:0">
              <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(nick)}${isMe?' <span class=\"badge\" style=\"margin-left:6px\">TY</span>':''}</div>
              <small class="badge" style="opacity:.85">${escapeHtml(badge)}</small>
            </div>
            ${canAccept ? `
              <button data-acc="${m.id}">P≈ôijmout</button>
              <button data-den="${m.id}">Odm√≠tnout</button>
            ` : ''}
            ${canKick ? `<button data-kick="${m.id}" title="Odpojit">‚õî</button>` : ''}
          </li>
        `;
      }).join('') || '<li class="badge" style="opacity:.8">Nikdo p≈ôipojen√Ω.</li>';

      hostMembers.querySelectorAll('[data-acc]').forEach(btn=>{
        btn.onclick = async ()=>{
          const mid = btn.dataset.acc;
          await updateDoc(memberDoc(code, mid), { status:'active', acceptedAt: serverTimestamp(), generation: gen });
        };
      });
      hostMembers.querySelectorAll('[data-den]').forEach(btn=>{
        btn.onclick = async ()=>{
          const mid = btn.dataset.den;
          await updateDoc(memberDoc(code, mid), { status:'denied', deniedAt: serverTimestamp(), generation: gen });
        };
      });
      hostMembers.querySelectorAll('[data-kick]').forEach(btn=>{
        btn.onclick = async ()=>{
          const mid = btn.dataset.kick;
          if (!confirm('Odpojit tohoto u≈æivatele?')) return;
          await updateDoc(memberDoc(code, mid), { status:'kicked', kickedAt: serverTimestamp(), generation: gen });
        };
      });
    });
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

  async function becomeHost(code, nick){
    const gen = 'g_' + Math.random().toString(36).slice(2,10);
    const sref = sessionDoc(code);
    const now = Date.now();
    const exp = new Date(now + 60*60*1000);

    await setDoc(sref, {
      hostUid: uid,
      hostNick: nick,
      role: 'host',
      createdAt: serverTimestamp(),
      lastActive: serverTimestamp(),
      expiresAt: exp,
      generation: gen,
      current: null,
    }, { merge:true });

    await setDoc(memberDoc(code, uid), {
      uid,
      nick,
      role: 'host',
      status: 'active',
      joinedAt: serverTimestamp(),
      lastSeen: serverTimestamp(),
      generation: gen,
    }, { merge:true });

    setLocalSession({ code, role:'host', generation: gen });
    attach(code);
  }

  async function joinAsClient(code, nick){
    const sref = sessionDoc(code);
    const snap = await getDoc(sref);
    if (!snap.exists()) {
      await becomeHost(code, nick);
      return;
    }
    const data = snap.data() || {};

    // expirovan√Ω k√≥d ‚Üí prvn√≠ kdo p≈ôijde, m≈Ø≈æe p≈ôevz√≠t (transaction)
    const exp = data.expiresAt?.toDate ? data.expiresAt.toDate() : (data.expiresAt instanceof Date ? data.expiresAt : null);
    const isExpired = exp ? (exp.getTime() < Date.now()) : false;
    if (isExpired) {
      await runTransaction(db, async (tx)=>{
        const s2 = await tx.get(sref);
        const d2 = s2.data() || {};
        const exp2 = d2.expiresAt?.toDate ? d2.expiresAt.toDate() : null;
        if (exp2 && exp2.getTime() >= Date.now()) return; // mezit√≠m obnoveno
        const gen = 'g_' + Math.random().toString(36).slice(2,10);
        const expNew = new Date(Date.now() + 60*60*1000);
        tx.set(sref, {
          hostUid: uid,
          hostNick: nick,
          createdAt: serverTimestamp(),
          lastActive: serverTimestamp(),
          expiresAt: expNew,
          generation: gen,
          current: null,
        }, { merge:true });
        tx.set(memberDoc(code, uid), {
          uid, nick, role:'host', status:'active', joinedAt: serverTimestamp(), lastSeen: serverTimestamp(), generation: gen,
        }, { merge:true });
        setLocalSession({ code, role:'host', generation: gen });
      });
      attach(code);
      return;
    }

    const gen = data.generation || ('g_' + Math.random().toString(36).slice(2,10));
    await setDoc(memberDoc(code, uid), {
      uid,
      nick,
      role: 'client',
      status: 'pending',
      joinedAt: serverTimestamp(),
      lastSeen: serverTimestamp(),
      generation: gen,
    }, { merge:true });
    setLocalSession({ code, role:'client', generation: gen });
    attach(code);
  }

  async function hostStopSharing(code, gen){
    if (!confirm('Opravdu zru≈°it sd√≠len√≠? T√≠m odpoj√≠≈° v≈°echny p≈ôipojen√©.')) return;
    // Bez Cloud Functions neum√≠me bezpeƒçnƒõ smazat celou subkolekci ‚Äûmembers‚Äú.
    // Udƒõl√°me "hard reset": zv√Ω≈°√≠me generation + vypr√°zdn√≠me current, t√≠m se v≈°ichni odpoj√≠.
    const newGen = 'g_' + Math.random().toString(36).slice(2,10);
    const exp = new Date(Date.now() + 60*60*1000);
    await updateDoc(sessionDoc(code), { generation: newGen, current: null, lastActive: serverTimestamp(), expiresAt: exp, closedAt: serverTimestamp() });
    // host s√°m se odpoj√≠ lok√°lnƒõ
    cleanupSubs();
    clearLocalSession();
    paintShare('');
    hostPanel.style.display='none';
    clientPanel.style.display='none';
    setMsg('Sd√≠len√≠ zru≈°eno. K√≥d je voln√Ω.', 'info');
  }

  function attach(code){
    if (!HAS_CONFIG) return;
    cleanupSubs();

    const local = getLocalSession();
    if (!local || local.code !== code) return;
    const genLocal = local.generation;
    const roleLocal = local.role;

    // session listener
    unsubSession = onSnapshot(sessionDoc(code), (snap)=>{
      if (!snap.exists()){
        // session zmizela
        cleanupSubs();
        clearLocalSession();
        paintShare('');
        setMsg('Sd√≠len√≠ skonƒçilo (k√≥d u≈æ neexistuje).', 'err');
        hostPanel.style.display='none'; clientPanel.style.display='none';
        return;
      }
      const s = snap.data() || {};
      const gen = s.generation;
      if (gen && genLocal && gen !== genLocal){
        // byl reset (nov√° generace) ‚Üí odpoj v≈°echny star√©
        cleanupSubs();
        clearLocalSession();
        paintShare('');
        setMsg('Sd√≠len√≠ bylo ukonƒçeno hlavn√≠m telefonem.', 'info');
        hostPanel.style.display='none'; clientPanel.style.display='none';
        return;
      }

      // host vs client UI
      if (roleLocal === 'host') {
        paintShare('host');
        hostPanel.style.display='block';
        clientPanel.style.display='none';
        renderHostMembers(code, genLocal, uid);
        startHeartbeat(code, genLocal, 'host');
        setMsg('Sd√≠len√≠ aktivn√≠ (hlavn√≠).', 'info');
      } else {
        // client ‚Äì detail stavu je podle member doc
        hostPanel.style.display='none';
        clientPanel.style.display='block';
        startHeartbeat(code, genLocal, 'client');
      }
    });

    // member listener (j√°)
    unsubMe = onSnapshot(memberDoc(code, uid), (snap)=>{
      if (!snap.exists()) return;
      const me = snap.data() || {};
      if (me.generation !== genLocal) return;
      if (roleLocal === 'client'){
        const st = me.status;
        if (st === 'pending'){
          paintShare('');
          clientState.textContent = 'ƒåek√°≈° na p≈ôijet√≠ hlavn√≠m telefonem‚Ä¶';
          setMsg('ƒåek√°≈° na p≈ôijet√≠.', 'info');
        } else if (st === 'active'){
          paintShare('client');
          clientState.textContent = 'P≈ôipojeno (ovl√°d√° tƒõ hlavn√≠ telefon).';
          setMsg('P≈ôipojeno.', 'info');
        } else if (st === 'paused'){
          paintShare('paused');
          clientState.textContent = 'Pauza ‚Äì hlavn√≠ telefon tƒõ teƒè neovl√°d√°.';
          setMsg('Pauznuto.', 'info');
        } else if (st === 'denied' || st === 'kicked'){
          paintShare('');
          clientState.textContent = (st === 'denied') ? 'Byl(a) jsi odm√≠tnut(a).' : 'Byl(a) jsi odpojen(a) hlavn√≠m telefonem.';
          setMsg(clientState.textContent, 'err');
          clearLocalSession();
        }
      }
    });
  }

  // --- actions ---
  dlgShareClose.onclick = ()=> dlgShare.close();

  btnShare.onclick = async ()=>{
    // kdy≈æ u≈æ bƒõ≈æ√≠ sd√≠len√≠, zelen√©/fialov√© tlaƒç√≠tko otev≈ôe spr√°vn√Ω panel
    dlgShare.showModal();
    setMsg('');
    const local = getLocalSession();
    if (!HAS_CONFIG){
      setMsg('Firebase nen√≠ nastaven√Ω. Dopl≈à FIREBASE_CONFIG v index.html.', 'err');
      hostPanel.style.display='none'; clientPanel.style.display='none';
      return;
    }
    if (local?.code){
      // u≈æ p≈ôipojen√Ω: p≈ôepni UI podle role
      shareCode.value = local.code;
      shareCode.disabled = true;
      shareNick.disabled = true;
      shareJoin.style.display='none';
      if (local.role === 'host'){
        hostPanel.style.display='block';
        clientPanel.style.display='none';
        attach(local.code);
      } else {
        hostPanel.style.display='none';
        clientPanel.style.display='block';
        attach(local.code);
      }
      return;
    }

    // nep≈ôipojen√Ω ‚Äì klasick√© p≈ôihl√°≈°en√≠
    shareCode.disabled = false;
    shareNick.disabled = false;
    shareJoin.style.display='';
    hostPanel.style.display='none'; clientPanel.style.display='none';
    shareNick.value = (localStorage.getItem('zpj_share_nick') || '');
    shareCode.value = '';
    shareNick.focus();
  };

  shareCode.addEventListener('input', ()=>{
    const v = shareCode.value.replace(/\D/g,'').slice(0,5);
    shareCode.value = v;
  });

  shareJoin.onclick = async ()=>{
    setMsg('');
    const nick = (shareNick.value || '').trim().slice(0,24);
    const code = normCode(shareCode.value);
    if (!nick){ setMsg('Zadej p≈ôezd√≠vku.', 'err'); return; }
    if (!code){ setMsg('K√≥d mus√≠ m√≠t 5 ƒç√≠slic.', 'err'); return; }
    localStorage.setItem('zpj_share_nick', nick);

    try{
      // zjisti, jestli existuje a jestli nejsi prvn√≠
      const sref = sessionDoc(code);
      const snap = await getDoc(sref);
      if (!snap.exists()){
        await becomeHost(code, nick);
      } else {
        const data = snap.data() || {};
        if (data.hostUid === uid){
          // u≈æ jsi host (nap≈ô. reload)
          setLocalSession({ code, role:'host', generation: data.generation });
          attach(code);
        } else {
          await joinAsClient(code, nick);
        }
      }
      // zamkni vstupy
      shareCode.disabled = true;
      shareNick.disabled = true;
      shareJoin.style.display = 'none';
      const local = getLocalSession();
      if (local?.role === 'host'){
        hostPanel.style.display='block'; clientPanel.style.display='none';
      } else {
        hostPanel.style.display='none'; clientPanel.style.display='block';
      }
      if (local?.role === 'host') {
  interceptNavigationForHost();
} else if (local?.role === 'client') {
  attachNavigationSync();
}

      setMsg('Hotovo.', 'info');
    }catch(e){
      console.error(e);
      setMsg('Nepoda≈ôilo se p≈ôipojit. Zkontroluj Firebase rules a config.', 'err');
    }
  };

  hostStop.onclick = async ()=>{
    const local = getLocalSession();
    if (!local?.code) return;
    await hostStopSharing(local.code, local.generation);
  };
  hostRefresh.onclick = ()=>{
    const local = getLocalSession();
    if (!local?.code) return;
    attach(local.code);
  };

  clientPause.onclick = async ()=>{
    const local = getLocalSession();
    if (!local?.code) return;
    await updateDoc(memberDoc(local.code, uid), { status:'paused', pausedAt: serverTimestamp(), generation: local.generation });
  };
  clientResume.onclick = async ()=>{
    const local = getLocalSession();
    if (!local?.code) return;
    await updateDoc(memberDoc(local.code, uid), { status:'active', resumedAt: serverTimestamp(), generation: local.generation });
  };
  clientLeave.onclick = async ()=>{
    const local = getLocalSession();
    if (!local?.code) return;
    if (!confirm('Odpojit se od hlavn√≠ho telefonu?')) return;
    try{
      await updateDoc(memberDoc(local.code, uid), { status:'left', leftAt: serverTimestamp(), generation: local.generation });
    }catch(_){ }
    cleanupSubs();
    clearLocalSession();
    paintShare('');
    hostPanel.style.display='none'; clientPanel.style.display='none';
    shareCode.disabled=false; shareNick.disabled=false; shareJoin.style.display='';
    setMsg('Odpojeno.', 'info');
  };
function canonicalPath(href){
  // p≈ôevede relativn√≠ i absolutn√≠ href na jednotn√Ω tvar: /path?query#hash
  try{
    const u = new URL(href, location.origin);
    return u.pathname + u.search + u.hash;
  }catch(_){
    return href || '';
  }
}

function herePath(){
  return location.pathname + location.search + location.hash;
}


  
  // --- SYNCHRON NAVIGACE: client poslouch√° ‚Äûcurrent‚Äú a p≈ôesmƒõruje ---
function attachNavigationSync(){
  const local = getLocalSession();
  if (!HAS_CONFIG || !local?.code || local.role !== 'client') return;

  if (unsubNav) try{unsubNav();}catch(_){}
  unsubNav = onSnapshot(sessionDoc(local.code), async (snap)=>{
    if (!snap.exists()) return;
    const s = snap.data() || {};
    if (s.generation !== local.generation) return;

    const cur = s.current;
    if (!cur || !cur.path) return;

    // klient mus√≠ b√Ωt ACTIVE (ne pending/paused/denied/‚Ä¶)
    try{
      const meSnap = await getDoc(memberDoc(local.code, uid));
      const me = meSnap.data() || {};
      if (me.generation !== local.generation) return;
      if (me.status !== 'active') return;
    }catch(_){ return; }

    const target = canonicalPath(cur.path);
    const here = herePath();

    if (here !== target){
      location.href = target;
    }
  });
}



  // --- Host update: kdy≈æ host klikne na p√≠se≈à v seznamu, zap√≠≈°eme current ---
  // (Bez toho by se ostatn√≠ rozjely a≈æ po naƒçten√≠ song.html u hosta.)
function isInternalZpjevnicekLink(href){
  if (!href) return false;
  if (href.startsWith('#')) return false;
  if (href.startsWith('mailto:') || href.startsWith('tel:')) return false;
  if (href.includes('://') && !href.startsWith(location.origin)) return false;
  return href.includes('/zpjevnicek/');
}

function interceptNavigationForHost(){
  document.addEventListener('click', async (e)=>{
    const a = e.target?.closest?.('a');
    if (!a) return;

    const href = a.getAttribute('href') || '';
    const target = canonicalPath(href);
    if (!isInternalZpjevnicekLink(href)) return;

    const local = getLocalSession();
    if (!HAS_CONFIG || !local?.code || local.role !== 'host') return;

    // otev≈ôen√≠ do nov√© z√°lo≈æky nech b√Ωt
    if (a.target === '_blank' || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

    // ‚úÖ STOP navigaci ‚Äì nejd≈ô√≠v zapi≈° current
    e.preventDefault();
    e.stopPropagation();

    try{
      await updateDoc(sessionDoc(local.code), {
        current: { path: target, at: serverTimestamp() },
        lastActive: serverTimestamp(),
        expiresAt: new Date(Date.now() + 60*60*1000),
        generation: local.generation,
      });
    }catch(err){
      console.error("HOST current update failed:", err);
    }

    // ‚úÖ A≈æ potom p≈ôejdi
   location.href = target;
  }, true);
}

  // pokud je v localStorage session, hned nastav barvu tlaƒç√≠tka + attach
  (function boot(){
    const local = getLocalSession();
    if (!HAS_CONFIG){ paintShare(''); return; }
if (local?.code){
  paintShare(local.role === 'host' ? 'host' : 'client');
  attach(local.code);
  attachNavigationSync();
  interceptNavigationForHost();

}

  })();

</script>
</body>
</html>
