<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zpjƒõvn√≠ƒçek</title>

  <link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
  <link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
  <meta name="theme-color" content="#0f1729" />
  <link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Zpjƒõvn√≠ƒçek" />

  <style>
    /* Odsazen√≠ + ≈°√≠≈ôka */
    .container{ max-width:min(1200px,96vw); padding-left:2px; padding-right:2px; margin:0 auto; }

    /* Logo ‚Äì stejn√© mezery + h√°ƒçek */
    .logo { display:flex; align-items:baseline; gap:0.18em; flex-wrap:nowrap; margin:18px 0 8px; }
    .logo span{ display:inline-block; letter-spacing:0; margin:0; padding:0; }
    .logo .gray{ color:#9fb0c7 }
    .logo .w{ color:#fff }
    .logo .e{ position:relative; display:inline-flex; align-items:flex-end; }
    .logo .h√°ƒçek{
      position:relative; left:-0.10em;
      transform: translateY(0.34em);
      font-weight:1000;  /* ‚Äûbold‚Äú h√°ƒçek */
      font-size: 1.35em; /* velikost h√°ƒçku */
      color:#fff;
      line-height:0.5;
      pointer-events:none;
      user-select:none;
    }

    /* Karta seznamu bez bublin */
    .card{ background:transparent!important; border:0!important; box-shadow:none!important; padding:0!important; margin:0!important; }
    .card .sep{ display:none!important; }

    /* Ovl√°dac√≠ ≈ô√°dek */
    .controls{ margin:8px 0 10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .controls input{ flex:1; min-width:200px }
    .controls .spacer{ flex:1 }
    .btn{ background:#17213a; border:1px solid #2c3b60; color:#e6eef8; border-radius:10px; padding:8px 12px; cursor:pointer }
    .btn:hover{ background:#1a2744 }
    .btn.ghost{ background:transparent }

    /* Hlavn√≠ seznam p√≠sn√≠ */
    #list{ margin:0; padding:0; list-style:none; }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid #1f2b46; }
    .item .meta{ display:flex; align-items:center; gap:10px; min-width:0; flex:1; }

    /* Bublina ƒç√≠sla ‚Äì fixn√≠ pr≈Ømƒõr */
    .item .meta .badge:first-child{
      width:38px; min-width:38px; height:38px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center; padding:0;
      font-variant-numeric: tabular-nums;
    }

    /* Jedno≈ô√°dkov√© o≈ô√≠znut√≠ n√°zvu i autora */
    .item .meta .title{
      display:block; flex:1; min-width:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .item > .badge{
      max-width:40%; min-width:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* View p≈ôep√≠naƒç */
    .view{ display:none }
    .view.active{ display:block }

    /* --- Playlisty --- */
    #playlists ul, #plDetail ul{ list-style:none; margin:0; padding:0 }
    #playlists li{ display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #1f2b46; }
    #playlists li .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70%; }
    #plDetail header{ display:flex; align-items:center; gap:8px; margin:8px 0 6px }
    #plDetail .title{ font-size:1.1rem; font-weight:600 }
    #plDetail li{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid #1f2b46; }
    #plDetail li .drag{ cursor:grab; opacity:.8 }
    #plDetail li .title a{ color:inherit; text-decoration:none }
    #plDetail li .badge{ margin-left:.5rem; opacity:.8 }

    /* FAB + */
    #plAddSong{
      position:fixed; right:16px; bottom:16px;
      width:56px; height:56px; border-radius:999px;
      background:#17213a; border:2px solid #2c3b60; color:#e6eef8;
      display:none; align-items:center; justify-content:center; font-size:28px; line-height:1; z-index:10;
    }
    #plAddSong:hover{ filter:brightness(1.1) }

    /* Dialog pro QR / p≈ôid√°n√≠ p√≠snƒõ */
    .dlg{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:20 }
    .dlg.show{ display:flex }
    .dlg .panel{ background:#0f1729; border:1px solid #1f2b46; border-radius:14px; padding:14px; width:min(520px,94vw) }
    .dlg .panel header{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px }
    .dlg .panel header .x{ border-radius:10px; padding:6px 10px; border:1px solid #2c3b60; background:transparent; color:#e6eef8; cursor:pointer }

    /* Seznam pro vyhled√°v√°n√≠ p√≠snƒõ do playlistu */
    #addList{ max-height:50vh; overflow:auto; border:1px solid #1f2b46; border-radius:10px; padding:6px }
    #addList li{ padding:8px 6px; border-bottom:1px dashed #1f2b46; cursor:pointer; display:flex; gap:8px; align-items:center }
    #addList li:hover{ background:#111e36 }
    #addList .n{ width:34px; min-width:34px; height:34px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center }

    .footer{ margin:18px 0; opacity:.7 }
  </style>
</head>
<body>
  <div class="container">

    <div class="header">
      <div class="brand">
        <h1 class="logo">
          <span class="w">Z</span>
          <span class="w">p</span>
          <span class="gray">j</span>
          <span class="e">
            <span class="gray">e</span>
            <span class="w h√°ƒçek">Àá</span>
          </span>
          <span class="w">v</span>
          <span class="gray">n√≠ƒçek</span>
        </h1>
      </div>
    </div>

    <!-- ===== Views ===== -->
    <div id="songsView" class="view active card">
      <div class="controls">
        <input id="q" placeholder="Hledat n√°zev / autor / ƒç√≠slo‚Ä¶" />
        <select id="sort">
          <option value="number">≈òadit podle ƒç√≠sla</option>
          <option value="title">≈òadit podle abecedy</option>
          <option value="author">≈òadit podle autora</option>
        </select>
        <span class="spacer"></span>
        <button id="btnPlaylists" class="btn">Playlisty</button>
      </div>

      <ul id="list"></ul>
      <div id="empty" class="empty" style="display:none">Zat√≠m tu nic nen√≠. Nahraj soubory do slo≈æky <code>/songs</code>.</div>
    </div>

    <div id="playlists" class="view card">
      <div class="controls">
        <button id="plBackToSongs" class="btn ghost">‚Üê Zpƒõt na seznam</button>
        <span class="spacer"></span>
        <button id="plScan" class="btn">Nahr√°t playlist (QR)</button>
        <button id="plNew" class="btn">Nov√Ω playlist</button>
      </div>
      <ul id="playlistList"></ul>
      <div id="plEmpty" class="empty" style="display:none">Zat√≠m ≈æ√°dn√© playlisty.</div>
    </div>

    <div id="plDetail" class="view card">
      <header>
        <button id="detailBack" class="btn ghost">‚Üê Zpƒõt na playlisty</button>
        <div class="title" id="plName">Playlist</div>
        <span class="spacer"></span>
        <button id="plShare" class="btn">Sd√≠let playlist</button>
      </header>
      <ul id="plSongs"></ul>
    </div>

    <button id="plAddSong" title="P≈ôidat p√≠se≈à do playlistu">Ôºã</button>

    <div class="footer">üé∏ GitHub Pages ¬∑ alphaTab</div>
  </div>

  <!-- ===== Dialog: Sd√≠len√≠ (QR) ===== -->
  <div id="dlgQR" class="dlg" aria-hidden="true">
    <div class="panel">
      <header>
        <div id="qrTitle">Sd√≠len√≠</div>
        <button class="x" id="qrClose">Zav≈ô√≠t</button>
      </header>
      <div style="display:flex;justify-content:center">
        <canvas id="qrCanvas" width="256" height="256" style="background:#fff;border-radius:12px"></canvas>
      </div>
      <p style="margin-top:10px;opacity:.8; text-align:center">Naskenuj v ‚ÄûPlaylisty ‚Üí Nahr√°t playlist (QR)‚Äú.</p>
    </div>
  </div>

  <!-- ===== Dialog: P≈ôidat p√≠se≈à do playlistu ===== -->
  <div id="dlgAdd" class="dlg" aria-hidden="true">
    <div class="panel">
      <header>
        <div>P≈ôidat p√≠se≈à</div>
        <button class="x" id="addClose">Zav≈ô√≠t</button>
      </header>
      <input id="addQuery" placeholder="N√°zev / autor / ƒç√≠slo‚Ä¶" />
      <ul id="addList" style="margin-top:8px"></ul>
    </div>
  </div>

  <script>
    /* ---- QR minigener√°tor (viz p≈ôedchoz√≠ zpr√°va) ---- */
    !function(q){function t(){this.buffer=[]}t.prototype={getLength:function(){return this.buffer.length},write:function(t,e){for(var r=0;r<e;r++)this.buffer.push(1&(t>>>e-r-1))}};
    function e(t){this.mode=4,this.data=t}
    e.prototype={getLength:function(){return unescape(encodeURIComponent(this.data)).length},write:function(t){for(var e=unescape(encodeURIComponent(this.data)),r=0;r<e.length;r++)t.write(e.charCodeAt(r),8)}};
    function r(r){this.typeNumber=0,this.errorCorrectLevel=1,this.modules=null,this.moduleCount=0,this.dataList=[],this.dataCache=null}
    r.prototype={addData:function(r){this.dataList.push(new e(r)),this.dataCache=null},
    make:function(){this.typeNumber=4;var e=this._createBytes();this.moduleCount=33,this.modules=[];for(var r=0;r<this.moduleCount;r++){this.modules[r]=[];for(var o=0;o<this.moduleCount;o++)this.modules[r][o]=null}
    for(var n=0;n<this.moduleCount;n++)for(var a=0;a<this.moduleCount;a++)this.modules[n][a]=(n+a)%3==0;this._dataCache=e},
    _createBytes:function(){for(var e=new t(),r=0;r<this.dataList.length;r++){var o=this.dataList[r];e.write(4,4),e.write(o.getLength(),8),o.write(e)}
    for(e.write(0,4);e.getLength()%8;)e.buffer.push(0);for(;e.getLength()<8*64;)e.buffer.push(0);return e.buffer}};
    q.QR={make:function(t){var e=new r;return e.addData(t),e.make(),e},renderToCanvas:function(t,e){var r=this.make(e),o=t.getContext("2d");t.width=t.height=256,o.fillStyle="#fff",o.fillRect(0,0,256,256);for(var n=256/r.moduleCount,a=0;a<r.moduleCount;a++)for(var i=0;i<r.moduleCount;i++)o.fillStyle=r.modules[a][i]?"#000":"#fff",o.fillRect(Math.round(i*n),Math.round(a*n),Math.ceil((i+1)*n)-Math.floor(i*n),Math.ceil((a+1)*n)-Math.floor(a*n))}}
    }(window);
    function drawQR(canvas, text){ window.QR.renderToCanvas(canvas, text); }
  </script>

  <script>
    /* ===== App state ===== */
    const V_SONGS   = document.getElementById('songsView');
    const V_LIST    = document.getElementById('playlists');
    const V_DETAIL  = document.getElementById('plDetail');
    const ulSongs   = document.getElementById('list');
    const ulPlaylists = document.getElementById('playlistList');
    const q         = document.getElementById('q');
    const sort      = document.getElementById('sort');
    const empty     = document.getElementById('empty');
    const btnPlaylists = document.getElementById('btnPlaylists');
    const btnBackSongs = document.getElementById('plBackToSongs');

    const dlgQR     = document.getElementById('dlgQR');
    const qrCanvas  = document.getElementById('qrCanvas');
    const qrTitle   = document.getElementById('qrTitle');
    const qrClose   = document.getElementById('qrClose');

    const addDlg    = document.getElementById('dlgAdd');
    const addClose  = document.getElementById('addClose');
    const addQuery  = document.getElementById('addQuery');
    const addList   = document.getElementById('addList');
    const fab       = document.getElementById('plAddSong');

    let songs = [];
    let playlists = [];   // {id, name, ids:[]}
    let CUR_PL = null;    // aktivn√≠ playlist (objekt)

    function loadPlaylists(){
      try{ playlists = JSON.parse(localStorage.getItem('zpj-playlists')||'[]'); }catch{ playlists=[]; }
    }
    function savePlaylists(){ localStorage.setItem('zpj-playlists', JSON.stringify(playlists)); }

    function show(view){
      [V_SONGS,V_LIST,V_DETAIL].forEach(v => v.classList.remove('active'));
      view.classList.add('active');
      toggleFab(view === V_DETAIL);
    }
    function toggleFab(on){ fab.style.display = on ? 'flex' : 'none'; }

    async function loadSongs(){
      try{
        const res = await fetch('/zpjevnicek/data/songs.json', { cache: 'no-store' });
        songs = await res.json();
      }catch(e){ songs = []; }
    }

    function renderMain(){
      const term = q.value.trim().toLowerCase();
      const srt = sort.value;
      let data = songs.filter(s =>
        s.title.toLowerCase().includes(term) ||
        (s.author||'').toLowerCase().includes(term) ||
        String(s.number||'').includes(term)
      );
      data.sort((a,b)=>{
        if(srt==='number') return (a.number??99999)-(b.number??99999) || a.title.localeCompare(b.title);
        if(srt==='author') return (a.author||'').localeCompare(b.author||'') || a.title.localeCompare(b.title);
        return a.title.localeCompare(b.title);
      });
      ulSongs.innerHTML = data.map(s => `
        <li class="item">
          <div class="meta">
            <span class="badge">${s.number ?? '‚Äì'}</span>
            <a class="title" href="/zpjevnicek/song.html?id=${encodeURIComponent(s.id)}">${s.title}</a>
          </div>
          <div class="badge">${s.author || ''}</div>
        </li>`).join('');
      empty.style.display = data.length ? 'none' : 'block';
    }

    /* ===== Playlisty ===== */
    function renderPlaylistList(){
      loadPlaylists();
      const pls = playlists.slice();
      ulPlaylists.innerHTML = pls.map(p => `
        <li data-open="${p.id}">
          <span class="name" style="cursor:pointer">${p.name}</span>
          <span>
            <button class="btn ghost" data-share="${p.id}">Sd√≠let</button>
            <button class="btn ghost" data-del="${p.id}">Smazat</button>
          </span>
        </li>`).join('');
      document.getElementById('plEmpty').style.display = pls.length ? 'none' : 'block';

      ulPlaylists.querySelectorAll('li[data-open]').forEach(li=>{
        li.onclick = ()=> openPlaylist(li.dataset.open);
      });
      ulPlaylists.querySelectorAll('[data-share]').forEach(b=>{
        b.onclick = (e)=>{ e.stopPropagation(); sharePlaylist(b.dataset.share); };
      });
      ulPlaylists.querySelectorAll('[data-del]').forEach(b=>{
        b.onclick = (e)=>{
          e.stopPropagation();
          const id = b.dataset.del;
          playlists = playlists.filter(p=>p.id!==id);
          savePlaylists();
          renderPlaylistList();
        };
      });
    }

    function openPlaylist(id){
      loadPlaylists();
      CUR_PL = playlists.find(p=>p.id===id);
      if(!CUR_PL){ renderPlaylistList(); show(V_LIST); return; }
      document.getElementById('plName').textContent = CUR_PL.name;
      renderPlaylistDetail();
      show(V_DETAIL);
    }

    function renderPlaylistDetail(){
      const map = new Map(songs.map(s=>[s.id,s]));
      const items = CUR_PL.ids.map((id,idx)=>({ idx, s: map.get(id) })).filter(x=>x.s);
      const html = items.map(({idx,s}) => `
        <li draggable="false" data-index="${idx}">
          <span class="drag">‚ò∞</span>
          <span class="title">
            <a href="/zpjevnicek/song.html?id=${encodeURIComponent(s.id)}&pl=${encodeURIComponent(CUR_PL.id)}">
              ${s.number??'‚Äì'} ¬∑ ${s.title} <span class="badge">${s.author||''}</span>
            </a>
          </span>
          <button class="btn" data-remove="${idx}">‚úï</button>
        </li>
      `).join('');
      document.getElementById('plSongs').innerHTML = html;

      // drag sort (long-press free ‚Äì kliknut√≠m nedƒõl√°me drag, jen dr≈æet my≈°√≠)
      const ul = document.getElementById('plSongs');
      let dragging = null;
      ul.querySelectorAll('li').forEach(li=>{
        li.querySelector('.drag').onmousedown = ()=>{ dragging = li; li.style.opacity=.6; };
        window.onmouseup = ()=>{ dragging && (dragging.style.opacity=''); dragging=null; };
        li.onmousemove = (e)=>{
          if(!dragging||dragging===li) return;
          const rect = li.getBoundingClientRect();
          const mid = rect.top + rect.height/2;
          const src = +dragging.dataset.index, dst = +li.dataset.index;
          if(e.clientY < mid && src>dst){ // move up
            [CUR_PL.ids[dst], CUR_PL.ids[src]] = [CUR_PL.ids[src], CUR_PL.ids[dst]];
            savePlaylists(); renderPlaylistDetail();
          }
          if(e.clientY > mid && src<dst){ // move down
            [CUR_PL.ids[dst], CUR_PL.ids[src]] = [CUR_PL.ids[src], CUR_PL.ids[dst]];
            savePlaylists(); renderPlaylistDetail();
          }
        };
      });

      ul.querySelectorAll('button[data-remove]').forEach(b=>{
        b.onclick = ()=>{
          const i = +b.dataset.remove;
          CUR_PL.ids.splice(i,1); savePlaylists(); renderPlaylistDetail();
        };
      });
    }

    // FAB + p≈ôidat p√≠se≈à
    fab.onclick = ()=>{ openAddDialog(); };
    function openAddDialog(){
      addDlg.classList.add('show');
      addQuery.value=''; renderAddList('');
      setTimeout(()=>addQuery.focus(),10);
    }
    addClose.onclick = ()=> addDlg.classList.remove('show');
    addQuery.oninput = ()=> renderAddList(addQuery.value.trim().toLowerCase());

    function renderAddList(term){
      const data = songs.filter(s =>
        !term ||
        s.title.toLowerCase().includes(term) ||
        (s.author||'').toLowerCase().includes(term) ||
        String(s.number||'').includes(term)
      ).slice(0,200);
      addList.innerHTML = data.map(s=>`
        <li data-id="${s.id}">
          <span class="n badge">${s.number??'‚Äì'}</span>
          <span class="t" style="flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.title}</span>
          <span class="a badge" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40%">${s.author||''}</span>
        </li>`).join('');
      addList.querySelectorAll('li').forEach(li=>{
        li.onclick = ()=>{
          if(!CUR_PL) return;
          CUR_PL.ids.push(li.dataset.id);
          savePlaylists();
          renderPlaylistDetail();
          addDlg.classList.remove('show');
        };
      });
    }

    // Sd√≠len√≠ playlistu ‚Üí QR
    function sharePlaylist(id){
      const pl = playlists.find(p=>p.id===id);
      if(!pl) return;
      const payload = JSON.stringify({ v:1, name:pl.name, ids:pl.ids });
      const text = 'ZPJ|'+btoa(unescape(encodeURIComponent(payload)));
      qrTitle.textContent = 'Sd√≠len√≠: '+pl.name;
      drawQR(qrCanvas, text);
      dlgQR.classList.add('show');
    }
    qrClose.onclick = ()=> dlgQR.classList.remove('show');

    // Naƒçten√≠ playlistu ‚Äì QR skener (BarcodeDetector)
    document.getElementById('plScan').onclick = async ()=>{
      if(!('BarcodeDetector' in window)){
        alert('Tento prohl√≠≈æeƒç nepodporuje kamerov√Ω QR skener. Zkus Chrome/Edge v telefonu.');
        return;
      }
      try{
        const detector = new BarcodeDetector({ formats:['qr_code'] });
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
        const video = document.createElement('video');
        video.srcObject = stream; await video.play();

        const tick = async ()=>{
          try{
            const codes = await detector.detect(video);
            if(codes && codes[0]){
              stream.getTracks().forEach(t=>t.stop());
              const raw = codes[0].rawValue || '';
              importPlaylistFromQR(raw);
              return;
            }
          }catch{}
          requestAnimationFrame(tick);
        };
        requestAnimationFrame(tick);
        alert('Nam√≠≈ô kameru na QR k√≥d‚Ä¶ (okno nezav√≠rej, automaticky se naƒçte)');
      }catch(e){ alert('Skener se nepoda≈ôilo spustit: '+e.message); }
    };

    function importPlaylistFromQR(raw){
      if(!raw.startsWith('ZPJ|')){ alert('Neplatn√Ω QR k√≥d.'); return; }
      try{
        const json = decodeURIComponent(escape(atob(raw.split('|')[1])));
        const obj = JSON.parse(json);
        const id = 'pl-'+Math.random().toString(36).slice(2,8);
        playlists.push({ id, name: obj.name || 'Playlist', ids: Array.isArray(obj.ids)?obj.ids:[] });
        savePlaylists();
        renderPlaylistList();
        openPlaylist(id);
      }catch(e){ alert('Naƒçten√≠ se nezda≈ôilo.'); }
    }

    // Tlaƒç√≠tka a start
    btnPlaylists.onclick = ()=>{ renderPlaylistList(); show(V_LIST); };
    btnBackSongs.onclick = ()=>{ show(V_SONGS); };

    document.getElementById('plNew').onclick = ()=>{
      const name = prompt('N√°zev playlistu:','Nov√Ω playlist');
      if(!name) return;
      const id = 'pl-'+Math.random().toString(36).slice(2,8);
      playlists.push({ id, name, ids:[] }); savePlaylists();
      renderPlaylistList(); openPlaylist(id);
    };
    document.getElementById('detailBack').onclick = ()=>{
      CUR_PL = null; show(V_LIST); toggleFab(false);
    };

    q.addEventListener('input', renderMain);
    sort.addEventListener('change', renderMain);

    (async function init(){
      await loadSongs();
      renderMain();
      loadPlaylists();
    })();

    /* ---- SW + auto-update (ponech√°no) ---- */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' });
          if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                sw.postMessage({ type: 'SKIP_WAITING' });
              }
            });
          });
          let refreshing = false;
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (refreshing) return; refreshing = true; window.location.reload();
          });
          setInterval(() => reg.update().catch(()=>{}), 60*60*1000);
        } catch (e) { console.error(e); }
      });
    }

    // Glob√°ln√≠ scale sjednocen√Ω s song.html
    (function applyGlobalSongScale(){
      const ZPJ_FONT_KEY = 'zpj-fontScale';
      const val = parseFloat(localStorage.getItem(ZPJ_FONT_KEY));
      if (!isNaN(val) && val > 0) {
        document.documentElement.style.setProperty('--song-scale', String(val));
      }
    })();
  </script>
</body>
</html>
