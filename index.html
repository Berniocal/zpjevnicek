<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zpƒõvn√≠ƒçek</title>

  <link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
  <link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
  <meta name="theme-color" content="#0f1729" />
  <link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Zpjƒõvn√≠ƒçek" />
</head>
<body>
  <div class="container">
<div class="header">
  <div class="brand">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M3 21c4-1 7-6 9-9l2 2c-3 2-8 5-11 7zM14 3l7 7-2 2-7-7 2-2z" stroke="#7bb0ff" stroke-width="1.5"/>
    </svg>
    <h1>Zpjƒõvn√≠ƒçek</h1>
  </div>

  <div class="header-actions">
    <button class="btn" id="btnAdmin" type="button"
            onclick="location.href='/zpjevnicek/admin.html'">P≈ôidat p√≠snƒõ</button>

    <label class="btn btn-ghost" id="offlineWrap">
      <input id="autoOffline" type="checkbox"> offline
    </label>
  </div>
</div>


    <div class="card">
      <div class="controls">
        <input id="q" placeholder="Hledat n√°zev / autor / ƒç√≠slo‚Ä¶" />
        <select id="sort">
          <option value="number">≈òadit podle ƒç√≠sla</option>
          <option value="title">≈òadit podle abecedy</option>
          <option value="author">≈òadit podle autora</option>
        </select>
      </div>
      <hr class="sep"/>
      <ul id="list"></ul>
      <div id="empty" class="empty" style="display:none">
        Zat√≠m tu nic nen√≠. Nahraj soubory do slo≈æky <code>/songs</code>.
      </div>
    </div>

    <div class="footer">üé∏ GitHub Pages ¬∑ alphaTab</div>
  </div>

<script>
const list = document.getElementById('list');
const q = document.getElementById('q');
const sort = document.getElementById('sort');
const empty = document.getElementById('empty');
let songs = [];

async function load(){
  try{
    const res = await fetch('/zpjevnicek/data/songs.json', { cache: 'no-store' });
    songs = await res.json();
  }catch(e){ songs = []; }
  render();
}
function render(){
  const term = q.value.trim().toLowerCase();
  const srt = sort.value;
  let data = songs.filter(s =>
    s.title.toLowerCase().includes(term) ||
    (s.author||'').toLowerCase().includes(term) ||
    String(s.number||'').includes(term)
  );
  data.sort((a,b)=>{
    if(srt==='number') return (a.number??99999)-(b.number??99999) || a.title.localeCompare(b.title);
    if(srt==='author') return (a.author||'').localeCompare(b.author||'') || a.title.localeCompare(b.title);
    return a.title.localeCompare(b.title);
  });
  list.innerHTML = data.map(s => `
    <li class="item">
      <div class="meta">
        <span class="badge">${s.number ?? '‚Äì'}</span>
        <a class="title" href="/zpjevnicek/song.html?id=${encodeURIComponent(s.id)}">${s.title}</a>
      </div>
      <div class="badge">${s.author || ''}</div>
    </li>`).join('');
  empty.style.display = data.length ? 'none' : 'block';
}
q.addEventListener('input', render);
sort.addEventListener('change', render);
load();
</script>

<!-- Registrace SW + AUTO-UPDATE -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' });

      // 1) U≈æ sta≈æen√° nov√° verze? ‚Üí p≈ôepnout hned
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });

      // 2) Nov√° verze se pr√°vƒõ instaluje ‚Üí po installed ji hned aktivuj
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        if (!sw) return;
        sw.addEventListener('statechange', () => {
          if (sw.state === 'installed' && navigator.serviceWorker.controller) {
            sw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });

      // 3) Po p≈ôepnut√≠ ≈ô√≠d√≠c√≠ho SW automaticky jednor√°zovƒõ reloadni
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        window.location.reload();
      });

      // 4) Obƒçasn√° kontrola aktualizac√≠ (nap≈ô. ka≈ædou hodinu)
      setInterval(() => reg.update().catch(()=>{}), 60 * 60 * 1000);
    } catch (e) {
      console.error(e);
    }
  });
}
</script>
<!-- ‚úÖ P≈ôep√≠naƒç auto-offline + automatick√© stahov√°n√≠ -->
<script>
  const AUTO_OFFLINE_KEY = 'zpj-autoOffline';
  const cb = document.getElementById('autoOffline');
  cb.checked = localStorage.getItem(AUTO_OFFLINE_KEY) === '1';
  cb.onchange = () => localStorage.setItem(AUTO_OFFLINE_KEY, cb.checked ? '1' : '0');

  function goodConnection(){
    const c = navigator.connection || navigator.webkitConnection || navigator.mozConnection;
    if (!c) return true;
    if (c.saveData) return false;
    const okTypes = ['wifi','ethernet','unknown'];
    return okTypes.includes(c.type) || (c.effectiveType || '').includes('4g');
  }

  async function prefetchAllIfAllowed(){
    try{
      const allow = localStorage.getItem(AUTO_OFFLINE_KEY) === '1';
      if (!allow) return;
      if (!navigator.onLine) return;
      if (!goodConnection()) return;

      const reg = await navigator.serviceWorker.getRegistration('/zpjevnicek/');
      if (reg && reg.active) {
        reg.active.postMessage({ type: 'CACHE_ALL_SONGS', chunkSize: 6, reportProgress: true });
      }
    }catch(e){ console.warn(e); }
  }

  // spustit po loadu + obƒças zopakovat (ka≈æd√Ωch 30 min)
  window.addEventListener('load', prefetchAllIfAllowed);
  setInterval(prefetchAllIfAllowed, 30*60*1000);
</script>

<!-- ‚¨á‚¨á‚¨á JEDIN√Å NOV√Å ƒå√ÅST: glob√°ln√≠ aplikace ulo≈æen√© velikosti textu -->
<script>
  // Glob√°ln√≠ kl√≠ƒç (stejn√Ω na v≈°ech str√°nk√°ch aplikace)
  const ZPJ_FONT_KEY = 'zpj-fontScale';

  // P≈ôi ka≈æd√©m naƒçten√≠ jak√©koli str√°nky PWA nastav√≠me --song-scale na :root
  (function applyGlobalSongScale(){
    const val = parseFloat(localStorage.getItem(ZPJ_FONT_KEY));
    if (!isNaN(val) && val > 0) {
      document.documentElement.style.setProperty('--song-scale', String(val));
    }
  })();
</script>
<!-- ‚¨Ü‚¨Ü‚¨Ü KONEC NOV√â ƒå√ÅSTI -->

</body>
</html>
