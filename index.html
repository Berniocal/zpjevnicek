<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zpjƒõvn√≠ƒçek</title>

<link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zpjƒõvn√≠ƒçek" />

<style>
  /* Odsazen√≠ + ≈°√≠≈ôka */
  .container{ max-width:min(1200px,96vw); padding-left:2px; padding-right:2px; margin:0 auto; }

  /* --- Vyrovnan√© mezery mezi p√≠smeny v logu --- */
  .logo {
    display: flex;
    align-items: baseline;
    gap: 0.03em;             /* jednotn√° mezera */
    flex-wrap: nowrap;       /* nel√°mat na dva ≈ô√°dky */
  }
  .logo span {
    display: inline-block;
    letter-spacing: 0;
    margin: 0; padding: 0;
  }
  /* Jemn√© srovn√°n√≠ h√°ƒçku nad "ƒõ" */
  .h√°ƒçek {
    display: inline-block;
    transform: translateY(0.5em);
    font-weight: 1000;
    font-size: 4em;
  }

  /* Bez ‚Äûbubliny‚Äú kolem seznamu */
  .card{ background:transparent!important; border:0!important; box-shadow:none!important; padding:0!important; margin:0!important; }
  .card .sep{ display:none!important; }

  /* Layout polo≈æek seznamu + ellipsy */
  #list{ margin:0; padding:0; list-style:none; }
  .item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid #1f2b46; }
  .item .meta{ display:flex; align-items:center; gap:10px; min-width:0; flex:1; }
  .item .meta .badge:first-child{
    width:38px; min-width:38px; height:38px; border-radius:999px;
    display:inline-flex; align-items:center; justify-content:center; padding:0;
    font-variant-numeric: tabular-nums;
  }
  .item .meta .title{
    display:block; flex:1; min-width:0;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .item > .badge{
    max-width:40%; min-width:0;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .controls{ margin:8px 0 10px; display:flex; gap:10px; }
  .controls input{ flex:1; }

  /* Views */
  .view{ display:none; }
  .view.active{ display:block; }

  /* Playlist list */
  #plList{ list-style:none; margin:0; padding:0; }
  .pl-item{ display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #1f2b46; gap:8px; }
  .pl-item .name{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* Playlist detail */
  #plDetailList{ list-style:none; margin:0; padding:0; }
  .pl-song{ display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid #1f2b46; }
  .pl-song .grip{ cursor:grab; user-select:none; }
  .pl-song .title{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .fab{
    position:fixed; right:16px; bottom:16px; width:56px; height:56px; border-radius:999px;
    display:flex; align-items:center; justify-content:center; border:2px solid #2c3b60; background:transparent; color:var(--ink); z-index:5;
  }
  dialog{ border:1px solid #1f2b46; border-radius:12px; background:var(--card); color:var(--ink); }
  dialog::backdrop{ background:rgba(0,0,0,.4); }

  /* QR canvas */
  #qrCanvas{ display:block; width:320px; height:320px; image-rendering: pixelated; margin:12px auto; background:#fff; }
</style>

<!-- QR knihovna ‚Äì spr√°vnƒõ vlo≈æen√© atributy -->
<script defer src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<!-- mal√Ω inline QR engine (MIT, zkr√°cen√Ω) -->
<script>
(function(g){function T(t){this.mode=4,this.data=t}
T.prototype={getLength:function(){return unescape(encodeURIComponent(this.data)).length},
write:function(w){var s=unescape(encodeURIComponent(this.data));for(var i=0;i<s.length;i++)w.push(s.charCodeAt(i),8)}};
function W(){this.buf=[],this.len=0} W.prototype={push:function(v,n){for(var i=n-1;i>=0;i--) this.buf.push((v>>>i)&1),this.len++}};
function QR(){this.modules=null;this.moduleCount=0;this.dataList=[]}
QR.prototype={
 addData:function(s){this.dataList.push(new T(s))},
 make:function(){
  var N=29; this.moduleCount=N; this.modules=[];
  for(var r=0;r<N;r++){this.modules[r]=[]; for(var c=0;c<N;c++) this.modules[r][c]=null}
  var bb=new W();
  for(var i=0;i<this.dataList.length;i++){ bb.push(4,4); var L=this.dataList[i].getLength(); bb.push(L,8); this.dataList[i].write(bb); }
  bb.push(0,4); while(bb.len%8) bb.buf.push(0),bb.len++; while(bb.len<8*50) bb.buf.push(0),bb.len++;
  function isF(r,c){ return (r<7&&c<7)||(r<7&&c>N-8)||(r>N-8&&c<7); }
  var row=N-1,col=N-1,dir=-1,bi=0; var self=this;
  while(col>0){
    if(col===6) col--;
    for(var k=0;k<N;k++){
      var rr=row+dir*k; if(rr<0||rr>=N) continue;
      for(var dc=0;dc<2;dc++){
        var cc=col-dc;
        if(self.modules[rr][cc]!==null||isF(rr,cc)) continue;
        var bit = (bi<bb.buf.length)? bb.buf[bi++] : 0;
        self.modules[rr][cc] = ((rr+cc)&1) ? bit : !bit;
      }
    }
    row += dir*(N-1); dir = -dir; col -= 2;
  }
 },
 drawCanvas:function(canvas, scale){
  var n=this.moduleCount,s=scale||8; canvas.width=canvas.height=n*s;
  var ctx=canvas.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  for(var r=0;r<n;r++)for(var c=0;c<n;c++){
    ctx.fillStyle=this.modules[r][c]?'#000':'#fff'; ctx.fillRect(c*s,r*s,s,s);
  }
 }};
 g._MiniQR={ makeToCanvas:(cv,txt)=>{var q=new QR(); q.addData(txt); q.make(); q.drawCanvas(cv,8);} };
})(window);
</script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <h1 class="logo">
        <span class="w">Z</span>
        <span class="w">p</span>
        <span class="gray">j</span>
        <span class="e">
          <span class="gray">e</span>
          <span class="w h√°ƒçek">Àá</span>
        </span>
        <span class="w">v</span>
        <span class="gray">n√≠ƒçek</span>
      </h1>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <input id="q" placeholder="Hledat n√°zev / autor / ƒç√≠slo‚Ä¶" />
      <select id="sort">
        <option value="number">≈òadit podle ƒç√≠sla</option>
        <option value="title">≈òadit podle abecedy</option>
        <option value="author">≈òadit podle autora</option>
      </select>
      <button id="btnPlaylists">Playlisty</button>
    </div>

    <!-- view: hlavn√≠ seznam -->
    <div id="vMain" class="view active">
      <ul id="list"></ul>
      <div id="empty" class="empty" style="display:none">Zat√≠m tu nic nen√≠. Nahraj soubory do slo≈æky <code>/songs</code>.</div>
    </div>

    <!-- view: seznam playlist≈Ø -->
    <div id="vPl" class="view">
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0 10px">
        <button id="backToMain">‚Üê Zpƒõt na seznam</button>
        <button id="btnImportPl">Nahr√°t playlist (QR)</button>
        <span style="flex:1"></span>
        <button id="btnNewPl">+ Nov√Ω playlist</button>
      </div>
      <ul id="plList"></ul>
    </div>

    <!-- view: detail playlistu -->
    <div id="vPlDetail" class="view">
      <div style="display:flex;align-items:center;gap:8px;margin:8px 0 10px">
        <button id="backToPlaylists">‚Üê Zpƒõt na playlisty</button>
        <strong id="plTitle" style="flex:1">Playlist</strong>
        <button id="plShare">Sd√≠let playlist</button>
      </div>
      <ul id="plDetailList"></ul>
      <button id="addToPl" class="fab" title="P≈ôidat p√≠se≈à">+</button>
    </div>
  </div>

  <div class="footer">üé∏ GitHub Pages ¬∑ alphaTab</div>
</div>

<!-- Dialog QR share -->
<dialog id="dlgShare">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px">
    <strong id="shareTitle">Sd√≠len√≠</strong>
    <button id="dlgShareClose">Zav≈ô√≠t</button>
  </div>
  <canvas id="qrCanvas" width="320" height="320"></canvas>
  <p style="text-align:center;margin:8px 0 0">Naskenuj v ‚ÄûPlaylisty ‚Üí Nahr√°t playlist (QR)‚Äú.</p>
</dialog>

<!-- Dialog p≈ôid√°n√≠ p√≠snƒõ do playlistu -->
<dialog id="dlgAdd">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px">
    <strong>P≈ôidat p√≠se≈à</strong>
    <button id="dlgAddClose">Zav≈ô√≠t</button>
  </div>
  <input id="addQuery" placeholder="N√°zev / autor / ƒç√≠slo‚Ä¶" style="width:100%;margin-bottom:8px" />
  <ul id="addResults" style="list-style:none;margin:0;padding:0;max-height:50vh;overflow:auto"></ul>
</dialog>

<script>
/* ------- data + stav ------- */
const list = document.getElementById('list');
const q = document.getElementById('q');
const sort = document.getElementById('sort');
const empty = document.getElementById('empty');
const V_MAIN = document.getElementById('vMain');
const V_PL = document.getElementById('vPl');
const V_DETAIL = document.getElementById('vPlDetail');

let songs = [];
let playlists = [];   // [{id, name, items:[songId,...]}]
let CUR_PL = null;

/* ------- utils ------- */
function show(v){
  for (const el of [V_MAIN,V_PL,V_DETAIL]) el.classList.remove('active');
  v.classList.add('active');
}
function savePlaylists(){ localStorage.setItem('zpj_playlists', JSON.stringify(playlists)); }
function loadPlaylists(){ playlists = JSON.parse(localStorage.getItem('zpj_playlists')||'[]'); }
function byId(id){ return songs.find(s=>s.id===id); }

/* ------- naƒçten√≠ p√≠sn√≠ ------- */
async function load(){
  try{
    const res = await fetch('/zpjevnicek/data/songs.json', { cache: 'no-store' });
    songs = await res.json();
  }catch(e){ songs = []; }
  renderMain();
  loadPlaylists();
  renderPlaylistList();

  // otev≈ôen√≠ dle hash (#pl:<id>)
  (function handleHash(){
    const h = (location.hash || '').slice(1);
    if (h.startsWith('pl:')) {
      const pid = decodeURIComponent(h.slice(3));
      openPlaylist(pid);
      return;
    }
    if (h === 'playlists') {
      show(V_PL);
    }
  })();
}

/* ------- hlavn√≠ seznam ------- */
function renderMain(){
  const term = q.value.trim().toLowerCase();
  const srt = sort.value;
  let data = songs.filter(s =>
    s.title.toLowerCase().includes(term) ||
    (s.author||'').toLowerCase().includes(term) ||
    String(s.number||'').includes(term)
  );
  data.sort((a,b)=>{
    if(srt==='number') return (a.number??99999)-(b.number??99999) || a.title.localeCompare(b.title);
    if(srt==='author') return (a.author||'').localeCompare(b.author||'') || a.title.localeCompare(b.title);
    return a.title.localeCompare(b.title);
  });
  list.innerHTML = data.map(s => `
    <li class="item">
      <div class="meta">
        <span class="badge">${s.number ?? '‚Äì'}</span>
        <a class="title" href="/zpjevnicek/song.html?id=${encodeURIComponent(s.id)}">${s.title}</a>
      </div>
      <div class="badge">${s.author || ''}</div>
    </li>`).join('');
  empty.style.display = data.length ? 'none' : 'block';
}

/* ------- playlisty ‚Äì seznam ------- */
function renderPlaylistList(){
  const ul = document.getElementById('plList');
  ul.innerHTML = playlists.map(p => `
    <li class="pl-item">
      <a class="name" data-open="${p.id}" href="#">${p.name}</a>
      <button data-del="${p.id}" title="Smazat">üóë</button>
    </li>
  `).join('');

  ul.querySelectorAll('[data-open]').forEach(a=>{
    a.addEventListener('click', (e)=>{ e.preventDefault(); openPlaylist(a.dataset.open); });
  });
  ul.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=btn.dataset.del;
      if(!confirm('Smazat playlist?')) return;
      playlists = playlists.filter(p=>p.id!==id);
      savePlaylists(); renderPlaylistList();
    });
  });
}

/* ------- playlist ‚Äì detail ------- */
function openPlaylist(id){
  CUR_PL = playlists.find(p=>p.id===id);
  if(!CUR_PL){ show(V_PL); return; }
  location.hash = 'pl:'+encodeURIComponent(id);
  renderPlaylistDetail();
  show(V_DETAIL);

  // aktivuj sd√≠len√≠
  document.getElementById('plShare').onclick = ()=> sharePlaylist(CUR_PL.id);
}
function renderPlaylistDetail(){
  document.getElementById('plTitle').textContent = CUR_PL?.name || 'Playlist';
  const ul = document.getElementById('plDetailList');
  ul.innerHTML = (CUR_PL.items||[]).map((sid,idx)=>{
    const s = byId(sid) || { title:'(chyb√≠)', author:'', number:'‚Äì' };
    return `<li class="pl-song" draggable="true" data-idx="${idx}">
      <span class="grip">‚â°</span>
      <a class="title" href="/zpjevnicek/song.html?id=${encodeURIComponent(sid)}&pl=${encodeURIComponent(CUR_PL.id)}">${s.number??'‚Äì'} ¬∑ ${s.title}</a>
      <small>${s.author||''}</small>
      <button data-rm="${idx}" title="Odebrat">‚úñ</button>
    </li>`;
  }).join('');

  // drag & drop
  let dragIdx = -1;
  ul.querySelectorAll('.pl-song').forEach(li=>{
    li.addEventListener('dragstart', ()=>{ dragIdx = +li.dataset.idx; li.classList.add('drag'); });
    li.addEventListener('dragend', ()=> li.classList.remove('drag'));
    li.addEventListener('dragover', (e)=> e.preventDefault());
    li.addEventListener('drop', (e)=>{
      e.preventDefault();
      const to = +li.dataset.idx;
      if(dragIdx===to) return;
      const x = CUR_PL.items.splice(dragIdx,1)[0];
      CUR_PL.items.splice(to,0,x);
      savePlaylists(); renderPlaylistDetail();
    });
  });

  // odebrat
  ul.querySelectorAll('[data-rm]').forEach(btn=>{
    btn.onclick = ()=>{ const i=+btn.dataset.rm; CUR_PL.items.splice(i,1); savePlaylists(); renderPlaylistDetail(); };
  });
}

/* ------- nov√Ω playlist ------- */
document.getElementById('btnNewPl').onclick = ()=>{
  const name = prompt('N√°zev playlistu:');
  if(!name) return;
  const id = 'pl_' + Math.random().toString(36).slice(2,9);
  playlists.push({ id, name, items: [] });
  savePlaylists(); renderPlaylistList(); openPlaylist(id);
};

/* ------- P≈ôidat p√≠se≈à do playlistu ------- */
const dlgAdd = document.getElementById('dlgAdd');
document.getElementById('addToPl').onclick = ()=>{ if(!CUR_PL) return; dlgAdd.showModal(); renderAddResults(''); document.getElementById('addQuery').value=''; document.getElementById('addQuery').focus(); };
document.getElementById('dlgAddClose').onclick = ()=> dlgAdd.close();
document.getElementById('addQuery').addEventListener('input', e=> renderAddResults(e.target.value));

function renderAddResults(term){
  term = (term||'').toLowerCase();
  const ul = document.getElementById('addResults');
  const data = songs.filter(s =>
    s.title.toLowerCase().includes(term) ||
    (s.author||'').toLowerCase().includes(term) ||
    String(s.number||'').includes(term)
  ).slice(0,50);
  ul.innerHTML = data.map(s=>`<li style="display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #1f2b46">
    <span class="badge" style="width:38px;height:38px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center">${s.number??'‚Äì'}</span>
    <div style="flex:1;min-width:0">
      <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.title}</div>
      <small>${s.author||''}</small>
    </div>
    <button data-add="${s.id}">P≈ôidat</button>
  </li>`).join('');
  ul.querySelectorAll('[data-add]').forEach(btn=>{
    btn.onclick = ()=>{ CUR_PL.items.push(btn.dataset.add); savePlaylists(); renderPlaylistDetail(); dlgAdd.close(); };
  });
}

/* ------- Sd√≠len√≠ playlistu (QR) ------- */
const dlgShare = document.getElementById('dlgShare');
document.getElementById('dlgShareClose').onclick = ()=> dlgShare.close();
function drawQR(canvas, text){ window._MiniQR.makeToCanvas(canvas, text); }

function sharePlaylist(id){
  const pl = playlists.find(p=>p.id===id); if(!pl) return;
  const payload = JSON.stringify(pl);
  document.getElementById('shareTitle').textContent = 'Sd√≠len√≠: ' + pl.name;
  const cv = document.getElementById('qrCanvas');
  drawQR(cv, payload);
  dlgShare.showModal();
}

/* ------- Import playlistu (QR) ------- */
document.getElementById('btnImportPl').onclick = async ()=>{
  // jednoduch√Ω import p≈ôes vlo≈æen√≠ textu (z QR ƒçteƒçky jin√©ho telefonu),
  // pokud dostupn√Ω BarcodeDetector -> pou≈æij kameru
  if ('BarcodeDetector' in window) {
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }});
      const video = document.createElement('video');
      video.playsInline = true; video.srcObject = stream; await video.play();
      const det = new BarcodeDetector({ formats: ['qr_code']});
      let active = true;
      const scan = async ()=>{
        if(!active) return;
        const codes = await det.detect(video);
        if(codes.length){
          active=false; stream.getTracks().forEach(t=>t.stop());
          try{
            const data = JSON.parse(codes[0].rawValue);
            if (!data.id) throw 0;
            playlists = playlists.filter(p=>p.id!==data.id).concat([data]);
            savePlaylists(); renderPlaylistList(); openPlaylist(data.id);
          }catch(e){ alert('Neplatn√Ω QR obsah.'); }
          return;
        }
        requestAnimationFrame(scan);
      };
      scan();
      alert('Nam√≠≈ô kameru na QR k√≥d playlistu. Po naƒçten√≠ se okno samo zav≈ôe.');
    }catch(e){
      const raw = prompt('Vlo≈æ obsah QR (text):');
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        playlists = playlists.filter(p=>p.id!==data.id).concat([data]);
        savePlaylists(); renderPlaylistList(); openPlaylist(data.id);
      }catch(_){ alert('Neplatn√Ω obsah.'); }
    }
  } else {
    const raw = prompt('Vlo≈æ obsah QR (text):');
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      playlists = playlists.filter(p=>p.id!==data.id).concat([data]);
      savePlaylists(); renderPlaylistList(); openPlaylist(data.id);
    }catch(_){ alert('Neplatn√Ω obsah.'); }
  }
};

/* ------- navigace mezi views ------- */
document.getElementById('btnPlaylists').onclick = ()=>{ location.hash='playlists'; show(V_PL); renderPlaylistList(); };
document.getElementById('backToMain').onclick = ()=>{ location.hash=''; show(V_MAIN); };
document.getElementById('backToPlaylists').onclick = ()=>{ location.hash='playlists'; show(V_PL); renderPlaylistList(); };

/* ------- filtry ------- */
q.addEventListener('input', renderMain);
sort.addEventListener('change', renderMain);

/* ------- SW + auto-update ------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' });
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      reg.addEventListener('updatefound', () => {
        const sw = reg.installing;
        if (!sw) return;
        sw.addEventListener('statechange', () => {
          if (sw.state === 'installed' && navigator.serviceWorker.controller) {
            sw.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      });
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return; refreshing = true; window.location.reload();
      });
      setInterval(() => reg.update().catch(()=>{}), 60*60*1000);
    } catch (e) { console.error(e); }
  });
}

/* ------- Prefetch p√≠sn√≠ p≈ôi dobr√©m p≈ôipojen√≠ ------- */
function goodConnection(){
  const c = navigator.connection || navigator.webkitConnection || navigator.mozConnection;
  if (!c) return true;
  if (c.saveData) return false;
  const ok = ['wifi','ethernet','unknown'];
  return ok.includes(c.type) || (c.effectiveType||'').includes('4g');
}
async function prefetchAllSongs(){
  if (!navigator.onLine) return;
  if (!goodConnection()) return;
  try{
    const reg = await navigator.serviceWorker.getRegistration('/zpjevnicek/');
    if (reg && reg.active) reg.active.postMessage({ type: 'CACHE_ALL_SONGS', chunkSize: 6, reportProgress: false });
  }catch(e){ }
}
window.addEventListener('load', prefetchAllSongs);
setInterval(prefetchAllSongs, 30*60*1000);

/* ------- glob√°ln√≠ scale pro song.html ------- */
const ZPJ_FONT_KEY = 'zpj-fontScale';
(function applyGlobalSongScale(){
  const val = parseFloat(localStorage.getItem(ZPJ_FONT_KEY));
  if (!isNaN(val) && val > 0) {
    document.documentElement.style.setProperty('--song-scale', String(val));
  }
})();
load();
</script>
</body>
</html>
