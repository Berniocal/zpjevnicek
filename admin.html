<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SprÃ¡va pÃ­snÃ­</title>
<link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="ZpjÄ›vnÃ­Äek" />

<style>
.grid{display:grid;gap:10px}
.two{grid-template-columns:1fr 1fr}
.full{grid-column:1 / -1;}
.editor,.editor textarea,.editor .marks,.editor .mirror{
  --ed-font: ui-monospace,SFMono-Regular,Menlo,monospace;
  --ed-size:16px;--ed-line:24px;--ed-pad:8px;
  font-family:var(--ed-font);font-size:var(--ed-size);line-height:var(--ed-line);
  box-sizing:border-box;tab-size:4;
}
.editor{position:relative;overflow:hidden}
.editor textarea{width:100%;min-height:520px;resize:vertical;background:transparent;color:#fff;position:relative;z-index:1;padding:var(--ed-pad)}
.marks{position:absolute;inset:0;z-index:2;pointer-events:none;overflow:hidden;padding:var(--ed-pad)}
.marks-content{position:relative;min-height:100%;will-change:transform}
.mirror{position:absolute;inset:0;padding:var(--ed-pad);white-space:pre-wrap;overflow-wrap:anywhere;visibility:hidden;z-index:-1}
.mark{position:absolute;left:0;right:0;height:2px;background:#ef4444;border-radius:1px}
#toggleMarks{align-self:end;justify-self:end;padding:6px 10px;font-size:14px}
.limitCtl{display:flex;gap:6px;align-items:center;justify-content:flex-end}
#limitVal{width:84px}
details.accordion{border:1px solid #1f2b46;border-radius:10px;padding:0;margin-top:14px;background:var(--card)}
details.accordion>summary{list-style:none;cursor:pointer;padding:12px 14px;font-weight:600;display:flex;align-items:center;gap:8px;user-select:none}
details.accordion>summary::before{content:'â–¸';transition:transform .15s ease;display:inline-block}
details.accordion[open]>summary::before{transform:rotate(90deg)}
details.accordion .accordion-body{padding:0 14px 14px}
details.accordion .accordion-body>.card{margin-top:12px}
details.accordion .accordion-body>.card:first-child{margin-top:0}
</style>
</head>

<body>
<div class="container">
  <div class="header"><h1 style="margin:0">SprÃ¡va pÃ­snÃ­</h1><a href="index.html">â† ZpÄ›t</a></div>

  <!-- ========== SEKCE 1: VLOÅ½IT NOVOU PÃSEÅ‡ ========== -->
  <details class="accordion" open>
    <summary>VloÅ¾it novou pÃ­seÅˆ</summary>
    <div class="accordion-body">
      <div class="card">
        <div class="grid two">
          <label>Token (PAT)
            <input id="token" placeholder="ghp_â€¦ nebo github_pat_â€¦" />
            <div class="note">Scopes: <code>Repository contents â†’ Read and write</code></div>
          </label>
          <div>
            <button id="saveToken">UloÅ¾it token</button>
            <button id="clearToken">Smazat token</button>
          </div>
        </div>

        <hr class="sep"/>

        <div class="grid two">
          <label>NÃ¡zev pÃ­snÄ› <input id="title" placeholder="Greensleeves"></label>
          <label>Autor <input id="artist" placeholder="Traditional"></label>
        </div>

        <div class="grid two">
          <label>ÄŒÃ­slo (volitelnÃ©) <input id="number" type="number" min="1"></label>
          <label>Tonina <input id="key" placeholder="Am"></label>
          <label>FormÃ¡t vstupu
            <select id="fmt">
              <option value="auto" selected>Auto</option>
              <option value="chordpro">ChordPro</option>
              <option value="ug">Ultimate Guitar</option>
            </select>
          </label>
          <div class="limitCtl">
            <button id="toggleMarks">âš™ UpozornÄ›nÃ­: zapnuto</button>
            <input id="limitVal" type="number" min="10" max="200" step="1" />
            <button id="applyLimit">Nastavit limit</button>
          </div>
        </div>

        <!-- ğŸ“š ZpÄ›vnÃ­ky -->
        <div id="bookList" class="full">
          <label>ZpÄ›vnÃ­ky (volitelnÃ©)</label>
          <div id="bookRows"></div>
          <button id="addBookBtn" type="button" style="margin-top:6px;">+ PÅ™idat zpÄ›vnÃ­k</button>
        </div>

        <label class="full">Text (ChordPro)
          <div class="editor">
            <div id="marks" class="marks"><div id="marksContent" class="marks-content"></div></div>
            <textarea id="body" placeholder="[Am]Alas my loveâ€¦"></textarea>
            <div id="mirror" class="mirror" aria-hidden="true"></div>
          </div>
        </label>

        <div class="grid two">
          <label>NÃ¡zev souboru (automaticky)
            <input id="filename" readonly>
            <div class="note">UloÅ¾Ã­ se do <code>/songs</code>.</div>
          </label>
          <div style="display:flex;gap:8px;align-items:end;justify-content:flex-end">
            <button id="saveBtn">ğŸ’¾ UloÅ¾it do GitHubu</button>
          </div>
        </div>
        <div id="status" class="note" style="margin-top:8px"></div>
      </div>
    </div>
  </details>

  <!-- ========== SEKCE 2: UPRAVIT / SMAZAT ========== -->
  <details class="accordion">
    <summary>Upravit existujÃ­cÃ­ pÃ­seÅˆ</summary>
    <div class="accordion-body">
      <div class="card">
        <div class="grid two">
          <label>Vyhledat <input id="editSearch" placeholder="napÅ™. 'Greensleeves' nebo 12"></label>
          <div style="align-self:end;justify-self:end"><button id="reloadIndex">â†» NaÄÃ­st seznam</button></div>
        </div>
        <div id="editResults" class="list" style="margin-top:8px"></div>

        <hr class="sep"/>
        <div class="grid two">
          <label>NÃ¡zev pÃ­snÄ› <input id="eTitle"></label>
          <label>Autor <input id="eArtist"></label>
        </div>
        <div class="grid two">
          <label>ÄŒÃ­slo <input id="eNumber" type="number"></label>
          <label>Tonina <input id="eKey"></label>
        </div>

        <!-- ğŸ“š ZpÄ›vnÃ­ky edit -->
        <div id="eBookList" class="full">
          <label>ZpÄ›vnÃ­ky (volitelnÃ©)</label>
          <div id="eBookRows"></div>
          <button id="addEBookBtn" type="button" style="margin-top:6px;">+ PÅ™idat zpÄ›vnÃ­k</button>
        </div>

        <label class="full">Text (ChordPro)
          <div class="editor">
            <div id="editMarks" class="marks"><div id="editMarksContent" class="marks-content"></div></div>
            <textarea id="editBody"></textarea>
            <div id="editMirror" class="mirror" aria-hidden="true"></div>
          </div>
        </label>

        <div class="grid two">
          <label>Cesta v repozitÃ¡Å™i <input id="editPath" readonly></label>
          <div style="display:flex;gap:8px;align-items:end;justify-content:flex-end">
            <button id="saveEditBtn">ğŸ’¾ UloÅ¾it zmÄ›ny</button>
            <button id="deleteEditBtn" class="danger">ğŸ—‘ Smazat pÃ­seÅˆ</button>
          </div>
        </div>
        <div id="editStatus" class="note" style="margin-top:8px"></div>
      </div>
    </div>
  </details>
</div>

<script>
const qs = s=>document.querySelector(s);
const statusEl = qs('#status');
const titleEl = qs('#title'), artistEl = qs('#artist'), numberEl = qs('#number'), keyEl = qs('#key');
const bodyEl = qs('#body'), filenameEl = qs('#filename');
const marksEl = document.getElementById('marks'), marksContentEl = document.getElementById('marksContent'), mirrorEl = document.getElementById('mirror');
const toggleMarksBtn = document.getElementById('toggleMarks');
const limitInput = document.getElementById('limitVal'), applyLimitBtn = document.getElementById('applyLimit');
let rowLimit = Number(localStorage.getItem('row_limit') || '30'); limitInput.value = rowLimit;
const CHORD_BRACKETS_RE = /\[[^\]]*]/g; let marksEnabled = true;

function slug(s){return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}
function b64utf8(str){return btoa(unescape(encodeURIComponent(str)));}
function status(msg,ok=false){statusEl.textContent=msg;statusEl.className='note'+(ok?' ok':'');}
function computeFilename(){
  const n = numberEl.value ? String(numberEl.value).padStart(3,'0')+'-' : '';
  const t = slug(titleEl.value||'pisen');
  const a = slug(artistEl.value||'');
  filenameEl.value = `${n}${t}${a?'-'+a:''}.pro`;
}
['input','change'].forEach(ev=>{titleEl.addEventListener(ev,computeFilename);artistEl.addEventListener(ev,computeFilename);numberEl.addEventListener(ev,computeFilename);});
computeFilename();

// token storage
const tokenEl=qs('#token');
const saved=localStorage.getItem('gh_pat');
if(saved)tokenEl.value=saved;
qs('#saveToken').onclick=()=>{localStorage.setItem('gh_pat',tokenEl.value.trim());status('Token uloÅ¾en.',true);};
qs('#clearToken').onclick=()=>{localStorage.removeItem('gh_pat');tokenEl.value='';status('Token smazÃ¡n.',true);};

function detectRepo(){
  const host=location.host;
  const parts=location.pathname.split('/').filter(Boolean);
  const repo=parts.length?parts[0]:'';
  const user=host.includes('github.io')?host.split('.')[0]:'';
  return {user,repo};
}

/* ---------- zvÃ½raznÄ›nÃ­ dlouhÃ½ch Å™Ã¡dkÅ¯ ---------- */
function escapeHtml(s){return s.replace(/[&<>]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));}
function rebuildMarks(){
  if(!marksEnabled){marksContentEl.innerHTML='';marksContentEl.style.height='0';marksEl.style.display='none';return;}
  marksEl.style.display='';
  const text=bodyEl.value.replace(/\r/g,'');const lines=text.split('\n');
  mirrorEl.innerHTML='';
  for(let i=0;i<lines.length;i++){const span=document.createElement('span');span.className='line';span.innerHTML=lines[i].length?escapeHtml(lines[i]):' ';mirrorEl.appendChild(span);if(i<lines.length-1)mirrorEl.appendChild(document.createElement('br'));}
  const overIdx=new Set();lines.forEach((L,i)=>{const visible=L.replace(CHORD_BRACKETS_RE,'');if(visible.length>rowLimit)overIdx.add(i);});
  marksContentEl.innerHTML='';marksContentEl.style.height=mirrorEl.scrollHeight+'px';
  const spans=mirrorEl.querySelectorAll('.line');spans.forEach((span,i)=>{if(!overIdx.has(i))return;const top=span.offsetTop+span.offsetHeight-2;const mark=document.createElement('div');mark.className='mark';mark.style.top=top+'px';marksContentEl.appendChild(mark);});
}
bodyEl.addEventListener('scroll',()=>{marksContentEl.style.transform=`translate(${-bodyEl.scrollLeft}px,${-bodyEl.scrollTop}px)`;mirrorEl.scrollTop=bodyEl.scrollTop;mirrorEl.scrollLeft=bodyEl.scrollLeft;});
['input','change','keyup'].forEach(ev=>bodyEl.addEventListener(ev,rebuildMarks));
window.addEventListener('resize',rebuildMarks);rebuildMarks();
toggleMarksBtn.addEventListener('click',()=>{marksEnabled=!marksEnabled;toggleMarksBtn.textContent=marksEnabled?'âš™ UpozornÄ›nÃ­: zapnuto':'âš™ UpozornÄ›nÃ­: vypnuto';rebuildMarks();});
applyLimitBtn.addEventListener('click',()=>{const v=Number(limitInput.value);if(!Number.isFinite(v)||v<1)return;rowLimit=v;localStorage.setItem('row_limit',String(rowLimit));rebuildMarks();});

/* ---------- ZPÄšVNÃKY ---------- */
function createBookRow(container,name='',num=''){
  const wrap=document.createElement('div');
  wrap.style.display='flex';wrap.style.gap='6px';wrap.style.marginTop='6px';
  const nameInput=document.createElement('input');nameInput.placeholder='NÃ¡zev zpÄ›vnÃ­ku';nameInput.value=name;nameInput.style.flex='2';
  const numInput=document.createElement('input');numInput.type='number';numInput.placeholder='ÄŒÃ­slo';numInput.value=num;numInput.style.width='90px';
  const delBtn=document.createElement('button');delBtn.textContent='ğŸ—‘';delBtn.onclick=()=>wrap.remove();
  wrap.append(nameInput,numInput,delBtn);container.appendChild(wrap);
}
const bookRows=document.getElementById('bookRows');const addBookBtn=document.getElementById('addBookBtn');
if(bookRows&&addBookBtn)addBookBtn.onclick=()=>createBookRow(bookRows);
const eBookRows=document.getElementById('eBookRows');const addEBookBtn=document.getElementById('addEBookBtn');
if(eBookRows&&addEBookBtn)addEBookBtn.onclick=()=>createBookRow(eBookRows);
function collectBooks(container){
  const obj={};if(!container)return obj;
  container.querySelectorAll('div').forEach(row=>{
    const [name,num]=row.querySelectorAll('input');
    const n=name?.value.trim();const v=num?.value.trim();
    if(n)obj[n]=v?Number(v):null;
  });
  return obj;
}
</script>

<script>
if('serviceWorker'in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('/zpjevnicek/sw.js',{scope:'/zpjevnicek/'}).then(r=>console.log('SW scope',r.scope)).catch(console.error);
  });
}
</script>
</body>
</html>
