<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spr√°va p√≠sn√≠</title>
  <link rel="stylesheet" href="assets/style.css" />
<link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
<meta name="theme-color" content="#0f1729" />
<link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Zpjƒõvn√≠ƒçek" />


  <style>
    .grid{display:grid;gap:10px}
.two{grid-template-columns:1fr 1fr}
.full{grid-column:1 / -1;}           /* polo≈æka p≈ôes celou ≈°√≠≈ôku gridu */
textarea{
  width:100%;                        /* rozt√°hne na celou ≈°√≠≈ôku */
  min-height:520px;                  /* bylo ~320px ‚Üí +~50 % */
  resize:vertical;                   /* povolit ruƒçn√≠ zvƒõt≈°en√≠ v√Ω≈°ky */
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace; /* a≈• sed√≠ akordy */
  line-height:1.6;
}
    /* overlay pro fullscreen n√°hled */
.overlay{
  position:fixed; inset:0; z-index:9999;
  background:rgba(0,0,0,.8);
  backdrop-filter: blur(2px);
  display:none;
}
.overlay.open{ display:block; }
.stage{ position:absolute; inset:0; display:flex; flex-direction:column; }
.toolbar{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; padding:10px 14px;
  background:#0f1729; border-bottom:1px solid #24324a; color:#eaf1ff;
}
.viewer{ flex:1; overflow:auto; padding:18px; }

/* ChordPro render uvnit≈ô n√°hledu */
.overlay .cp{ font-size: var(--fs, 22px); line-height:1.9; color:#eaf1ff; }
.overlay .cp .line{ position:relative; white-space:pre-wrap; }
.overlay .cp .seg{ position:relative; display:inline-block; padding-top:1.1em; }
.overlay .cp .ch{ position:absolute; left:0; top:0; font-weight:700;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9em }
.overlay .cp .ly{ visibility:visible }
  </style>

</head>
<body>
  <div class="container">
    <div class="header"><h1 style="margin:0">P≈ôidat p√≠se≈à (ChordPro)</h1><a href="index.html">‚Üê Zpƒõt</a></div>

    <div class="card">
      <p>
        Vlo≈æ <b>text s akordy (ChordPro)</b> ‚Äì nap≈ô. <code>[Am]Alas my love...</code> ‚Äì dopl≈à n√°zev a autora
        a klikni <b>Ulo≈æit do GitHubu</b>. Soubor se ulo≈æ√≠ do slo≈æky <code>/songs</code> a GitHub Action
        automaticky aktualizuje seznam.
      </p>
      <p class="note">Token (PAT) se ukl√°d√° jen do tv√©ho prohl√≠≈æeƒçe (<span class="kbd">localStorage</span>).
         Nepat≈ô√≠ do k√≥du ani do repozit√°≈ôe.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="grid two">
        <label>Token (PAT)
          <input id="token" placeholder="ghp_‚Ä¶ nebo github_pat_‚Ä¶" />
          <div class="note">Scopes: <code>Repository contents ‚Üí Read and write</code> pro vybran√Ω repozit√°≈ô.</div>
        </label>
        <div>
          <button id="saveToken">Ulo≈æit token do prohl√≠≈æeƒçe</button>
          <button id="clearToken">Smazat token</button>
        </div>
      </div>
      <hr class="sep"/>
      <div class="grid two">
        <label>N√°zev p√≠snƒõ
          <input id="title" placeholder="Greensleeves" />
        </label>
        <label>Autor
          <input id="artist" placeholder="Traditional" />
        </label>
      </div>
      <div class="grid two">
        <label>ƒå√≠slo (voliteln√© pro ≈ôazen√≠)
          <input id="number" type="number" min="1" step="1" placeholder="1" />
        </label>
        <label>Tonina (volitelnƒõ ‚Äì meta)
          <input id="key" placeholder="Am" />
        </label>
        <label>Form√°t vstupu
  <select id="fmt">
    <option value="auto" selected>Auto</option>
    <option value="chordpro">ChordPro</option>
    <option value="ug">Ultimate Guitar</option>
  </select>
</label>

      </div>
      <label class="full">Text (ChordPro)
  <textarea id="body" placeholder="[Am]Alas my love‚Ä¶"></textarea>
</label>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px">
  <button id="previewBtn">üëÅ N√°hled / Cel√° obrazovka</button>
</div>
      <div class="grid two">
        <label>N√°zev souboru (automaticky)
          <input id="filename" readonly />
          <div class="note">Ulo≈æ√≠ se do <code>/songs</code> jako <code>NNN-nazev-autor.pro</code>.</div>
        </label>
        <div style="display:flex;gap:8px;align-items:end;justify-content:flex-end">
          <button id="saveBtn">üíæ Ulo≈æit do GitHubu</button>
        </div>
      </div>
      <div id="status" class="note" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Jak z√≠skat token</h3>
      <ol>
        <li>GitHub ‚Üí <b>Settings</b> (profil) ‚Üí <b>Developer settings</b> ‚Üí <b>Fine-grained tokens</b>.</li>
        <li>Vyber jen tento repozit√°≈ô, dej opr√°vnƒõn√≠ <b>Repository contents: Read and write</b>, vygeneruj.</li>
        <li>Token vlo≈æ do pole v√Ω≈°e a ulo≈æ.</li>
      </ol>
    </div>
  </div>
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="stage">
    <div class="toolbar">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <strong>N√°hled p√≠snƒõ</strong>
        <button id="fsToggle">Na celou obrazovku</button>
        <span>Velikost: 
          <button id="fsDown" title="Zmen≈°it">‚àí</button>
          <span id="fsVal" style="min-width:3ch; display:inline-block; text-align:center">22</span>
          <button id="fsUp" title="Zvƒõt≈°it">+</button>
        </span>
      </div>
      <button id="closeOverlay" title="Zav≈ô√≠t">‚úï</button>
    </div>
    <div id="overlayView" class="viewer"></div>
  </div>
</div>

<script>
const qs = s=>document.querySelector(s);
const statusEl = qs('#status');
const titleEl = qs('#title');
const artistEl = qs('#artist');
const numberEl = qs('#number');
const keyEl = qs('#key');
const bodyEl = qs('#body');
const filenameEl = qs('#filename');

function slug(s){ return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function b64utf8(str){ return btoa(unescape(encodeURIComponent(str))); }
function status(msg, ok=false){ statusEl.textContent = msg; statusEl.className = 'note' + (ok?' ok':''); }

function computeFilename(){
  const n = numberEl.value ? String(numberEl.value).padStart(3,'0')+'-' : '';
  const t = slug(titleEl.value||'pisen');
  const a = slug(artistEl.value||'');
  filenameEl.value = `${n}${t}${a?'-'+a:''}.pro`;
}
['input','change'].forEach(ev=>{
  titleEl.addEventListener(ev, computeFilename);
  artistEl.addEventListener(ev, computeFilename);
  numberEl.addEventListener(ev, computeFilename);
});
computeFilename();

// token storage
const tokenEl = qs('#token');
const saved = localStorage.getItem('gh_pat');
if(saved) tokenEl.value = saved;
qs('#saveToken').onclick = ()=>{ localStorage.setItem('gh_pat', tokenEl.value.trim()); status('Token ulo≈æen.', true); };
qs('#clearToken').onclick = ()=>{ localStorage.removeItem('gh_pat'); tokenEl.value=''; status('Token smaz√°n.', true); };

function detectRepo(){
  const host = location.host;                 // user.github.io
  const parts = location.pathname.split('/').filter(Boolean);
  const repo = parts.length? parts[0] : '';
  const user = host.includes('github.io') ? host.split('.')[0] : '';
  return {user, repo};
}
// --- detekce "chord" tokenu ---
const CHORD_RE = /^(?:[A-G](?:#|b)?)(?:maj|min|dim|aug|sus[24]?|add\d+|m|maj7|m7|7|6|9|11|13)?(?:\/[A-G](?:#|b)?)?$/;

// --- ≈ô√°dek je "akordov√° linka" (jen akordy, mezery, |, -, /, ( ) ) ---
function isChordLine(line) {
  const t = line.trim();
  if (!t) return false;
  // pokud m√° moc dlouh√° slova, nen√≠ to akordov√° linka
  const parts = t.split(/\s+/);
  let chordy = 0, ostatni = 0;
  for (const p of parts) {
    if (!p) continue;
    const clean = p.replace(/[|()\-¬∑‚Ä¢.]+/g, '');
    if (!clean) continue;
    if (CHORD_RE.test(clean)) chordy++;
    else ostatni++;
  }
  return chordy > 0 && ostatni === 0;
}

// --- zarovn√°n√≠ akordov√© linky nad text ‚Üí vlo≈æ√≠ [Akord] do textu kolem sloupeƒçk≈Ø ---
function mergeChordAndLyrics(chordsLine, lyricLine){
  // najdi sloupcov√© pozice akord≈Ø
  const pos = [];
  let i = 0;
  while (i < chordsLine.length){
    // p≈ôeskoƒç mezery
    while (i < chordsLine.length && chordsLine[i] === ' ') i++;
    if (i >= chordsLine.length) break;
    const start = i;
    while (i < chordsLine.length && chordsLine[i] !== ' ') i++;
    const token = chordsLine.slice(start, i).replace(/[|()\-¬∑‚Ä¢.]+/g, '');
    if (CHORD_RE.test(token)) pos.push({col:start, chord:token});
  }
  if (!pos.length) return lyricLine;

  // vlo≈æ akordy do textu podle sloupc≈Ø (nejbli≈æ≈°√≠ vhodn√Ω index)
  let out = lyricLine;
  // vkl√°d√°me odzadu, aby se indexy neposouvaly
  pos.sort((a,b)=>b.col-a.col).forEach(p=>{
    const idx = Math.min(Math.max(p.col, 0), out.length);
    out = out.slice(0, idx) + `[${p.chord}]` + out.slice(idx);
  });
  return out;
}

// --- konverze UG ‚Üí ChordPro ---
// 1) [ch]Am[/ch] ‚Üí [Am]
// 2) akordov√© ≈ô√°dky + n√°sleduj√≠c√≠ text slouƒç√≠me do jedn√© ≈ô√°dky s [Akord]
// 3) [Verse]/[Chorus]/(Verse) ‚Üí {comment: Verse}
function ugToChordPro(text){
  let t = text.replace(/\r/g,'');
  // [ch]C[/ch] ‚Üí [C]
  t = t.replace(/\[ch\]\s*([^\[]+?)\s*\[\/ch\]/gi, (_m, g1) => `[${g1.trim()}]`);

  const lines = t.split('\n');
  const out = [];
  for (let i = 0; i < lines.length; i++){
    const L = lines[i];

    // sekƒçn√≠ hlaviƒçky
    const sec = L.match(/^\s*(?:\[(verse|chorus|bridge|intro|outro|solo)\]|\((verse|chorus|bridge|intro|outro|solo)\))\s*$/i);
    if (sec) { out.push(`{comment: ${ (sec[1]||sec[2]).toLowerCase() }}`); continue; }

    // akordov√° + textov√° linka
    if (isChordLine(L) && i+1 < lines.length){
      out.push( mergeChordAndLyrics(L, lines[i+1] || '') );
      i++; // p≈ôeskoƒç lyric line, u≈æ jsme ji slouƒçili
      continue;
    }

    // jinak ponech ≈ô√°dek (u≈æ m≈Ø≈æe obsahovat [C]‚Ä¶ d√≠ky [ch] n√°hradƒõ)
    out.push(L);
  }

  // zjemni v√≠cen√°sobn√© pr√°zdn√© ≈ô√°dky
  const compact = [];
  let prevEmpty = false;
  for (const r of out){
    const empty = !r.trim();
    if (empty && prevEmpty) continue;
    compact.push(r);
    prevEmpty = empty;
  }
  return compact.join('\n');
}

qs('#saveBtn').onclick = async ()=>{
  try{
    const {user, repo} = detectRepo();
    if(!user || !repo) return status('Nepoda≈ôilo se odvodit user/repo z URL. Ulo≈æ soubor ruƒçnƒõ p≈ôes GitHub UI.', false);
    const token = tokenEl.value.trim();
    if(!token) return status('Vlo≈æ pros√≠m PAT token.', false);
    if(!titleEl.value.trim()) return status('Dopl≈à n√°zev p√≠snƒõ.', false);

    // ChordPro obsah s metadaty
    const lines = [];
    lines.push(`{title: ${titleEl.value.trim()}}`);
    if(artistEl.value.trim()) lines.push(`{artist: ${artistEl.value.trim()}}`);
    if(keyEl.value.trim()) lines.push(`{key: ${keyEl.value.trim()}}`);
    lines.push('');
    lines.push(bodyEl.value.replace(/\r/g,''));
    const content = lines.join('\n');

    const filename = filenameEl.value || 'pisen.pro';
    const path = `songs/${filename}`;

    status('Ukl√°d√°m‚Ä¶');
    const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}` ,{
      method:'PUT',
      headers:{
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `feat(song): add ${titleEl.value.trim()}`,
        content: b64utf8(content),
        branch: 'main'
      })
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error(`GitHub API ${res.status}: ${t}`);
    }
    status('Hotovo! Soubor ulo≈æen do /songs. Za chv√≠li se aktualizuje seznam (GitHub Action).', true);
  }catch(e){
    console.error(e);
    status('Chyba: '+ e.message);
  }
};
</script>
  <script>
/* ---------- ChordPro render (stejn√Ω jako v song.html) ---------- */
const NOTES_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const ALT = {'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
function normRoot(r){ return ALT[r] || r; }
function splitChord(ch){ const m = ch.match(/^([A-G](?:#|b)?)(.*)$/); return m ? {root: normRoot(m[1]), rest:m[2]} : {root:ch, rest:''}; }
function transposeChord(ch, semi){
  const s = splitChord(ch); const i = NOTES_SHARP.indexOf(s.root); if(i===-1) return ch;
  const j = (i + semi + 120) % 12; return NOTES_SHARP[j] + s.rest;
}
function parseChordPro(text){
  const meta = {}; const lines = text.replace(/\r/g,'').split('\n'); const blocks = [];
  for (const line of lines){
    const m = line.match(/^\{(\w+)\s*:\s*(.*?)\s*\}$/);
    if (m) { meta[m[1].toLowerCase()] = m[2]; continue; }
    blocks.push(line);
  }
  return { meta, lines: blocks };
}
function renderChordPro(text, transposeSemi=0, capo=0){
  const { meta, lines } = parseChordPro(text);
  const rootTrans = transposeSemi - (capo|0);
  const cont = document.createElement('div'); cont.className = 'cp';
  for (const raw of lines){
    if (!raw.trim()) { cont.appendChild(document.createElement('br')); continue; }
    const line = document.createElement('div'); line.className = 'line';
    let i = 0, curChord = '';
    while (i < raw.length){
      if (raw[i] === '['){
        const j = raw.indexOf(']', i+1);
        if (j !== -1){ curChord = raw.slice(i+1, j); i = j+1; continue; }
      }
      let j = i; while (j < raw.length && raw[j] !== '[') j++;
      const lyr = raw.slice(i, j) || ' ';
      const seg = document.createElement('span'); seg.className='seg';
      const ch = document.createElement('span'); ch.className='ch';
      ch.textContent = curChord ? transposeChord(curChord, rootTrans) : '';
      const ly = document.createElement('span'); ly.className='ly'; ly.textContent = lyr;
      seg.appendChild(ch); seg.appendChild(ly);
      line.appendChild(seg); i = j;
    }
    cont.appendChild(line);
  }
  return cont;
}

/* ---------- Fullscreen n√°hled ---------- */
const overlay = document.getElementById('overlay');
const overlayView = document.getElementById('overlayView');
const fsVal = document.getElementById('fsVal');
let fontSize = Number(localStorage.getItem('cp_fs') || 22); // poƒç√°teƒçn√≠ bod p√≠sma v px

function applyFontSize(){
  overlay.style.setProperty('--fs', fontSize + 'px');
  fsVal.textContent = fontSize;
  localStorage.setItem('cp_fs', String(fontSize));
}

document.getElementById('previewBtn').onclick = ()=>{
  // vyrenderuj z textarea
  overlayView.innerHTML = '';
  overlayView.appendChild(renderChordPro(document.getElementById('body').value || ''));
  overlay.classList.add('open');
  applyFontSize();
  // nepovinn√©: rovnou po≈æ√°dat o fullscreen? nech√°me na tlaƒç√≠tku
};

document.getElementById('closeOverlay').onclick = ()=>{
  overlay.classList.remove('open');
  if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
};

document.getElementById('fsToggle').onclick = async ()=>{
  if (!document.fullscreenElement) {
    try { await overlay.requestFullscreen(); } catch(e){}
  } else {
    try { await document.exitFullscreen(); } catch(e){}
  }
};

document.getElementById('fsUp').onclick = ()=>{ fontSize = Math.min(72, fontSize+2); applyFontSize(); };
document.getElementById('fsDown').onclick = ()=>{ fontSize = Math.max(12, fontSize-2); applyFontSize(); };

// ESC zav≈ôe
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && overlay.classList.contains('open')){
    document.getElementById('closeOverlay').click();
  }
});
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' })
        .then(r => console.log('Zpjƒõvn√≠ƒçek SW scope:', r.scope))
        .catch(console.error);
    });
  }
</script>


</body>
</html>
