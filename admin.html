<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spr√°va p√≠sn√≠</title>
  <link rel="stylesheet" href="/zpjevnicek/assets/style.css" />
  <link rel="manifest" href="/zpjevnicek/manifest.webmanifest" />
  <meta name="theme-color" content="#0f1729" />
  <link rel="apple-touch-icon" href="/zpjevnicek/assets/icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Zpjƒõvn√≠ƒçek" />
  <style>
    .grid{display:grid;gap:10px}
    .two{grid-template-columns:1fr 1fr}
    .full{grid-column:1 / -1;}           /* polo≈æka p≈ôes celou ≈°√≠≈ôku gridu */

    /* --- editor s podkladem pro zv√Ωraznƒõn√≠ dlouh√Ωch ≈ô√°dk≈Ø --- */
    .editor{ position:relative; }
    .editor textarea{
      width:100%;
      min-height:520px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      line-height:1.6;
      background:transparent;           /* a≈• prosv√≠t√° podklad */
      position:relative;
      z-index:1;
      white-space:pre-wrap;             /* stejn√© zalamov√°n√≠ jako podklad */
      overflow-wrap:break-word;
    }
    .marks{
      position:absolute; inset:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      line-height:1.6;
      white-space:pre-wrap;
      overflow-wrap:break-word;
      color:transparent;                /* text neukazujeme, jen pozad√≠ ≈ô√°dk≈Ø */
      pointer-events:none;              /* aby ≈°el editovat textarea */
      z-index:0;
      /* sjednot√≠me padding s textarea (pokud m√°≈° v /assets/style.css jin√©, slaƒè tam i tady) */
      padding: 8px;
    }
    .marks .row{ display:block; }
    .marks .over{ background: rgba(220, 38, 38, .16); } /* jemn√° ƒçerven√° */
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1 style="margin:0">P≈ôidat p√≠se≈à (ChordPro)</h1><a href="index.html">‚Üê Zpƒõt</a></div>

    <div class="card">
      <p>
        Vlo≈æ <b>text s akordy (ChordPro)</b> ‚Äì nap≈ô. <code>[Am]Alas my love...</code> ‚Äì dopl≈à n√°zev a autora
        a klikni <b>Ulo≈æit do GitHubu</b>. Soubor se ulo≈æ√≠ do slo≈æky <code>/songs</code> a GitHub Action
        automaticky aktualizuje seznam.
      </p>
      <p class="note">Token (PAT) se ukl√°d√° jen do tv√©ho prohl√≠≈æeƒçe (<span class="kbd">localStorage</span>).
         Nepat≈ô√≠ do k√≥du ani do repozit√°≈ôe.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="grid two">
        <label>Token (PAT)
          <input id="token" placeholder="ghp_‚Ä¶ nebo github_pat_‚Ä¶" />
          <div class="note">Scopes: <code>Repository contents ‚Üí Read and write</code> pro vybran√Ω repozit√°≈ô.</div>
        </label>
        <div>
          <button id="saveToken">Ulo≈æit token do prohl√≠≈æeƒçe</button>
          <button id="clearToken">Smazat token</button>
        </div>
      </div>
      <hr class="sep"/>
      <div class="grid two">
        <label>N√°zev p√≠snƒõ
          <input id="title" placeholder="Greensleeves" />
        </label>
        <label>Autor
          <input id="artist" placeholder="Traditional" />
        </label>
      </div>
      <div class="grid two">
        <label>ƒå√≠slo (voliteln√© pro ≈ôazen√≠)
          <input id="number" type="number" min="1" step="1" placeholder="1" />
        </label>
        <label>Tonina (volitelnƒõ ‚Äì meta)
          <input id="key" placeholder="Am" />
        </label>
        <label>Form√°t vstupu
          <select id="fmt">
            <option value="auto" selected>Auto</option>
            <option value="chordpro">ChordPro</option>
            <option value="ug">Ultimate Guitar</option>
          </select>
        </label>
      </div>

      <label class="full">Text (ChordPro)
        <!-- ‚ñº OBALEM TEXTAREA A PODKLAD PRO HIGHLIGHT ‚ñº -->
        <div class="editor">
          <pre id="marks" class="marks" aria-hidden="true"></pre>
          <textarea id="body" placeholder="[Am]Alas my love‚Ä¶"></textarea>
        </div>
      </label>

      <div class="grid two">
        <label>N√°zev souboru (automaticky)
          <input id="filename" readonly />
          <div class="note">Ulo≈æ√≠ se do <code>/songs</code> jako <code>NNN-nazev-autor.pro</code>.</div>
        </label>
        <div style="display:flex;gap:8px;align-items:end;justify-content:flex-end">
          <button id="saveBtn">üíæ Ulo≈æit do GitHubu</button>
        </div>
      </div>
      <div id="status" class="note" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Jak z√≠skat token</h3>
      <ol>
        <li>GitHub ‚Üí <b>Settings</b> (profil) ‚Üí <b>Developer settings</b> ‚Üí <b>Fine-grained tokens</b>.</li>
        <li>Vyber jen tento repozit√°≈ô, dej opr√°vnƒõn√≠ <b>Repository contents: Read and write</b>, vygeneruj.</li>
        <li>Token vlo≈æ do pole v√Ω≈°e a ulo≈æ.</li>
      </ol>
    </div>
  </div>

  <script>
  const qs = s=>document.querySelector(s);
  const statusEl = qs('#status');
  const titleEl = qs('#title');
  const artistEl = qs('#artist');
  const numberEl = qs('#number');
  const keyEl = qs('#key');
  const bodyEl = qs('#body');
  const filenameEl = qs('#filename');
  const marksEl = qs('#marks');

  const ROW_LIMIT = 30; // limit znak≈Ø na ≈ô√°dku bez akord≈Ø [..]

  function slug(s){ return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
  function b64utf8(str){ return btoa(unescape(encodeURIComponent(str))); }
  function status(msg, ok=false){ statusEl.textContent = msg; statusEl.className = 'note' + (ok?' ok':''); }

  function computeFilename(){
    const n = numberEl.value ? String(numberEl.value).padStart(3,'0')+'-' : '';
    const t = slug(titleEl.value||'pisen');
    const a = slug(artistEl.value||'');
    filenameEl.value = `${n}${t}${a?'-'+a:''}.pro`;
  }
  ['input','change'].forEach(ev=>{
    titleEl.addEventListener(ev, computeFilename);
    artistEl.addEventListener(ev, computeFilename);
    numberEl.addEventListener(ev, computeFilename);
  });
  computeFilename();

  // token storage
  const tokenEl = qs('#token');
  const saved = localStorage.getItem('gh_pat');
  if(saved) tokenEl.value = saved;
  qs('#saveToken').onclick = ()=>{ localStorage.setItem('gh_pat', tokenEl.value.trim()); status('Token ulo≈æen.', true); };
  qs('#clearToken').onclick = ()=>{ localStorage.removeItem('gh_pat'); tokenEl.value=''; status('Token smaz√°n.', true); };

  function detectRepo(){
    const host = location.host;                 // user.github.io
    const parts = location.pathname.split('/').filter(Boolean);
    const repo = parts.length? parts[0] : '';
    const user = host.includes('github.io') ? host.split('.')[0] : '';
    return {user, repo};
  }

  // ---------- Highlight ≈ô√°dk≈Ø del≈°√≠ch ne≈æ ROW_LIMIT (bez akord≈Ø) ----------
  const CHORD_BRACKETS_RE = /\[[^\]]*]/g; // [cokoli do nejbli≈æ≈°√≠ho ]
  function escapeHtml(s){ return s.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function rebuildMarks(){
    const text = bodyEl.value.replace(/\r/g,'');
    const lines = text.split('\n');

    // Sestav√≠me <pre> obsah po ≈ô√°dc√≠ch
    const html = lines.map(line=>{
      const visible = line.replace(CHORD_BRACKETS_RE, ''); // bez akord≈Ø
      const over = visible.length > ROW_LIMIT;
      const content = line.length ? escapeHtml(line) : '&nbsp;'; // dr≈æ√≠ v√Ω≈°ku i pro pr√°zdn√©
      return `<span class="row${over ? ' over':''}">${content}</span>`;
    }).join('\n');

    marksEl.innerHTML = html;
    // slad√≠me rozmƒõry a padding s textarea (kdyby se li≈°ily)
    const cs = getComputedStyle(bodyEl);
    marksEl.style.padding = cs.padding;
    marksEl.style.fontSize = cs.fontSize;
    marksEl.style.lineHeight = cs.lineHeight;
  }

  // Sync scroll (textarea ‚Üí podklad)
  bodyEl.addEventListener('scroll', ()=>{
    marksEl.scrollTop = bodyEl.scrollTop;
    marksEl.scrollLeft = bodyEl.scrollLeft;
  });

  // Rebuild p≈ôi psan√≠, vkl√°d√°n√≠, zmƒõnƒõ
  ['input','change','keyup'].forEach(ev => bodyEl.addEventListener(ev, rebuildMarks));
  // Po naƒçten√≠
  rebuildMarks();

  // --- detekce "chord" tokenu ---
  const CHORD_RE =
    /^(?:[A-H](?:#|b)?)(?:(?:maj|min|dim|aug|sus[24]?|add\d+|m|mi|moll|dur)(?:\d+)?)?(?:\d+)?(?:\/[A-H](?:#|b)?)?$/i;

  function isChordishToken(tok) {
    if (!tok) return false;
    if (CHORD_RE.test(tok)) return true;
    if (/^[A-H]$/i.test(tok)) return true;        // osamocen√© p√≠smeno
    if (/^\d{1,2}$/.test(tok)) return true;       // samotn√© ƒç√≠slo (poƒç√≠t√°n√≠ dob)
    if (/^(N\.C\.|NC|x)$/i.test(tok)) return true;
    return false;
  }
  function looksLikeTab(line) {
    const t = line.trim();
    if (/^[eBGDAE]\|[-x\ds\s|]+$/.test(t)) return true;
    if (/-{3,}/.test(t)) return true;
    return false;
  }
  function isChordLine(line) {
    if (!line || !line.trim()) return false;
    if (looksLikeTab(line)) return false;

    const hasLongSpaces = / {2,}/.test(line);
    const rawParts = line.trim().split(/\s+/);

    let chordy = 0, ostatni = 0, totalLen = 0;
    for (const p of rawParts) {
      const clean = p.replace(/[|()¬∑‚Ä¢.\u00B7]+/g, '').replace(/^-+|-+$/g, '');
      if (!clean) continue;
      totalLen += clean.length;
      if (isChordishToken(clean)) chordy++;
      else ostatni++;
    }
    if (chordy === 0) return false;

    const ratioOK = (ostatni === 0) || (chordy / (chordy + ostatni) >= 0.8);
    const avgLen = totalLen / Math.max(1, (chordy + ostatni));

    return ratioOK && (hasLongSpaces || avgLen <= 3);
  }

  // --- UG ‚Üí ChordPro p≈ôevod (beze zmƒõn) ---
  function mergeChordAndLyrics(chordsLine, lyricLine){
    const pos = [];
    let i = 0;
    while (i < chordsLine.length){
      while (i < chordsLine.length && chordsLine[i] === ' ') i++;
      if (i >= chordsLine.length) break;
      const start = i;
      while (i < chordsLine.length && chordsLine[i] !== ' ') i++;
      const token = chordsLine.slice(start, i).replace(/[|()\-¬∑‚Ä¢.]+/g, '');
      if (CHORD_RE.test(token)) pos.push({col:start, chord:token});
    }
    if (!pos.length) return lyricLine;

    let out = lyricLine;
    pos.sort((a,b)=>b.col-a.col).forEach(p=>{
      const idx = Math.min(Math.max(p.col, 0), out.length);
      out = out.slice(0, idx) + `[${p.chord}]` + out.slice(idx);
    });
    return out;
  }
  function ugToChordPro(text){
    let t = text.replace(/\r/g,'');
    t = t.replace(/\[ch\]\s*([^\[]+?)\s*\[\/ch\]/gi, (_m, g1) => `[${g1.trim()}]`);

    const lines = t.split('\n');
    const out = [];
    for (let i = 0; i < lines.length; i++){
      const L = lines[i];
      const sec = L.match(/^\s*(?:\[(verse|chorus|bridge|intro|outro|solo)\]|\((verse|chorus|bridge|intro|outro|solo)\))\s*$/i);
      if (sec) { out.push(`{comment: ${ (sec[1]||sec[2]).toLowerCase() }}`); continue; }

      if (isChordLine(L) && i+1 < lines.length){
        out.push( mergeChordAndLyrics(L, lines[i+1] || '') );
        i++;
        continue;
      }
      out.push(L);
    }

    const compact = [];
    let prevEmpty = false;
    for (const r of out){
      const empty = !r.trim();
      if (empty && prevEmpty) continue;
      compact.push(r);
      prevEmpty = empty;
    }
    return compact.join('\n');
  }

  qs('#saveBtn').onclick = async () => {
    try {
      const { user, repo } = detectRepo();
      if (!user || !repo) return status('Nepoda≈ôilo se odvodit user/repo z URL. Ulo≈æ soubor ruƒçnƒõ p≈ôes GitHub UI.', false);

      const token = tokenEl.value.trim();
      if (!token) return status('Vlo≈æ pros√≠m PAT token.', false);
      if (!titleEl.value.trim()) return status('Dopl≈à n√°zev p√≠snƒõ.', false);

      // 2.3: p≈ô√≠padn√Ω p≈ôevod UG -> ChordPro
      let body = bodyEl.value.replace(/\r/g, '');
      const fmtSel = (document.getElementById('fmt')?.value) || 'auto';
      const looksUG = /\[ch\]/i.test(body) || body.split('\n').some(isChordLine);
      if (fmtSel === 'ug' || (fmtSel === 'auto' && looksUG)) {
        body = ugToChordPro(body);
      }

      // ChordPro + metadata
      const lines = [];
      lines.push(`{title: ${titleEl.value.trim()}}`);
      if (artistEl.value.trim()) lines.push(`{artist: ${artistEl.value.trim()}}`);
      if (keyEl.value.trim())    lines.push(`{key: ${keyEl.value.trim()}}`);
      lines.push('');
      lines.push(body);
      const content = lines.join('\n');

      const filename = filenameEl.value || 'pisen.pro';
      const path = `songs/${filename}`;

      status('Ukl√°d√°m‚Ä¶');
      const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github+json'
        },
        body: JSON.stringify({
          message: `feat(song): add ${titleEl.value.trim()}`,
          content: b64utf8(content),
          branch: 'main'
        })
      });

      if (!res.ok) {
        const t = await res.text();
        throw new Error(`GitHub API ${res.status}: ${t}`);
      }
      status('Hotovo! Soubor ulo≈æen do /songs. Za chv√≠li se aktualizuje seznam (GitHub Action).', true);
    } catch (e) {
      console.error(e);
      status('Chyba: ' + e.message);
    }
  };
  </script>

  <!-- Service Worker registrace ponech√°na -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/zpjevnicek/sw.js', { scope: '/zpjevnicek/' })
          .then(r => console.log('Zpjƒõvn√≠ƒçek SW scope:', r.scope))
          .catch(console.error);
      });
    }
  </script>
</body>
</html>
