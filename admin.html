<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spr√°va p√≠sn√≠</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .grid{display:grid;gap:10px}
.two{grid-template-columns:1fr 1fr}
.full{grid-column:1 / -1;}           /* polo≈æka p≈ôes celou ≈°√≠≈ôku gridu */
textarea{
  width:100%;                        /* rozt√°hne na celou ≈°√≠≈ôku */
  min-height:520px;                  /* bylo ~320px ‚Üí +~50 % */
  resize:vertical;                   /* povolit ruƒçn√≠ zvƒõt≈°en√≠ v√Ω≈°ky */
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace; /* a≈• sed√≠ akordy */
  line-height:1.6;
}
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1 style="margin:0">P≈ôidat p√≠se≈à (ChordPro)</h1><a href="index.html">‚Üê Zpƒõt</a></div>

    <div class="card">
      <p>
        Vlo≈æ <b>text s akordy (ChordPro)</b> ‚Äì nap≈ô. <code>[Am]Alas my love...</code> ‚Äì dopl≈à n√°zev a autora
        a klikni <b>Ulo≈æit do GitHubu</b>. Soubor se ulo≈æ√≠ do slo≈æky <code>/songs</code> a GitHub Action
        automaticky aktualizuje seznam.
      </p>
      <p class="note">Token (PAT) se ukl√°d√° jen do tv√©ho prohl√≠≈æeƒçe (<span class="kbd">localStorage</span>).
         Nepat≈ô√≠ do k√≥du ani do repozit√°≈ôe.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="grid two">
        <label>Token (PAT)
          <input id="token" placeholder="ghp_‚Ä¶ nebo github_pat_‚Ä¶" />
          <div class="note">Scopes: <code>Repository contents ‚Üí Read and write</code> pro vybran√Ω repozit√°≈ô.</div>
        </label>
        <div>
          <button id="saveToken">Ulo≈æit token do prohl√≠≈æeƒçe</button>
          <button id="clearToken">Smazat token</button>
        </div>
      </div>
      <hr class="sep"/>
      <div class="grid two">
        <label>N√°zev p√≠snƒõ
          <input id="title" placeholder="Greensleeves" />
        </label>
        <label>Autor
          <input id="artist" placeholder="Traditional" />
        </label>
      </div>
      <div class="grid two">
        <label>ƒå√≠slo (voliteln√© pro ≈ôazen√≠)
          <input id="number" type="number" min="1" step="1" placeholder="1" />
        </label>
        <label>Tonina (volitelnƒõ ‚Äì meta)
          <input id="key" placeholder="Am" />
        </label>
      </div>
      <label class="full">Text (ChordPro)
  <textarea id="body" placeholder="[Am]Alas my love‚Ä¶"></textarea>
</label>
      <div class="grid two">
        <label>N√°zev souboru (automaticky)
          <input id="filename" readonly />
          <div class="note">Ulo≈æ√≠ se do <code>/songs</code> jako <code>NNN-nazev-autor.pro</code>.</div>
        </label>
        <div style="display:flex;gap:8px;align-items:end;justify-content:flex-end">
          <button id="saveBtn">üíæ Ulo≈æit do GitHubu</button>
        </div>
      </div>
      <div id="status" class="note" style="margin-top:8px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Jak z√≠skat token</h3>
      <ol>
        <li>GitHub ‚Üí <b>Settings</b> (profil) ‚Üí <b>Developer settings</b> ‚Üí <b>Fine-grained tokens</b>.</li>
        <li>Vyber jen tento repozit√°≈ô, dej opr√°vnƒõn√≠ <b>Repository contents: Read and write</b>, vygeneruj.</li>
        <li>Token vlo≈æ do pole v√Ω≈°e a ulo≈æ.</li>
      </ol>
    </div>
  </div>

<script>
const qs = s=>document.querySelector(s);
const statusEl = qs('#status');
const titleEl = qs('#title');
const artistEl = qs('#artist');
const numberEl = qs('#number');
const keyEl = qs('#key');
const bodyEl = qs('#body');
const filenameEl = qs('#filename');

function slug(s){ return (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function b64utf8(str){ return btoa(unescape(encodeURIComponent(str))); }
function status(msg, ok=false){ statusEl.textContent = msg; statusEl.className = 'note' + (ok?' ok':''); }

function computeFilename(){
  const n = numberEl.value ? String(numberEl.value).padStart(3,'0')+'-' : '';
  const t = slug(titleEl.value||'pisen');
  const a = slug(artistEl.value||'');
  filenameEl.value = `${n}${t}${a?'-'+a:''}.pro`;
}
['input','change'].forEach(ev=>{
  titleEl.addEventListener(ev, computeFilename);
  artistEl.addEventListener(ev, computeFilename);
  numberEl.addEventListener(ev, computeFilename);
});
computeFilename();

// token storage
const tokenEl = qs('#token');
const saved = localStorage.getItem('gh_pat');
if(saved) tokenEl.value = saved;
qs('#saveToken').onclick = ()=>{ localStorage.setItem('gh_pat', tokenEl.value.trim()); status('Token ulo≈æen.', true); };
qs('#clearToken').onclick = ()=>{ localStorage.removeItem('gh_pat'); tokenEl.value=''; status('Token smaz√°n.', true); };

function detectRepo(){
  const host = location.host;                 // user.github.io
  const parts = location.pathname.split('/').filter(Boolean);
  const repo = parts.length? parts[0] : '';
  const user = host.includes('github.io') ? host.split('.')[0] : '';
  return {user, repo};
}

qs('#saveBtn').onclick = async ()=>{
  try{
    const {user, repo} = detectRepo();
    if(!user || !repo) return status('Nepoda≈ôilo se odvodit user/repo z URL. Ulo≈æ soubor ruƒçnƒõ p≈ôes GitHub UI.', false);
    const token = tokenEl.value.trim();
    if(!token) return status('Vlo≈æ pros√≠m PAT token.', false);
    if(!titleEl.value.trim()) return status('Dopl≈à n√°zev p√≠snƒõ.', false);

    // ChordPro obsah s metadaty
    const lines = [];
    lines.push(`{title: ${titleEl.value.trim()}}`);
    if(artistEl.value.trim()) lines.push(`{artist: ${artistEl.value.trim()}}`);
    if(keyEl.value.trim()) lines.push(`{key: ${keyEl.value.trim()}}`);
    lines.push('');
    lines.push(bodyEl.value.replace(/\r/g,''));
    const content = lines.join('\n');

    const filename = filenameEl.value || 'pisen.pro';
    const path = `songs/${filename}`;

    status('Ukl√°d√°m‚Ä¶');
    const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}` ,{
      method:'PUT',
      headers:{
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github+json'
      },
      body: JSON.stringify({
        message: `feat(song): add ${titleEl.value.trim()}`,
        content: b64utf8(content),
        branch: 'main'
      })
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error(`GitHub API ${res.status}: ${t}`);
    }
    status('Hotovo! Soubor ulo≈æen do /songs. Za chv√≠li se aktualizuje seznam (GitHub Action).', true);
  }catch(e){
    console.error(e);
    status('Chyba: '+ e.message);
  }
};
</script>
</body>
</html>
